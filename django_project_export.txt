
================================================================================
FILE: export_all_models_to_txt.py
================================================================================

import os

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
OUTPUT_FILE = os.path.join(BASE_DIR, "ALL_DJANGO_MODELS.txt")

EXCLUDE_DIRS = {"venv", "env", ".venv", "__pycache__", "migrations"}

def export_models_to_txt(base_dir):
    with open(OUTPUT_FILE, "w", encoding="utf-8") as output:
        output.write("DJANGO MODELS EXPORT\n")
        output.write("=" * 80 + "\n\n")

        for root, dirs, files in os.walk(base_dir):
            # Skip unwanted directories
            dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]

            if "models.py" in files:
                model_path = os.path.join(root, "models.py")
                app_name = os.path.basename(root)

                output.write(f"\n\nAPP: {app_name}\n")
                output.write("-" * 80 + "\n")
                output.write(f"FILE: {model_path}\n")
                output.write("-" * 80 + "\n\n")

                with open(model_path, "r", encoding="utf-8") as model_file:
                    output.write(model_file.read())

    print(f"✅ All models.py exported to {OUTPUT_FILE}")


if __name__ == "__main__":
    export_models_to_txt(BASE_DIR)

================================================================================
FILE: manage.py
================================================================================

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main() -> None:
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'peds_edu.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

================================================================================
FILE: export_django_files.py
================================================================================

import os

# Extensions to include
ALLOWED_EXTENSIONS = {".py", ".html", ".css", ".js"}

# Directories to ignore
EXCLUDED_DIRS = {
    "venv",
    ".git",
    "__pycache__",
    "node_modules",
    "migrations",
    ".vscode"
}

OUTPUT_FILE = "django_project_export.txt"


def should_include_file(filename):
    return os.path.splitext(filename)[1] in ALLOWED_EXTENSIONS


def export_files(root_dir):
    with open(OUTPUT_FILE, "w", encoding="utf-8") as output:
        for root, dirs, files in os.walk(root_dir):
            # Remove excluded directories from traversal
            dirs[:] = [d for d in dirs if d not in EXCLUDED_DIRS]

            for file in files:
                if should_include_file(file):
                    file_path = os.path.join(root, file)
                    relative_path = os.path.relpath(file_path, root_dir)

                    output.write(f"\n{'=' * 80}\n")
                    output.write(f"FILE: {relative_path}\n")
                    output.write(f"{'=' * 80}\n\n")

                    try:
                        with open(file_path, "r", encoding="utf-8") as f:
                            output.write(f.read())
                    except Exception as e:
                        output.write(f"[Could not read file: {e}]\n")


if __name__ == "__main__":
    project_root = os.getcwd()  # Run from project root
    export_files(project_root)
    print(f"Export complete! Files saved to '{OUTPUT_FILE}'")

================================================================================
FILE: sharing/services.py
================================================================================

from __future__ import annotations

from collections import defaultdict
from typing import Any, Dict, List

from django.conf import settings
from django.core.cache import cache

from catalog.constants import LANGUAGES
from catalog.models import (
    TherapyArea,
    Trigger,
    TriggerCluster,
    Video,
    VideoLanguage,
    VideoCluster,
    VideoClusterLanguage,
    VideoClusterVideo,
)

_CATALOG_CACHE_KEY = "clinic_catalog_payload_v7"
_CATALOG_CACHE_SECONDS = 60 * 60  # 1 hour


def build_whatsapp_message_prefixes(doctor_name: str) -> Dict[str, str]:
    """
    Prefix only. The final WhatsApp message is built in the front-end as:
      <prefix>\n\n<title>\n<link>

    NOTE: doctor_name is injected per-request in sharing.views.doctor_share.
    """
    doctor = (doctor_name or "").strip() or "your doctor"

    templates = {
        "en": (
            "Your doctor {doctor} has sent you the following video/videos. "
            "It is very important that you view them and follow the instructions, "
            "as these are for important observations by your doctor. "
            "Your child's health and wellbeing depend upon following the instructions in the videos."
        ),
        "hi": (
            "आपके डॉक्टर {doctor} ने आपको निम्न वीडियो/वीडियो भेजे हैं। "
            "कृपया इन्हें ध्यान से देखें और वीडियो में दिए गए निर्देशों का पालन करें, "
            "क्योंकि ये आपके डॉक्टर के महत्वपूर्ण निरीक्षणों के लिए हैं। "
            "आपके बच्चे का स्वास्थ्य और भलाई इन वीडियो में दिए गए निर्देशों का पालन करने पर निर्भर है।"
        ),
        "mr": (
            "तुमचे डॉक्टर {doctor} यांनी तुम्हाला खालील व्हिडिओ/व्हिडिओ पाठवले आहेत. "
            "कृपया ते काळजीपूर्वक पहा आणि व्हिडिओमध्ये दिलेल्या सूचनांचे पालन करा, "
            "कारण हे तुमच्या डॉक्टरांच्या महत्त्वाच्या निरीक्षणांसाठी आहेत. "
            "तुमच्या मुलाचे आरोग्य आणि कल्याण व्हिडिओमधील सूचनांचे पालन करण्यावर अवलंबून आहे."
        ),
        "te": (
            "మీ డాక్టర్ {doctor} మీకు క్రింది వీడియో/వీడియోలను పంపించారు. "
            "దయచేసి వాటిని జాగ్రత్తగా చూడండి మరియు వీడియోలో ఇచ్చిన సూచనలను అనుసరించండి, "
            "ఎందుకంటే ఇవి మీ డాక్టర్ యొక్క ముఖ్యమైన పరిశీలనల కోసం. "
            "మీ పిల్లల ఆరోగ్యం మరియు శ్రేయస్సు వీడియోల్లో ఉన్న సూచనలను అనుసరించడంపై ఆధారపడి ఉంటుంది."
        ),
        "ta": (
            "உங்கள் மருத்துவர் {doctor} உங்களுக்கு கீழ்க்கண்ட வீடியோ/வீடியோக்களை அனுப்பியுள்ளார். "
            "தயவுசெய்து அவற்றை கவனமாகப் பார்த்து, வீடியோவில் கொடுக்கப்பட்ட வழிமுறைகளைப் பின்பற்றுங்கள், "
            "ஏனெனில் இவை உங்கள் மருத்துவரின் முக்கியமான கண்காணிப்புகளுக்கானவை. "
            "உங்கள் குழந்தையின் ஆரோக்கியமும் நலனும் இந்த வீடியோக்களில் உள்ள வழிமுறைகளைப் பின்பற்றுவதில் சார்ந்துள்ளது."
        ),
        "bn": (
            "আপনার ডাক্তার {doctor} আপনাকে নিম্নলিখিত ভিডিও/ভিডিওগুলো পাঠিয়েছেন। "
            "অনুগ্রহ করে সেগুলো মনোযোগ দিয়ে দেখুন এবং ভিডিওতে দেওয়া নির্দেশনা অনুসরণ করুন, "
            "কারণ এগুলো আপনার ডাক্তারের গুরুত্বপূর্ণ পর্যবেক্ষণের জন্য। "
            "আপনার সন্তানের স্বাস্থ্য ও কল্যাণ ভিডিওতে দেওয়া নির্দেশনা অনুসরণ করার উপর নির্ভর করে।"
        ),
        "ml": (
            "നിങ്ങളുടെ ഡോക്ടർ {doctor} നിങ്ങള്‍ക്കായി താഴെ പറയുന്ന വീഡിയോ/വീഡിയോകള്‍ അയച്ചിട്ടുണ്ട്. "
            "ദയവായി അവ ശ്രദ്ധാപൂർവ്വം കാണുകയും വീഡിയോയിലെ നിർദ്ദേശങ്ങൾ പാലിക്കുകയും ചെയ്യുക, "
            "കാരണം ഇവ നിങ്ങളുടെ ഡോക്ടറുടെ പ്രധാനപ്പെട്ട നിരീക്ഷണങ്ങൾക്കായാണ്. "
            "നിങ്ങളുടെ കുട്ടിയുടെ ആരോഗ്യവും ക്ഷേമവും വീഡിയോയിലെ നിർദ്ദേശങ്ങൾ പാലിക്കുന്നതിനെ ആശ്രയിച്ചിരിക്കുന്നു."
        ),
        "kn": (
            "ನಿಮ್ಮ ವೈದ್ಯರು {doctor} ಅವರು ನಿಮಗೆ ಕೆಳಗಿನ ವೀಡಿಯೊ/ವೀಡಿಯೊಗಳನ್ನು ಕಳುಹಿಸಿದ್ದಾರೆ. "
            "ದಯವಿಟ್ಟು ಅವನ್ನು ಗಮನದಿಂದ ನೋಡಿ ಹಾಗೂ ವೀಡಿಯೊಗಳಲ್ಲಿ ನೀಡಿರುವ ಸೂಚನೆಗಳನ್ನು ಅನುಸರಿಸಿ, "
            "ಏಕೆಂದರೆ ಇವು ನಿಮ್ಮ ವೈದ್ಯರ ಮಹತ್ವದ ಗಮನಿಸಿಕೆಗಳಿಗಾಗಿ. "
            "ನಿಮ್ಮ ಮಗುವಿನ ಆರೋಗ್ಯ ಮತ್ತು ಕಲ್ಯಾಣವು ವೀಡಿಯೊಗಳ ಸೂಚನೆಗಳನ್ನು ಪಾಲಿಸುವುದರ ಮೇಲೆ ಅವಲಂಬಿತವಾಗಿದೆ."
        ),
    }

    out: Dict[str, str] = {}
    for code, _label in LANGUAGES:
        tmpl = templates.get(code, templates["en"])
        out[code] = tmpl.format(doctor=doctor)
    return out


def _build_catalog_payload() -> Dict[str, Any]:
    """
    Catalog payload for the doctor's video sharing UI.

    Design goals:
    - Trigger (not Topic) based browsing.
    - Bundles list includes its videos so the UI can render grouped results.
    - Default ordering is alphabetical (no reliance on sort_order for UI).
    """

    # -----------------------------------------------------------------
    # Therapy Areas
    # -----------------------------------------------------------------
    therapy_areas = list(TherapyArea.objects.filter(is_active=True).order_by("display_name", "code"))
    therapy_payload = [
        {"code": ta.code, "display_name": ta.display_name, "description": ta.description}
        for ta in therapy_areas
    ]
    therapy_by_id = {ta.id: ta for ta in therapy_areas}

    # -----------------------------------------------------------------
    # Triggers
    # -----------------------------------------------------------------
    triggers = list(
        Trigger.objects.filter(is_active=True)
        .select_related("primary_therapy", "cluster")
        .order_by("display_name", "code")
    )
    triggers_payload = []
    for tr in triggers:
        triggers_payload.append(
            {
                "code": tr.code,
                "display_name": tr.display_name,
                "therapy_code": tr.primary_therapy.code if getattr(tr, "primary_therapy_id", None) and tr.primary_therapy else "",
                "cluster_code": tr.cluster.code if getattr(tr, "cluster_id", None) and tr.cluster else "",
                "doctor_trigger_label": tr.doctor_trigger_label or "",
            }
        )

    # -----------------------------------------------------------------
    # Trigger Clusters (kept for backwards compatibility; UI no longer uses it)
    # -----------------------------------------------------------------
    topics = list(TriggerCluster.objects.filter(is_active=True).order_by("display_name", "code"))
    topics_payload = [
        {
            "code": tc.code,
            "display_name": tc.display_name,
            "description": tc.description,
            "language_code": tc.language_code,
        }
        for tc in topics
    ]

    # -----------------------------------------------------------------
    # Bundles (VideoClusters) + localized names + included videos
    # -----------------------------------------------------------------
    bundles = list(
        VideoCluster.objects.filter(is_active=True)
        .select_related("trigger", "trigger__primary_therapy", "trigger__cluster")
        .order_by("display_name", "code")
    )

    bundle_names_by_code: Dict[str, Dict[str, str]] = defaultdict(dict)
    for row in (
        VideoClusterLanguage.objects.filter(video_cluster__in=bundles)
        .select_related("video_cluster")
        .all()
    ):
        bundle_names_by_code[row.video_cluster.code][row.language_code] = row.name

    bundle_trigger_code_by_code: Dict[str, str] = {}
    bundle_therapy_code_by_code: Dict[str, str] = {}
    bundle_display_names_by_code: Dict[str, str] = {}

    for b in bundles:
        bundle_display_names_by_code[b.code] = (b.display_name or "").strip() or b.code
        trig = getattr(b, "trigger", None)
        bundle_trigger_code_by_code[b.code] = trig.code if trig else ""
        ta_code = ""
        if trig and getattr(trig, "primary_therapy_id", None) and trig.primary_therapy:
            ta_code = trig.primary_therapy.code
        bundle_therapy_code_by_code[b.code] = ta_code

    # Bundle -> ordered list of video codes
    bundle_video_codes_by_code: Dict[str, List[str]] = defaultdict(list)
    vcv_rows = (
        VideoClusterVideo.objects.filter(video_cluster__in=bundles)
        .select_related("video_cluster", "video")
        .order_by("video_cluster_id", "sort_order", "video__code")
    )
    for row in vcv_rows:
        bundle_video_codes_by_code[row.video_cluster.code].append(row.video.code)

    # Bundle search text (for keyword search on the share page)
    bundle_search_text_by_code: Dict[str, str] = {}
    for b in bundles:
        parts: List[str] = []
        parts.extend(
            [
                b.code,
                (b.display_name or ""),
                (b.description or ""),
                (b.search_keywords or ""),
            ]
        )
        trig = getattr(b, "trigger", None)
        if trig:
            parts.extend(
                [
                    trig.code,
                    (trig.display_name or ""),
                    (trig.doctor_trigger_label or ""),
                    (trig.subtopic_title or ""),
                    (trig.search_keywords or ""),
                ]
            )
            if getattr(trig, "primary_therapy_id", None):
                ta = therapy_by_id.get(trig.primary_therapy_id)
                if ta:
                    parts.extend([ta.code, (ta.display_name or "")])
        for nm in bundle_names_by_code.get(b.code, {}).values():
            parts.append(nm or "")

        bundle_search_text_by_code[b.code] = " ".join(
            sorted(set((p or "").strip().lower() for p in parts if (p or "").strip()))
        )

    bundles_payload = []
    for b in bundles:
        code = b.code
        bundles_payload.append(
            {
                "code": code,
                "display_name": bundle_display_names_by_code.get(code, code),
                "names": bundle_names_by_code.get(code, {}),
                "trigger_code": bundle_trigger_code_by_code.get(code, ""),
                "therapy_code": bundle_therapy_code_by_code.get(code, ""),
                "video_codes": bundle_video_codes_by_code.get(code, []),
                "search_text": bundle_search_text_by_code.get(code, ""),
            }
        )

    # -----------------------------------------------------------------
    # Videos (+ localized titles + URLs + derived trigger/therapy codes from bundles)
    # -----------------------------------------------------------------
    videos = list(Video.objects.filter(is_active=True).order_by("code"))

    vlang_rows = VideoLanguage.objects.filter(video__in=videos).select_related("video")

    titles_by_video_code: Dict[str, Dict[str, str]] = defaultdict(dict)
    url_by_video_code: Dict[str, Dict[str, str]] = defaultdict(dict)

    for row in vlang_rows:
        titles_by_video_code[row.video.code][row.language_code] = row.title
        url_by_video_code[row.video.code][row.language_code] = row.youtube_url

    # Video -> bundle codes
    bundle_map: Dict[str, List[str]] = defaultdict(list)
    for row in vcv_rows:
        bundle_map[row.video.code].append(row.video_cluster.code)

    # Video -> derived trigger/therapy codes based on bundle membership
    trigger_codes_by_video: Dict[str, List[str]] = defaultdict(list)
    therapy_codes_by_video: Dict[str, List[str]] = defaultdict(list)

    for vcode, bcodes in bundle_map.items():
        for bcode in bcodes:
            tr_code = bundle_trigger_code_by_code.get(bcode) or ""
            th_code = bundle_therapy_code_by_code.get(bcode) or ""
            if tr_code:
                trigger_codes_by_video[vcode].append(tr_code)
            if th_code:
                therapy_codes_by_video[vcode].append(th_code)

    videos_payload = []
    for v in videos:
        code = v.code
        titles = dict(titles_by_video_code.get(code, {}))
        if "en" not in titles:
            titles["en"] = code

        display_label = titles.get("en") or code

        search_parts: List[str] = []
        search_parts.append(code)
        search_parts.extend([t.lower() for t in titles.values() if t])
        search_parts.extend(
            [
                (v.description or "").lower(),
                (v.search_keywords or "").lower(),
            ]
        )

        # Bundle-aware search terms
        for bcode in bundle_map.get(code, []):
            search_parts.append(bcode.lower())
            search_parts.append((bundle_display_names_by_code.get(bcode, "") or "").lower())
            for lang_name in bundle_names_by_code.get(bcode, {}).values():
                if lang_name:
                    search_parts.append(lang_name.lower())
            # Trigger / therapy labels via bundle
            tr_code = bundle_trigger_code_by_code.get(bcode) or ""
            th_code = bundle_therapy_code_by_code.get(bcode) or ""
            if tr_code:
                search_parts.append(tr_code.lower())

        videos_payload.append(
            {
                "id": code,
                "display_name": display_label,
                "titles": titles,
                "urls": url_by_video_code.get(code, {}),
                "trigger_codes": sorted(set(trigger_codes_by_video.get(code, []))),
                "therapy_codes": sorted(set(therapy_codes_by_video.get(code, []))),
                "bundle_codes": bundle_map.get(code, []),
                "search_text": " ".join(sorted(set(p for p in search_parts if p))),
            }
        )

    return {
        "therapy_areas": therapy_payload,
        "triggers": triggers_payload,
        "topics": topics_payload,  # legacy
        "bundles": bundles_payload,
        "videos": videos_payload,
        "message_prefixes": build_whatsapp_message_prefixes("your doctor"),
    }


def get_catalog_json_cached(force_refresh: bool = False) -> Dict[str, Any]:
    cache_seconds = getattr(settings, "CATALOG_CACHE_SECONDS", _CATALOG_CACHE_SECONDS)

    if not force_refresh:
        cached = cache.get(_CATALOG_CACHE_KEY)
        if cached:
            return cached

    payload = _build_catalog_payload()
    cache.set(_CATALOG_CACHE_KEY, payload, cache_seconds)
    return payload

================================================================================
FILE: sharing/__init__.py
================================================================================

default_app_config = "sharing.apps.SharingConfig"

================================================================================
FILE: sharing/apps.py
================================================================================

from django.apps import AppConfig


class SharingConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "sharing"

================================================================================
FILE: sharing/context_processors.py
================================================================================

from __future__ import annotations

from typing import Dict


def clinic_branding(request) -> Dict[str, str]:
    """Inject logged-in clinic branding into templates."""

    user = getattr(request, "user", None)
    if not user or not getattr(user, "is_authenticated", False):
        return {}

    doctor = getattr(user, "doctor_profile", None)
    if not doctor:
        return {}

    clinic = doctor.clinic
    return {
        "brand_doctor_name": user.full_name,
        "brand_clinic_name": clinic.display_name or f"Dr. {user.full_name}",
        "brand_clinic_code": clinic.clinic_code,
        "brand_doctor_id": doctor.doctor_id,
        "brand_photo_url": doctor.photo.url if doctor.photo else "",
    }

================================================================================
FILE: sharing/urls.py
================================================================================

from django.urls import path

from . import views

app_name = "sharing"

urlpatterns = [
    path("", views.home, name="home"),
    path("clinic/<str:doctor_id>/share/", views.doctor_share, name="doctor_share"),
    path("p/<str:doctor_id>/v/<str:video_code>/", views.patient_video, name="patient_video"),
    path("p/<str:doctor_id>/c/<str:cluster_code>/", views.patient_cluster, name="patient_cluster"),
]

================================================================================
FILE: sharing/views.py
================================================================================

from __future__ import annotations

import json

from django.contrib.auth.decorators import login_required
from django.http import HttpRequest, HttpResponse, HttpResponseForbidden
from django.shortcuts import get_object_or_404, redirect, render

from accounts.models import DoctorProfile
from catalog.constants import LANGUAGE_CODES, LANGUAGES
from catalog.models import (
    Video,
    VideoLanguage,
    VideoCluster,
    VideoClusterLanguage,
)

from .services import build_whatsapp_message_prefixes, get_catalog_json_cached


def home(request: HttpRequest) -> HttpResponse:
    # Keep a simple redirect to login
    return redirect("accounts:login")


@login_required
def doctor_share(request: HttpRequest, doctor_id: str) -> HttpResponse:
    doctor = getattr(request.user, "doctor_profile", None)
    if not doctor or doctor.doctor_id != doctor_id:
        return HttpResponseForbidden("Not allowed")

    # Force refresh once to avoid stale/empty cache during development.
    catalog_json = get_catalog_json_cached(force_refresh=True)

    # Ensure we are working with a mutable dict
    if isinstance(catalog_json, str):
        try:
            catalog_json = json.loads(catalog_json)
        except Exception:
            catalog_json = {}

    catalog_json = dict(catalog_json or {})

    # Doctor name lives on the related User
    try:
        doctor_name = (doctor.user.full_name or "").strip()
    except Exception:
        doctor_name = (request.user.full_name or "").strip()

    # Inject doctor-specific, non-cached fields
    catalog_json["doctor_id"] = doctor_id
    catalog_json["message_prefixes"] = build_whatsapp_message_prefixes(doctor_name)

    return render(
        request,
        "sharing/share.html",
        {
            "doctor": doctor,
            "clinic": getattr(doctor, "clinic", None),
            "catalog_json": catalog_json,
            "languages": LANGUAGES,
        },
    )


def patient_video(request: HttpRequest, doctor_id: str, video_code: str) -> HttpResponse:
    doctor = get_object_or_404(
        DoctorProfile.objects.select_related("clinic", "user"),
        doctor_id=doctor_id,
    )

    lang = request.GET.get("lang", "en")
    if lang not in LANGUAGE_CODES:
        lang = "en"

    video = get_object_or_404(Video, code=video_code)

    vlang = (
        VideoLanguage.objects.filter(video=video, language_code=lang).first()
        or VideoLanguage.objects.filter(video=video, language_code="en").first()
    )

    return render(
        request,
        "sharing/patient_video.html",
        {
            "doctor": doctor,
            "clinic": doctor.clinic,
            "video": video,
            "vlang": vlang,
            "languages": LANGUAGES,
            "selected_lang": lang,
            "show_auth_links": False,
        },
    )


def patient_cluster(
    request: HttpRequest, doctor_id: str, cluster_code: str
) -> HttpResponse:
    doctor = get_object_or_404(
        DoctorProfile.objects.select_related("clinic", "user"),
        doctor_id=doctor_id,
    )

    lang = request.GET.get("lang", "en")
    if lang not in LANGUAGE_CODES:
        lang = "en"

    cluster = VideoCluster.objects.filter(code=cluster_code).first()
    if cluster is None and cluster_code.isdigit():
        cluster = get_object_or_404(VideoCluster, pk=int(cluster_code))
    elif cluster is None:
        cluster = get_object_or_404(VideoCluster, pk=-1)

    # Cluster title in selected language (with English fallback)
    cl_lang = (
        VideoClusterLanguage.objects.filter(
            video_cluster=cluster, language_code=lang
        ).first()
        or VideoClusterLanguage.objects.filter(
            video_cluster=cluster, language_code="en"
        ).first()
    )
    cluster_title = cl_lang.name if cl_lang else cluster.code

    try:
        videos = cluster.videos.all().order_by("sort_order", "id")
    except Exception:
        videos = cluster.videos.all().order_by("id")

    items = []
    for v in videos:
        vlang = (
            VideoLanguage.objects.filter(video=v, language_code=lang).first()
            or VideoLanguage.objects.filter(video=v, language_code="en").first()
        )

        items.append(
            {
                "video": v,
                "title": (vlang.title if vlang else v.code),
                "url": (vlang.youtube_url if vlang else ""),
            }
        )

    return render(
        request,
        "sharing/patient_cluster.html",
        {
            "doctor": doctor,
            "clinic": doctor.clinic,
            "cluster": cluster,
            "cluster_title": cluster_title,
            "items": items,
            "languages": LANGUAGES,
            "selected_lang": lang,
            "show_auth_links": False,
        },
    )

================================================================================
FILE: publisher/models.py
================================================================================

from __future__ import annotations

from django.db import models


def _banner_small_upload_to(instance: "Campaign", filename: str) -> str:
    return f"campaign_banners/{instance.campaign_id}/small/{filename}"


def _banner_large_upload_to(instance: "Campaign", filename: str) -> str:
    return f"campaign_banners/{instance.campaign_id}/large/{filename}"


class Campaign(models.Model):
    """
    NOTE:
    - This model maps to the manually-created MySQL table `publisher_campaign`.
    - `managed = False` so Django does not attempt to create/alter it via migrations.
    """

    campaign_id = models.CharField(max_length=100, unique=True, db_index=True)
    new_video_cluster_name = models.CharField(max_length=255)

    # JSON string of selections: [{"type":"video","id":1}, {"type":"cluster","id":2}]
    selection_json = models.TextField(blank=False, default="")

    doctors_supported = models.PositiveIntegerField(default=0)

    banner_small = models.FileField(upload_to=_banner_small_upload_to, max_length=500)
    banner_large = models.FileField(upload_to=_banner_large_upload_to, max_length=500)

    banner_target_url = models.URLField(max_length=500)

    start_date = models.DateField()
    end_date = models.DateField()

    # New video-cluster created for this campaign
    video_cluster = models.OneToOneField(
        "catalog.VideoCluster",
        on_delete=models.PROTECT,
        related_name="campaign",
    )

    # Publisher identity from JWT
    publisher_sub = models.CharField(max_length=100, blank=True, default="")
    publisher_username = models.CharField(max_length=150, blank=True, default="")
    publisher_roles = models.CharField(max_length=255, blank=True, default="")
    # Campaign messaging (new fields)
    email_registration = models.TextField(blank=True, default="")
    wa_addition = models.TextField(blank=True, default="")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = "publisher_campaign"
        managed = False

    def __str__(self) -> str:
        return f"{self.campaign_id} ({self.new_video_cluster_name})"

================================================================================
FILE: publisher/campaign_views.py
================================================================================

from __future__ import annotations
import json
from typing import Any, Dict, List, Set
from urllib.parse import urlencode
from django import forms
from django.contrib import messages
from django.db import models, transaction
from django.db.models import Q
from django.http import (
    HttpRequest,
    HttpResponse,
    HttpResponseBadRequest,
    JsonResponse,
)
from django.shortcuts import get_object_or_404, redirect, render
from django.urls import reverse
from django.utils.text import slugify
from django.views.decorators.http import require_GET, require_http_methods, require_POST

from django import forms
from django.conf import settings
from django.http import HttpRequest, HttpResponse
from django.shortcuts import redirect, render
from django.urls import reverse
from django.utils.http import urlencode
from django.views.decorators.http import require_http_methods

from accounts import master_db

from catalog.models import (
    TherapyArea,
    TriggerCluster,
    Trigger,
    Video,
    VideoLanguage,
    VideoCluster,
    VideoClusterLanguage,
    VideoClusterVideo,
)

from .campaign_auth import SESSION_CAMPAIGN_KEY, get_publisher_claims, publisher_required
from .campaign_forms import CampaignCreateForm, CampaignEditForm
from .models import Campaign


# -----------------------------
# Helpers
# -----------------------------
SESSION_CAMPAIGN_META_BY_CAMPAIGN_KEY = "publisher_campaign_meta_by_campaign"

def _capture_campaign_meta(request: HttpRequest, campaign_id: str | None) -> dict[str, Any]:
    """
    Capture extra values coming from Project1 and persist them in session.
    Stored per-campaign to avoid collisions.
    """
    meta_by_campaign = request.session.get(SESSION_CAMPAIGN_META_BY_CAMPAIGN_KEY) or {}
    meta = meta_by_campaign.get(campaign_id, {}) if campaign_id else {}

    param_names = [
        "num_doctors_supported",
        "name",
        "company_name",
        "contact_person_name",
        "contact_person_phone",
        "contact_person_email",
    ]

    for key in param_names:
        v = request.GET.get(key)
        if v is None:
            v = request.GET.get(key.replace("_", "-"))  # tolerate hyphenated keys
        if v is not None:
            meta[key] = str(v).strip()

    # normalize int
    try:
        meta["num_doctors_supported"] = int(meta.get("num_doctors_supported")) if meta.get("num_doctors_supported") not in (None, "") else None
    except Exception:
        meta["num_doctors_supported"] = None

    if campaign_id:
        meta_by_campaign[campaign_id] = meta
        request.session[SESSION_CAMPAIGN_META_BY_CAMPAIGN_KEY] = meta_by_campaign
        request.session.modified = True

    return meta

class FieldRepWhatsAppForm(forms.Form):
    whatsapp_number = forms.CharField(
        label="Enter doctor’s WhatsApp number",
        max_length=20,
        required=True,
        widget=forms.TextInput(attrs={"placeholder": "e.g. 9876543210", "inputmode": "numeric"}),
    )


def _render_campaign_text_template(template: str, *, doctor_name: str, clinic_link: str, setup_link: str = "") -> str:
    text = template or ""
    replacements = {
        "<doctor.user.full_name>": doctor_name,
        "<doctor_name>": doctor_name,
        "{{doctor_name}}": doctor_name,

        "<clinic_link>": clinic_link,
        "{{clinic_link}}": clinic_link,

        "<setup_link>": setup_link,
        "{{setup_link}}": setup_link,
    }
    for k, v in replacements.items():
        if v:
            text = text.replace(k, v)
    return text



@require_http_methods(["GET", "POST"])
def field_rep_landing_page(request: HttpRequest) -> HttpResponse:
    """
    Field rep landing page with verbose print logs.

    Fixes:
      - field_rep_id may be a JOIN TABLE PK (campaign_campaignfieldrep.id), not FieldRep.id
      - campaign_id in join table is stored without hyphens; normalize before queries
      - enforce that field rep is linked to campaign via campaign_campaignfieldrep

    Logs:
      - request id, method, path
      - parsed campaign_id / field_rep_id
      - field rep resolution path (direct vs join-table)
      - campaign fetch result
      - enrollment counts and limit checks
      - POST validation, doctor lookup result
      - redirect decisions (WhatsApp vs register)
    """
    import json
    import time
    import uuid
    import traceback
    import re
    from urllib.parse import urlencode as _urlencode
    from django.db import connections

    # -------------------------
    # lightweight JSON logger
    # -------------------------
    req_id = request.META.get("HTTP_X_REQUEST_ID") or uuid.uuid4().hex[:12]
    start_ts = time.time()

    def _mask_phone(value: str) -> str:
        s = "".join(ch for ch in str(value or "") if ch.isdigit())
        if not s:
            return ""
        if len(s) <= 4:
            return "*" * len(s)
        return ("*" * (len(s) - 4)) + s[-4:]

    def _mask_email(value: str) -> str:
        v = (value or "").strip()
        if "@" not in v:
            return v[:2] + "***" if v else ""
        local, domain = v.split("@", 1)
        if len(local) <= 2:
            local_masked = local[0] + "*"
        else:
            local_masked = local[:2] + "***"
        return f"{local_masked}@{domain}"

    def _plog(event: str, **data) -> None:
        payload = {
            "ts": int(time.time()),
            "req_id": req_id,
            "event": event,
            "path": request.path,
            "method": request.method,
        }
        payload.update(data)
        try:
            print(json.dumps(payload, default=str))
        except Exception:
            print(f"[req_id={req_id}] {event} {data}")

    def _normalize_campaign_id_for_master(raw: str) -> str:
        # Join table stores campaign_id without hyphens (32 hex)
        return (raw or "").strip().replace("-", "")

    _plog("field_rep_landing.start")

    # -------------------------
    # Parse inputs
    # -------------------------
    campaign_id = (request.GET.get("campaign-id") or request.GET.get("campaign_id") or "").strip()
    field_rep_id = (request.GET.get("field_rep_id") or request.GET.get("field-rep-id") or "").strip()

    campaign_id_db = _normalize_campaign_id_for_master(campaign_id)

    _plog(
        "field_rep_landing.params",
        campaign_id=campaign_id,
        campaign_id_db=campaign_id_db,
        field_rep_id=field_rep_id,
        query_keys=list(request.GET.keys()),
    )

    if not campaign_id or not field_rep_id:
        _plog("field_rep_landing.bad_request.missing_params")
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "limit_reached": True,
                "limit_message": "Missing campaign-id or field_rep_id in URL.",
            },
            status=400,
        )

    # -------------------------
    # Resolve Field Rep (MASTER DB)
    # -------------------------
    master_alias = getattr(settings, "MASTER_DB_ALIAS", "master")
    master_conn = connections[master_alias]

    # Master table names (hardcoded in settings per your latest DB)
    join_table = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_TABLE", "campaign_campaignfieldrep")
    join_pk_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_PK_COLUMN", "id")
    join_campaign_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_CAMPAIGN_COLUMN", "campaign_id")
    join_fieldrep_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_FIELD_REP_COLUMN", "field_rep_id")

    # Try multiple candidates (direct), then fallback to join-table id resolution
    lookup_candidates = [field_rep_id]

    # If SSO identity exists in session, try token sub too (optional)
    session_key = getattr(settings, "SSO_SESSION_KEY_IDENTITY", "sso_identity")
    ident = request.session.get(session_key)
    sub = ""
    if isinstance(ident, dict):
        sub = (ident.get("sub") or "").strip()
        if sub and sub not in lookup_candidates:
            lookup_candidates.append(sub)
        m = re.search(r"(\d+)$", sub)
        if m and m.group(1) not in lookup_candidates:
            lookup_candidates.append(m.group(1))

    fr = None
    fr_resolution = {"path": None}

    # ---- (A) Direct lookup in FieldRep table via master_db.get_field_rep()
    for cand in lookup_candidates:
        if not cand:
            continue
        try:
            tmp = master_db.get_field_rep(cand)
        except Exception as e:
            _plog(
                "field_rep_landing.field_rep.direct_lookup_error",
                candidate=cand,
                error=str(e),
                traceback=traceback.format_exc()[-2000:],
            )
            tmp = None

        if tmp:
            fr = tmp
            fr_resolution = {"path": "direct", "candidate": cand}
            break

    # ---- (B) If not found, treat URL field_rep_id as JOIN TABLE PK
    join_resolved_fieldrep_id = None
    if fr is None and field_rep_id.isdigit():
        try:
            sql = (
                f"SELECT {join_fieldrep_col} "
                f"FROM {join_table} "
                f"WHERE {join_pk_col} = %s AND {join_campaign_col} = %s "
                f"LIMIT 1"
            )
            with master_conn.cursor() as cur:
                cur.execute(sql, [int(field_rep_id), campaign_id_db])
                row = cur.fetchone()

            if row:
                join_resolved_fieldrep_id = str(row[0])
                fr = master_db.get_field_rep(join_resolved_fieldrep_id)
                fr_resolution = {
                    "path": "join_pk",
                    "join_pk": field_rep_id,
                    "resolved_fieldrep_id": join_resolved_fieldrep_id,
                }
        except Exception as e:
            _plog(
                "field_rep_landing.field_rep.join_lookup_error",
                join_pk=field_rep_id,
                campaign_id_db=campaign_id_db,
                error=str(e),
                traceback=traceback.format_exc()[-2000:],
            )

    _plog(
        "field_rep_landing.field_rep.resolution",
        candidates=lookup_candidates,
        found=bool(fr),
        resolution=fr_resolution,
        is_active=(bool(fr.is_active) if fr else None),
        master_field_rep_id=(fr.id if fr else None),
        master_brand_supplied_field_rep_id=(fr.brand_supplied_field_rep_id if fr else None),
    )

    if not fr or not fr.is_active:
        _plog("field_rep_landing.unauthorized.invalid_or_inactive_field_rep")
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "limit_reached": True,
                "limit_message": "Invalid or inactive field rep id.",
            },
            status=401,
        )

    # ---- Enforce: FieldRep must be linked to Campaign via join table
    # (campaign_campaignfieldrep has campaign_id + field_rep_id)
    try:
        fr_id_int = int(fr.id)
        sql = (
            f"SELECT 1 FROM {join_table} "
            f"WHERE {join_campaign_col} = %s AND {join_fieldrep_col} = %s "
            f"LIMIT 1"
        )
        with master_conn.cursor() as cur:
            cur.execute(sql, [campaign_id_db, fr_id_int])
            linked = cur.fetchone() is not None
    except Exception as e:
        _plog(
            "field_rep_landing.field_rep.link_check_error",
            error=str(e),
            traceback=traceback.format_exc()[-2000:],
        )
        linked = False

    _plog(
        "field_rep_landing.field_rep.link_check",
        campaign_id_db=campaign_id_db,
        field_rep_id_resolved=(fr.id if fr else None),
        linked=linked,
    )

    if not linked:
        _plog("field_rep_landing.unauthorized.field_rep_not_linked_to_campaign")
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "limit_reached": True,
                "limit_message": "This field rep is not authorized for this campaign.",
            },
            status=401,
        )

    # Stable downstream field rep identifier for enrollment + register redirect
    downstream_field_rep_id = (fr.brand_supplied_field_rep_id or "").strip() or str(fr.id)

    # -------------------------
    # Fetch campaign (MASTER DB)
    # -------------------------
    try:
        # Prefer normalized campaign id (no hyphens)
        campaign = master_db.get_campaign(campaign_id_db) or master_db.get_campaign(campaign_id)
        _plog(
            "field_rep_landing.campaign.lookup",
            found=bool(campaign),
            doctors_supported=(campaign.doctors_supported if campaign else None),
            used_campaign_id=("normalized" if campaign and campaign.campaign_id == campaign_id_db else "raw_or_unknown"),
        )
    except Exception as e:
        _plog(
            "field_rep_landing.campaign.lookup_error",
            error=str(e),
            traceback=traceback.format_exc()[-2000:],
        )
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "limit_reached": True,
                "limit_message": "Master DB error while fetching campaign.",
            },
            status=500,
        )

    if not campaign:
        _plog("field_rep_landing.bad_request.unknown_campaign")
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "limit_reached": True,
                "limit_message": "Unknown campaign-id (not found in master campaign table).",
            },
            status=400,
        )

    # -------------------------
    # Enrollment count + license enforcement
    # -------------------------
    doctors_supported = int(campaign.doctors_supported or 0)

    try:
        # Prefer normalized id (matches your join table storage)
        enrolled_count_norm = master_db.count_campaign_enrollments(campaign_id_db)
        enrolled_count_raw = 0
        if campaign_id_db != campaign_id:
            enrolled_count_raw = master_db.count_campaign_enrollments(campaign_id)
        enrolled_count = max(enrolled_count_norm, enrolled_count_raw)

        _plog(
            "field_rep_landing.enrollment_count",
            campaign_id_db=campaign_id_db,
            enrolled_count_norm=enrolled_count_norm,
            enrolled_count_raw=enrolled_count_raw,
            enrolled_count=enrolled_count,
        )
    except Exception as e:
        _plog(
            "field_rep_landing.enrollment_count_error",
            error=str(e),
            traceback=traceback.format_exc()[-2000:],
        )
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "campaign": campaign,
                "enrolled_count": 0,
                "doctors_supported": doctors_supported,
                "limit_reached": True,
                "limit_message": "Master DB error while counting enrollments.",
            },
            status=500,
        )

    limit_reached = bool(doctors_supported and enrolled_count >= doctors_supported)
    limit_message = (
        "This campaign already has the maximum allowed doctors registered. "
        "If you wish to register more doctors, please speak to your brand manager who can answer your queries "
        "and obtain more licenses."
    )

    _plog(
        "field_rep_landing.limit_check",
        doctors_supported=doctors_supported,
        enrolled_count=enrolled_count,
        limit_reached=limit_reached,
    )

    if request.method == "GET":
        _plog("field_rep_landing.render_get", elapsed_ms=int((time.time() - start_ts) * 1000))
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": FieldRepWhatsAppForm(),
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "campaign": campaign,
                "enrolled_count": enrolled_count,
                "doctors_supported": doctors_supported,
                "limit_reached": limit_reached,
                "limit_message": limit_message,
            },
        )

    # -------------------------
    # POST: validate WhatsApp input
    # -------------------------
    form = FieldRepWhatsAppForm(request.POST)
    if not form.is_valid():
        _plog(
            "field_rep_landing.post.invalid_form",
            errors=form.errors.get_json_data(),
            elapsed_ms=int((time.time() - start_ts) * 1000),
        )
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": form,
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "campaign": campaign,
                "enrolled_count": enrolled_count,
                "doctors_supported": doctors_supported,
                "limit_reached": limit_reached,
                "limit_message": limit_message,
            },
        )

    if limit_reached:
        _plog("field_rep_landing.post.limit_reached_block", elapsed_ms=int((time.time() - start_ts) * 1000))
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": form,
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "campaign": campaign,
                "enrolled_count": enrolled_count,
                "doctors_supported": doctors_supported,
                "limit_reached": True,
                "limit_message": limit_message,
            },
        )

    wa_number = form.cleaned_data["whatsapp_number"]
    _plog("field_rep_landing.post.whatsapp_received", whatsapp_masked=_mask_phone(wa_number))

    # -------------------------
    # Check doctor exists in MASTER DB by WhatsApp
    # -------------------------
    try:
        doctor = master_db.get_doctor_by_whatsapp(wa_number)
        _plog(
            "field_rep_landing.doctor.lookup",
            found=bool(doctor),
            doctor_id=(doctor.doctor_id if doctor else None),
            doctor_email_masked=(_mask_email(doctor.email) if doctor and doctor.email else None),
        )
    except Exception as e:
        _plog(
            "field_rep_landing.doctor.lookup_error",
            error=str(e),
            traceback=traceback.format_exc()[-2000:],
        )
        return render(
            request,
            "publisher/field_rep_landing_page.html",
            {
                "form": form,
                "campaign_id": campaign_id,
                "field_rep_id": field_rep_id,
                "campaign": campaign,
                "enrolled_count": enrolled_count,
                "doctors_supported": doctors_supported,
                "limit_reached": True,
                "limit_message": "Master DB error while searching doctor.",
            },
            status=500,
        )

    base_url = getattr(settings, "PUBLIC_BASE_URL", "https://portal.cpdinclinic.co.in").rstrip("/")

    if doctor:
        # Ensure enrollment exists in master DB
        # IMPORTANT: use normalized campaign id + stable registered_by
        registered_by = downstream_field_rep_id
        try:
            master_db.ensure_enrollment(
                doctor_id=doctor.doctor_id,
                campaign_id=campaign_id_db,
                registered_by=registered_by,
            )
            _plog(
                "field_rep_landing.enrollment.ensure",
                doctor_id=doctor.doctor_id,
                campaign_id=campaign_id_db,
                registered_by=registered_by,
                status="ok",
            )
        except Exception as e:
            _plog(
                "field_rep_landing.enrollment.ensure_error",
                doctor_id=doctor.doctor_id,
                campaign_id=campaign_id_db,
                registered_by=registered_by,
                error=str(e),
                traceback=traceback.format_exc()[-2000:],
            )
            return render(
                request,
                "publisher/field_rep_landing_page.html",
                {
                    "form": form,
                    "campaign_id": campaign_id,
                    "field_rep_id": field_rep_id,
                    "campaign": campaign,
                    "enrolled_count": enrolled_count,
                    "doctors_supported": doctors_supported,
                    "limit_reached": True,
                    "limit_message": "Master DB error while enrolling doctor into campaign.",
                },
                status=500,
            )

        clinic_link = f"{base_url}/clinic/{doctor.doctor_id}/share/"

        wa_addition_text = _render_campaign_text_template(
            campaign.wa_addition or "",
            doctor_name=(doctor.full_name or "Doctor").strip(),
            clinic_link=clinic_link,
            setup_link="",
        ).strip()

        lines = []
        if wa_addition_text:
            lines.append(wa_addition_text)
        if campaign.new_video_cluster_name:
            lines.append(str(campaign.new_video_cluster_name).strip())
        lines.append("Link to your clinic’s patient education system")
        lines.append(clinic_link)

        whatsapp_url = master_db.build_whatsapp_deeplink(wa_number, "\n".join(lines))

        _plog(
            "field_rep_landing.redirect.whatsapp",
            whatsapp_masked=_mask_phone(wa_number),
            doctor_id=doctor.doctor_id,
            clinic_link=clinic_link,
            elapsed_ms=int((time.time() - start_ts) * 1000),
        )
        return redirect(whatsapp_url)

    # Not found -> redirect to portal registration with params
    # IMPORTANT: pass normalized campaign-id and stable field_rep_id downstream
    register_url = f"{base_url}/accounts/register/"
    query = _urlencode({"campaign-id": campaign_id_db, "field_rep_id": downstream_field_rep_id})
    dest = f"{register_url}?{query}"

    _plog(
        "field_rep_landing.redirect.register",
        whatsapp_masked=_mask_phone(wa_number),
        destination=dest,
        elapsed_ms=int((time.time() - start_ts) * 1000),
    )
    return redirect(dest)



    


def _video_title_en(video: Video) -> str:
    # best-effort English title fallback
    vlang = (
        VideoLanguage.objects.filter(video=video, language_code="en").first()
        or VideoLanguage.objects.filter(video=video).first()
    )
    return (vlang.title if vlang and vlang.title else video.code).strip()


def _cluster_name_en(cluster: VideoCluster) -> str:
    clang = (
        VideoClusterLanguage.objects.filter(video_cluster=cluster, language_code="en").first()
        or VideoClusterLanguage.objects.filter(video_cluster=cluster).first()
    )
    if clang and clang.name:
        return clang.name.strip()
    return (cluster.display_name or cluster.code or "").strip()


def _expand_selected_items_to_video_ids(items: List[Dict[str, Any]]) -> List[int]:
    video_ids: Set[int] = set()
    cluster_ids: Set[int] = set()

    for item in items:
        t = str(item.get("type") or "").lower().strip()
        try:
            _id = int(item.get("id"))
        except Exception:
            continue

        if t == "video":
            video_ids.add(_id)
        elif t == "cluster":
            cluster_ids.add(_id)

    if cluster_ids:
        cluster_video_ids = VideoClusterVideo.objects.filter(
            video_cluster_id__in=list(cluster_ids)
        ).values_list("video_id", flat=True)
        video_ids.update(list(cluster_video_ids))

    return sorted(video_ids)


def _get_or_create_brand_trigger() -> Trigger:
    """
    VideoCluster requires a Trigger. Campaign spec does not provide trigger selection,
    so we create/use a dedicated "BRAND_CAMPAIGNS" therapy + trigger cluster + trigger.
    """

    therapy, _ = TherapyArea.objects.get_or_create(
        code="BRAND_CAMPAIGNS",
        defaults={
            "display_name": "Brand Campaigns",
            "description": "Auto-created therapy area for brand campaigns",
            "sort_order": 999,
            "is_active": True,
        },
    )

    tcluster, _ = TriggerCluster.objects.get_or_create(
        code="BRAND_CAMPAIGNS",
        defaults={
            "display_name": "Brand Campaigns",
            "description": "Auto-created trigger cluster for brand campaigns",
            "language_code": "en",
            "sort_order": 999,
            "is_active": True,
        },
    )

    trigger, _ = Trigger.objects.get_or_create(
        code="BRAND_CAMPAIGN",
        defaults={
            "display_name": "Brand Campaign",
            "doctor_trigger_label": "Brand Campaign",
            "subtopic_title": "Brand Campaign",
            "navigation_pathways": "",
            "search_keywords": "brand,campaign",
            "cluster": tcluster,
            "primary_therapy": therapy,
            "sort_order": 999,
            "is_active": True,
        },
    )

    return trigger


def _generate_unique_cluster_code(name: str) -> str:
    base = slugify(name, allow_unicode=False).replace("-", "_").upper().strip("_")
    if not base:
        base = "CAMPAIGN_CLUSTER"

    base = base[:70]  # leave room for suffix
    code = base
    i = 1
    while VideoCluster.objects.filter(code=code).exists():
        suffix = f"_{i}"
        code = f"{base[: (80 - len(suffix))]}{suffix}"
        i += 1

    return code


# -----------------------------
# Pages
# -----------------------------

@publisher_required
@require_GET
def publisher_landing_page(request: HttpRequest) -> HttpResponse:
    claims = get_publisher_claims(request) or {}

    campaign_id = (
        request.GET.get("campaign-id")
        or request.GET.get("campaign_id")
        or request.session.get(SESSION_CAMPAIGN_KEY)
        or ""
    ).strip() or None

    # Capture extra values from Project1 into session (per campaign)
    campaign_meta = _capture_campaign_meta(request, campaign_id)

    # (extra safety) Remove token from URL if present
    if any(k in request.GET for k in ("token", "jwt", "access_token")):
        q = request.GET.copy()
        for k in ("token", "jwt", "access_token"):
            q.pop(k, None)
        return redirect(f"{request.path}?{q.urlencode()}") if q else redirect(request.path)

    return render(
        request,
        "publisher/publisher_landing_page.html",
        {
            "publisher": claims,
            "campaign_id": campaign_id,
            "campaign_meta": campaign_meta,
            "show_auth_links": False,
        },
    )



@publisher_required
@require_http_methods(["GET", "POST"])
def add_campaign_details(request: HttpRequest) -> HttpResponse:
        claims = get_publisher_claims(request) or {}
    
        campaign_id = (
            request.GET.get("campaign-id")
            or request.GET.get("campaign_id")
            or request.POST.get("campaign_id")
            or request.session.get(SESSION_CAMPAIGN_KEY)
        )
        if not campaign_id:
            return HttpResponseBadRequest("campaign-id missing")
    
        request.session[SESSION_CAMPAIGN_KEY] = campaign_id
    
        existing = Campaign.objects.filter(campaign_id=campaign_id).first()
        if existing and request.method == "GET":
            messages.info(request, "Campaign already has details. Redirected to edit screen.")
            return redirect(
                reverse("campaign_publisher:edit_campaign_details", kwargs={"campaign_id": campaign_id})
            )
    
        if request.method == "POST":
            form = CampaignCreateForm(request.POST, request.FILES)
            if form.is_valid():
                # 5.1 Check if the new video cluster name already exists
                new_cluster_name = form.cleaned_data["new_video_cluster_name"]
                if VideoClusterLanguage.objects.filter(name__iexact=new_cluster_name).exists():
                    messages.error(
                        request,
                        "video cluster name already exists.  Write a different name",
                    )
                    return render(
                        request,
                        "publisher/add_campaign_details.html",
                        {
                            "form": form,
                            "campaign_id": campaign_id,
                            "publisher": claims,
                            "show_auth_links": False,
                        },
                    )
    
                # Expand selection into final list of videos
                selected_items = json.loads(form.cleaned_data["selected_items_json"])
                video_ids = _expand_selected_items_to_video_ids(selected_items)
                if not video_ids:
                    form.add_error(None, "Please select at least one valid video or video-cluster.")
                    return render(
                        request,
                        "publisher/add_campaign_details.html",
                        {
                            "form": form,
                            "campaign_id": campaign_id,
                            "publisher": claims,
                            "show_auth_links": False,
                        },
                    )
    
                # Also block duplicates by campaign_id
                if Campaign.objects.filter(campaign_id=campaign_id).exists():
                    messages.error(request, "Campaign already exists. Use edit instead.")
                    return redirect(
                        reverse("campaign_publisher:edit_campaign_details", kwargs={"campaign_id": campaign_id})
                    )
    
                publisher_sub = str(claims.get("sub") or "")
                publisher_username = str(claims.get("username") or "")
                publisher_roles = ",".join([str(r) for r in (claims.get("roles") or [])])
    
                with transaction.atomic():
                    # 5.3 Create a new video cluster
                    trigger = _get_or_create_brand_trigger()
                    cluster_code = _generate_unique_cluster_code(new_cluster_name)
    
                    cluster = VideoCluster.objects.create(
                        code=cluster_code,
                        display_name=new_cluster_name,
                        description="",
                        trigger=trigger,
                        sort_order=0,
                        is_published=True,
                        search_keywords=new_cluster_name,
                        is_active=True,
                    )
    
                    VideoClusterLanguage.objects.create(
                        video_cluster=cluster,
                        language_code="en",
                        name=new_cluster_name,
                    )
    
                    videos = list(Video.objects.filter(id__in=video_ids).order_by("code"))
                    for idx, v in enumerate(videos, start=1):
                        VideoClusterVideo.objects.create(
                            video_cluster=cluster,
                            video=v,
                            sort_order=idx,
                        )
    
                    # 5.2 Insert all details into campaigns-table
                    Campaign.objects.create(
                        campaign_id=campaign_id,
                        new_video_cluster_name=new_cluster_name,
                        selection_json=form.cleaned_data["selected_items_json"],
                        doctors_supported=form.cleaned_data["doctors_supported"],
                        banner_small=form.cleaned_data["banner_small"],
                        banner_large=form.cleaned_data["banner_large"],
                        banner_target_url=form.cleaned_data["banner_target_url"],
                        start_date=form.cleaned_data["start_date"],
                        end_date=form.cleaned_data["end_date"],
                        video_cluster=cluster,
                        publisher_sub=publisher_sub,
                        publisher_username=publisher_username,
                        publisher_roles=publisher_roles,
                        email_registration=form.cleaned_data["email_registration"],
                        wa_addition=form.cleaned_data["wa_addition"],
                    )
    
                messages.success(request, "Campaign saved. Video cluster created successfully.")
    
                return redirect(
                    f"{reverse('campaign_publisher:publisher_landing_page')}?{urlencode({'campaign-id': campaign_id})}"
                )
        else:
            initial = {
                "campaign_id": campaign_id,
                "selected_items_json": "[]",
                "email_registration": "",
                "wa_addition": "",
            }
    
            # -------------------------------------------------------------
            # Prefill doctors_supported from Project1 if provided
            # -------------------------------------------------------------
            meta_by_campaign = request.session.get(SESSION_CAMPAIGN_META_BY_CAMPAIGN_KEY) or {}
            meta = meta_by_campaign.get(campaign_id, {}) if campaign_id else {}
            if meta.get("num_doctors_supported") is not None:
                initial["doctors_supported"] = meta["num_doctors_supported"]
    
            form = CampaignCreateForm(initial=initial)
    
        return render(
            request,
            "publisher/add_campaign_details.html",
            {
                "form": form,
                "campaign_id": campaign_id,
                "publisher": claims,
                "show_auth_links": False,
            },
        )
    

@publisher_required
@require_GET
def campaign_list(request: HttpRequest) -> HttpResponse:
    claims = get_publisher_claims(request) or {}

    q = (request.GET.get("q") or "").strip()
    rows = Campaign.objects.all().order_by("-created_at")

    if q:
        rows = rows.filter(
            Q(campaign_id__icontains=q) | Q(new_video_cluster_name__icontains=q)
        )

    return render(
        request,
        "publisher/campaign_list.html",
        {
            "publisher": claims,
            "rows": rows,
            "q": q,
            "show_auth_links": False,
        },
    )


@publisher_required
@require_http_methods(["GET", "POST"])
def edit_campaign_details(request: HttpRequest, campaign_id: str) -> HttpResponse:
    claims = get_publisher_claims(request) or {}
    campaign = get_object_or_404(Campaign, campaign_id=campaign_id)

    if request.method == "POST":
        form = CampaignEditForm(request.POST, request.FILES)
        if form.is_valid():
            new_cluster_name = form.cleaned_data["new_video_cluster_name"].strip()
            selected_items = json.loads(form.cleaned_data["selected_items_json"])
            video_ids = _expand_selected_items_to_video_ids(selected_items)

            if not video_ids:
                form.add_error(None, "Please select at least one valid video or video-cluster.")
                return render(
                    request,
                    "publisher/edit_campaign_details.html",
                    {
                        "form": form,
                        "campaign": campaign,
                        "publisher": claims,
                        "show_auth_links": False,
                    },
                )

            # Uniqueness check for cluster name (excluding current cluster)
            if campaign.video_cluster_id:
                if VideoClusterLanguage.objects.filter(name__iexact=new_cluster_name).exclude(
                    video_cluster_id=campaign.video_cluster_id
                ).exists():
                    messages.error(
                        request,
                        "video cluster name already exists.  Write a different name",
                    )
                    return render(
                        request,
                        "publisher/edit_campaign_details.html",
                        {
                            "form": form,
                            "campaign": campaign,
                            "publisher": claims,
                            "show_auth_links": False,
                        },
                    )

            with transaction.atomic():
                cluster = campaign.video_cluster

                # Update cluster display/name
                if cluster and new_cluster_name:
                    cluster.display_name = new_cluster_name
                    cluster.search_keywords = new_cluster_name
                    cluster.save()

                    cl_en = VideoClusterLanguage.objects.filter(
                        video_cluster=cluster, language_code="en"
                    ).first()
                    if cl_en:
                        cl_en.name = new_cluster_name
                        cl_en.save()
                    else:
                        VideoClusterLanguage.objects.create(
                            video_cluster=cluster,
                            language_code="en",
                            name=new_cluster_name,
                        )

                # Replace cluster videos with desired set (simple + deterministic)
                if cluster:
                    VideoClusterVideo.objects.filter(video_cluster=cluster).delete()
                    videos = list(Video.objects.filter(id__in=video_ids).order_by("code"))
                    for idx, v in enumerate(videos, start=1):
                        VideoClusterVideo.objects.create(
                            video_cluster=cluster, video=v, sort_order=idx
                        )

                # Update campaign metadata
                campaign.new_video_cluster_name = new_cluster_name
                campaign.selection_json = form.cleaned_data["selected_items_json"]
                campaign.doctors_supported = form.cleaned_data["doctors_supported"]
                campaign.banner_target_url = form.cleaned_data["banner_target_url"]
                campaign.start_date = form.cleaned_data["start_date"]
                campaign.end_date = form.cleaned_data["end_date"]
                campaign.email_registration = form.cleaned_data["email_registration"]
                campaign.wa_addition = form.cleaned_data["wa_addition"]


                if form.cleaned_data.get("banner_small"):
                    campaign.banner_small = form.cleaned_data["banner_small"]
                if form.cleaned_data.get("banner_large"):
                    campaign.banner_large = form.cleaned_data["banner_large"]

                campaign.save()

            messages.success(request, "Campaign updated successfully.")
            return redirect(reverse("campaign_publisher:campaign_list"))
    else:
        form = CampaignEditForm(
            initial={
                "campaign_id": campaign.campaign_id,
                "new_video_cluster_name": campaign.new_video_cluster_name,
                "selected_items_json": campaign.selection_json or "[]",
                "doctors_supported": campaign.doctors_supported,
                "banner_target_url": campaign.banner_target_url,
                "start_date": campaign.start_date,
                "end_date": campaign.end_date,
                "email_registration": campaign.email_registration or "",
                "wa_addition": campaign.wa_addition or "",

            }
        )

    return render(
        request,
        "publisher/edit_campaign_details.html",
        {
            "form": form,
            "campaign": campaign,
            "publisher": claims,
            "show_auth_links": False,
        },
    )


# -----------------------------
# APIs for the add/edit screen UI
# -----------------------------

@publisher_required
@require_GET
def api_search_catalog(request: HttpRequest) -> JsonResponse:
    q = (request.GET.get("q") or "").strip()
    if not q or len(q) < 2:
        return JsonResponse({"results": []})

    videos = (
        Video.objects.filter(
            Q(code__icontains=q)
            | Q(search_keywords__icontains=q)
            | Q(languages__title__icontains=q)
        )
        .distinct()
        .order_by("code")[:20]
    )

    clusters = (
        VideoCluster.objects.filter(
            Q(code__icontains=q)
            | Q(display_name__icontains=q)
            | Q(search_keywords__icontains=q)
            | Q(languages__name__icontains=q)
        )
        .distinct()
        .order_by("code")[:20]
    )

    results: List[Dict[str, Any]] = []

    for v in videos:
        results.append(
            {
                "type": "video",
                "id": v.id,
                "code": v.code,
                "title": _video_title_en(v),
            }
        )

    for c in clusters:
        results.append(
            {
                "type": "cluster",
                "id": c.id,
                "code": c.code,
                "title": _cluster_name_en(c),
            }
        )

    return JsonResponse({"results": results})


@publisher_required
@require_POST
def api_expand_selection(request: HttpRequest) -> JsonResponse:
    try:
        payload = json.loads((request.body or b"").decode("utf-8"))
    except Exception:
        return JsonResponse({"error": "invalid json"}, status=400)

    items = payload.get("items")
    if not isinstance(items, list):
        return JsonResponse({"error": "items must be a list"}, status=400)

    # Normalize items
    normalized: List[Dict[str, Any]] = []
    for it in items:
        if not isinstance(it, dict):
            continue
        t = str(it.get("type") or "").lower().strip()
        if t not in ("video", "cluster"):
            continue
        try:
            _id = int(it.get("id"))
        except Exception:
            continue
        normalized.append({"type": t, "id": _id})

    video_ids = _expand_selected_items_to_video_ids(normalized)
    videos = list(Video.objects.filter(id__in=video_ids).order_by("code"))

    out = [{"id": v.id, "code": v.code, "title": _video_title_en(v)} for v in videos]
    return JsonResponse({"videos": out})

================================================================================
FILE: publisher/campaign_auth.py
================================================================================

from __future__ import annotations

from functools import wraps
from typing import Any, Dict, Optional, Sequence
from urllib.parse import urlencode

from django.conf import settings
from django.http import HttpRequest, HttpResponse
from django.shortcuts import redirect

# Part-C session keys (Project2)
SESSION_KEY = getattr(settings, "SSO_SESSION_KEY_IDENTITY", "sso_identity")
SESSION_CAMPAIGN_KEY = getattr(settings, "SSO_SESSION_KEY_CAMPAIGN", "campaign_id")

# Legacy compatibility (if any old sessions exist)
LEGACY_SESSION_KEY = "publisher_jwt_claims"
LEGACY_CAMPAIGN_KEY = "publisher_current_campaign_id"


def unauthorized_response() -> HttpResponse:
    return HttpResponse("unauthorised access", status=401, content_type="text/plain")


def _normalize_roles(value: Any) -> Sequence[str]:
    if value is None:
        return []
    if isinstance(value, (list, tuple)):
        return [str(v) for v in value]
    return [str(value)]


def _extract_token(request: HttpRequest) -> Optional[str]:
    token = (
        request.GET.get("token")
        or request.GET.get("jwt")
        or request.GET.get("access_token")
    )
    if token:
        return token.strip()

    auth = (request.META.get("HTTP_AUTHORIZATION") or "").strip()
    if auth.lower().startswith("bearer "):
        return auth[7:].strip()

    return None


import time
from accounts import master_db

SESSION_PUBLISHER_MASTER_VALIDATION = "publisher_master_validation"
PUBLISHER_MASTER_VALIDATION_TTL_SECONDS = getattr(settings, "PUBLISHER_MASTER_VALIDATION_TTL_SECONDS", 300)


def _extract_email_from_claims(ident: Dict[str, Any]) -> str:
    """
    We must map JWT claims to the AuthorizedPublisher.email in master DB.
    Prefer ident['email'] if present, else fallback to ident['username'] if it looks like an email.
    """
    email = (ident.get("email") or "").strip().lower()
    if email and "@" in email:
        return email

    username = (ident.get("username") or "").strip().lower()
    if username and "@" in username:
        return username

    # If your tokens carry publisher email in a different claim, add it here:
    # e.g. ident.get("publisher_email")
    other = (ident.get("publisher_email") or "").strip().lower()
    if other and "@" in other:
        return other

    return ""


def _is_publisher_authorized_in_master(request: HttpRequest, email: str) -> bool:
    """
    Cached check (session cache for 5 minutes default).
    """
    if not email:
        return False

    cache = request.session.get(SESSION_PUBLISHER_MASTER_VALIDATION) or {}
    now = int(time.time())

    if (
        isinstance(cache, dict)
        and cache.get("email") == email
        and cache.get("ok") is True
        and isinstance(cache.get("ts"), int)
        and now - cache["ts"] <= int(PUBLISHER_MASTER_VALIDATION_TTL_SECONDS)
    ):
        return True

    ok = master_db.authorized_publisher_exists(email)
    request.session[SESSION_PUBLISHER_MASTER_VALIDATION] = {"email": email, "ok": bool(ok), "ts": now}
    request.session.modified = True
    return bool(ok)


def get_publisher_claims(request: HttpRequest) -> Optional[Dict[str, Any]]:
    ident = request.session.get(SESSION_KEY)
    if isinstance(ident, dict):
        roles = _normalize_roles(ident.get("roles"))
        if "publisher" in [r.lower() for r in roles]:
            email = _extract_email_from_claims(ident)
            if _is_publisher_authorized_in_master(request, email):
                return ident

            # Not authorized anymore -> wipe session identity
            request.session.pop(SESSION_KEY, None)
            request.session.pop(SESSION_CAMPAIGN_KEY, None)
            request.session.pop(SESSION_PUBLISHER_MASTER_VALIDATION, None)
            request.session.modified = True
            return None

    legacy = request.session.get(LEGACY_SESSION_KEY)
    if isinstance(legacy, dict):
        roles = _normalize_roles(legacy.get("roles"))
        if "publisher" in [r.lower() for r in roles]:
            email = _extract_email_from_claims(legacy)
            if _is_publisher_authorized_in_master(request, email):
                return legacy

            request.session.pop(LEGACY_SESSION_KEY, None)
            request.session.pop(LEGACY_CAMPAIGN_KEY, None)
            request.session.pop(SESSION_PUBLISHER_MASTER_VALIDATION, None)
            request.session.modified = True
            return None

    return None



def _redirect_to_sso_consume(request: HttpRequest, token: str) -> HttpResponse:
    campaign_id = (
        request.GET.get("campaign_id")
        or request.GET.get("campaign-id")
        or request.session.get(SESSION_CAMPAIGN_KEY)
        or request.session.get(LEGACY_CAMPAIGN_KEY)
        or ""
    )
    if not campaign_id:
        return unauthorized_response()

    # next URL without token params
    params = request.GET.copy()
    for k in ("token", "jwt", "access_token"):
        if k in params:
            params.pop(k)

    next_url = request.path
    if params:
        next_url = f"{next_url}?{params.urlencode()}"

    consume_url = "/sso/consume/?" + urlencode(
        {"token": token, "campaign_id": campaign_id, "next": next_url}
    )
    return redirect(consume_url)


def publisher_required(view_func):
    """
    Part-C destination behavior:
    - If valid SSO session exists -> allow
    - Else if token present -> route via /sso/consume/
    - Else -> 401 unauthorised access

    Adds print logs (JSON lines) without leaking tokens.
    """
    import json
    import time
    import uuid

    @wraps(view_func)
    def _wrapped(request: HttpRequest, *args, **kwargs):
        req_id = request.META.get("HTTP_X_REQUEST_ID") or uuid.uuid4().hex[:12]

        def _plog(event: str, **data) -> None:
            payload = {
                "ts": int(time.time()),
                "req_id": req_id,
                "event": event,
                "path": request.path,
                "method": request.method,
                "view": getattr(view_func, "__name__", "unknown"),
            }
            payload.update(data)
            try:
                print(json.dumps(payload, default=str))
            except Exception:
                print(f"[req_id={req_id}] {event} {data}")

        _plog("publisher_required.start")

        try:
            claims = get_publisher_claims(request)
        except Exception as e:
            _plog("publisher_required.claims_error", error=str(e))
            return unauthorized_response()

        if claims:
            roles = claims.get("roles")
            # Do not print sensitive fields; best-effort identify
            username = (claims.get("email") or claims.get("username") or claims.get("sub") or "")
            if isinstance(username, str) and "@" in username:
                u_masked = username.split("@", 1)[0][:2] + "***@" + username.split("@", 1)[1]
            else:
                u_masked = str(username)[:6] + "***" if username else ""
            _plog("publisher_required.authorized", user=u_masked, roles=roles)
            return view_func(request, *args, **kwargs)

        token = _extract_token(request)
        if token:
            _plog("publisher_required.token_present.redirect_to_consume", token_len=len(token))
            return _redirect_to_sso_consume(request, token)

        _plog("publisher_required.unauthorized.no_claims_no_token")
        return unauthorized_response()

    return _wrapped

================================================================================
FILE: publisher/campaign_forms.py
================================================================================

from __future__ import annotations
import json
from typing import Any, Dict, List

from django import forms
from django.core.exceptions import ValidationError

class FieldRepWhatsAppForm(forms.Form):
    whatsapp_number = forms.CharField(
        label="Enter doctor’s WhatsApp number",
        max_length=20,
        required=True,
        widget=forms.TextInput(attrs={"placeholder": "e.g. 9876543210", "inputmode": "numeric"}),
    )

class CampaignCreateForm(forms.Form):
    campaign_id = forms.CharField(widget=forms.HiddenInput())

    new_video_cluster_name = forms.CharField(
        max_length=255,
        label="New video-cluster name",
    )

    # Hidden field holding JSON array: [{"type":"video","id":..}, {"type":"cluster","id":..}]
    selected_items_json = forms.CharField(
        widget=forms.HiddenInput(),
        required=True,
    )

    doctors_supported = forms.IntegerField(
        min_value=0,
        label="Number of doctors supported",
    )

    banner_small = forms.FileField(required=True, label="Banner (small)")
    banner_large = forms.FileField(required=True, label="Banner (large)")

    banner_target_url = forms.URLField(
        max_length=500,
        label="Banner click URL",
    )

    # --- NEW FIELDS ---
    email_registration = forms.CharField(
        label="Email message for registering a new doctor",
        widget=forms.Textarea(attrs={"rows": 4}),
        required=True,
    )

    wa_addition = forms.CharField(
        label="WhatsApp message for adding an already registered doctor",
        widget=forms.Textarea(attrs={"rows": 4}),
        required=True,
    )
    # ------------------

    start_date = forms.DateField(
        widget=forms.DateInput(attrs={"type": "date"}),
        label="Start date",
    )
    end_date = forms.DateField(
        widget=forms.DateInput(attrs={"type": "date"}),
        label="End date",
    )

    def clean_selected_items_json(self) -> str:
        raw = (self.cleaned_data.get("selected_items_json") or "").strip()
        if not raw:
            raise ValidationError("Please select at least one video or video-cluster.")

        try:
            data = json.loads(raw)
        except Exception:
            raise ValidationError("Invalid selection payload.")

        if not isinstance(data, list) or not data:
            raise ValidationError("Please select at least one video or video-cluster.")

        cleaned: List[Dict[str, Any]] = []
        for item in data:
            if not isinstance(item, dict):
                continue
            t = str(item.get("type") or "").strip().lower()
            if t not in ("video", "cluster"):
                continue
            try:
                i = int(item.get("id"))
            except Exception:
                continue
            cleaned.append({"type": t, "id": i})

        if not cleaned:
            raise ValidationError("Please select at least one valid video or video-cluster.")

        # normalize back to JSON string
        return json.dumps(cleaned)

    def clean(self):
        cleaned = super().clean()

        name = (cleaned.get("new_video_cluster_name") or "").strip()
        if name:
            cleaned["new_video_cluster_name"] = name

        sd = cleaned.get("start_date")
        ed = cleaned.get("end_date")
        if sd and ed and sd > ed:
            self.add_error("end_date", "End date must be on or after start date.")

        # --- OPTIONAL CLEANUP ---
        if "email_registration" in cleaned:
            cleaned["email_registration"] = (cleaned.get("email_registration") or "").strip()
        if "wa_addition" in cleaned:
            cleaned["wa_addition"] = (cleaned.get("wa_addition") or "").strip()
        # ----------------------

        return cleaned

class CampaignEditForm(CampaignCreateForm):
    # For edit: banners may be unchanged
    banner_small = forms.FileField(required=False, label="Replace banner (small)")
    banner_large = forms.FileField(required=False, label="Replace banner (large)")

================================================================================
FILE: publisher/apps.py
================================================================================

from django.apps import AppConfig


class PublisherConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "publisher"

================================================================================
FILE: publisher/forms.py
================================================================================

from __future__ import annotations

from typing import Optional

from django import forms
from django.core.exceptions import ValidationError
from django.db.models import Q
from django.forms import inlineformset_factory
from django.forms.models import BaseInlineFormSet

from catalog.constants import LANGUAGE_CODES
from catalog.models import (
    TherapyArea,
    Video,
    VideoCluster,
    VideoClusterLanguage,
    VideoClusterVideo,
    VideoLanguage,
    VideoTriggerMap,
    Trigger,
    TriggerCluster,
)


class TherapyAreaForm(forms.ModelForm):
    class Meta:
        model = TherapyArea
        fields = ["code", "display_name", "description", "is_active"]


class VideoClusterForm(forms.ModelForm):
    class Meta:
        model = VideoCluster
        fields = ["code", "display_name", "description", "trigger", "is_published", "is_active"]

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        if "trigger" in self.fields:
            self.fields["trigger"].queryset = Trigger.objects.all().order_by("display_name", "code")


class VideoForm(forms.ModelForm):
    clusters = forms.ModelMultipleChoiceField(
        queryset=VideoCluster.objects.none(),
        required=True,
        widget=forms.SelectMultiple(attrs={"size": 8}),
        help_text="Select at least 1 bundle/cluster. A video cannot exist standalone.",
    )

    class Meta:
        model = Video
        fields = ["code", "thumbnail_url", "is_active"]

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        if self.instance and self.instance.pk:
            existing_ids = list(self.instance.clusters.values_list("pk", flat=True))
            qs = (
                VideoCluster.objects.filter(Q(is_active=True) | Q(pk__in=existing_ids))
                .order_by("display_name", "code")
            )
            self.fields["clusters"].initial = list(self.instance.clusters.all())
        else:
            qs = VideoCluster.objects.filter(is_active=True).order_by("display_name", "code")

        self.fields["clusters"].queryset = qs


class VideoLanguageForm(forms.ModelForm):
    class Meta:
        model = VideoLanguage
        fields = ["language_code", "title", "youtube_url"]


class BaseVideoLanguageFormSet(BaseInlineFormSet):
    def clean(self):
        super().clean()

        seen = set()
        missing = set(LANGUAGE_CODES)

        for form in self.forms:
            if not hasattr(form, "cleaned_data"):
                continue

            code = form.cleaned_data.get("language_code")
            title = (form.cleaned_data.get("title") or "").strip()
            url = (form.cleaned_data.get("youtube_url") or "").strip()

            if not code:
                continue

            if code in seen:
                raise ValidationError("Duplicate language detected. Each language must be entered exactly once.")

            seen.add(code)
            missing.discard(code)

            if not title or not url:
                raise ValidationError("Please provide both Title and YouTube URL for every language.")

        if missing:
            raise ValidationError("Please provide Title and YouTube URL for all languages: " + ", ".join(sorted(missing)))


def make_video_language_formset(extra: int = 0):
    return inlineformset_factory(
        Video,
        VideoLanguage,
        form=VideoLanguageForm,
        formset=BaseVideoLanguageFormSet,
        fields=["language_code", "title", "youtube_url"],
        extra=extra,
        can_delete=False,
    )


class VideoClusterLanguageForm(forms.ModelForm):
    class Meta:
        model = VideoClusterLanguage
        fields = ["language_code", "name"]


class VideoClusterVideoForm(forms.ModelForm):
    sort_order = forms.IntegerField(required=False)

    class Meta:
        model = VideoClusterVideo
        fields = ["video", "sort_order"]

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        if "video" in self.fields:
            self.fields["video"].queryset = Video.objects.all().order_by("code")
            # Enable JS-based type-to-filter by adding a stable CSS hook.
            self.fields["video"].widget.attrs.update({"class": "video-select"})


def make_cluster_language_formset(extra: int = 5):
    return inlineformset_factory(
        VideoCluster,
        VideoClusterLanguage,
        form=VideoClusterLanguageForm,
        fields=["language_code", "name"],
        extra=extra,
        can_delete=True,
    )


def make_cluster_video_formset(extra: int = 5):
    return inlineformset_factory(
        VideoCluster,
        VideoClusterVideo,
        form=VideoClusterVideoForm,
        fields=["video", "sort_order"],
        extra=extra,
        can_delete=True,
    )


class TriggerForm(forms.ModelForm):
    class Meta:
        model = Trigger
        fields = ["code", "display_name", "cluster", "primary_therapy", "doctor_trigger_label", "is_active"]

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        if "cluster" in self.fields:
            self.fields["cluster"].queryset = TriggerCluster.objects.all().order_by("display_name", "code")
        if "primary_therapy" in self.fields:
            self.fields["primary_therapy"].queryset = TherapyArea.objects.all().order_by("display_name", "code")


class TriggerClusterForm(forms.ModelForm):
    class Meta:
        model = TriggerCluster
        fields = ["code", "display_name", "description", "is_active"]


class BundleTriggerMapForm(forms.Form):
    bundle = forms.ModelChoiceField(queryset=VideoCluster.objects.none(), required=True)
    trigger = forms.ModelChoiceField(queryset=Trigger.objects.none(), required=True)

    def __init__(self, *args, bundle_instance: Optional[VideoCluster] = None, **kwargs):
        super().__init__(*args, **kwargs)

        self.bundle_instance = bundle_instance

        if bundle_instance and bundle_instance.pk:
            bqs = VideoCluster.objects.filter(Q(is_active=True) | Q(pk=bundle_instance.pk)).order_by("display_name", "code")
        else:
            bqs = VideoCluster.objects.filter(is_active=True).order_by("display_name", "code")

        if bundle_instance and getattr(bundle_instance, "trigger_id", None):
            tqs = Trigger.objects.filter(Q(is_active=True) | Q(pk=bundle_instance.trigger_id)).order_by("display_name", "code")
        else:
            tqs = Trigger.objects.filter(is_active=True).order_by("display_name", "code")

        self.fields["bundle"].queryset = bqs
        self.fields["trigger"].queryset = tqs

        if bundle_instance and bundle_instance.pk:
            self.fields["bundle"].initial = bundle_instance
            self.fields["bundle"].disabled = True
            if getattr(bundle_instance, "trigger_id", None):
                self.fields["trigger"].initial = bundle_instance.trigger_id

    def clean_bundle(self):
        if self.bundle_instance and self.bundle_instance.pk:
            return self.bundle_instance
        return self.cleaned_data["bundle"]


class VideoTriggerMapForm(forms.ModelForm):
    sort_order = forms.IntegerField(required=False)

    class Meta:
        model = VideoTriggerMap
        fields = ["trigger", "video", "is_primary", "sort_order"]

================================================================================
FILE: publisher/campaign_urls.py
================================================================================

from django.urls import path

from . import campaign_views

app_name = "campaign_publisher"

urlpatterns = [
    path(
        "publisher-landing-page/",
        campaign_views.publisher_landing_page,
        name="publisher_landing_page",
    ),
    path(
        "add-campaign-details/",
        campaign_views.add_campaign_details,
        name="add_campaign_details",
    ),
    path(
        "campaigns/",
        campaign_views.campaign_list,
        name="campaign_list",
    ),
    path(
        "campaigns/<str:campaign_id>/edit/",
        campaign_views.edit_campaign_details,
        name="edit_campaign_details",
    ),
    # APIs for search + selection expansion
    path(
        "publisher-api/search/",
        campaign_views.api_search_catalog,
        name="api_search_catalog",
    ),
    path(
        "publisher-api/expand-selection/",
        campaign_views.api_expand_selection,
        name="api_expand_selection",
    ),
    path("field-rep-landing-page/", campaign_views.field_rep_landing_page, name="field_rep_landing_page"),

]

================================================================================
FILE: publisher/urls.py
================================================================================

from django.urls import path
from . import views

app_name = "publisher"

urlpatterns = [
    path("", views.dashboard, name="dashboard"),

    # Therapy Areas
    path("therapy-areas/", views.therapy_list, name="therapy_list"),
    path("therapy-areas/new/", views.therapy_create, name="therapy_create"),
    path("therapy-areas/<int:pk>/", views.therapy_edit, name="therapy_edit"),

    # Trigger Clusters
    path("trigger-clusters/", views.trigger_cluster_list, name="triggercluster_list"),
    path("trigger-clusters/new/", views.trigger_cluster_create, name="triggercluster_create"),
    path("trigger-clusters/<int:pk>/", views.trigger_cluster_edit, name="triggercluster_edit"),

    # Triggers
    path("triggers/", views.trigger_list, name="trigger_list"),
    path("triggers/new/", views.trigger_create, name="trigger_create"),
    path("triggers/<int:pk>/", views.trigger_edit, name="trigger_edit"),

    # Videos
    path("videos/", views.video_list, name="video_list"),
    path("videos/new/", views.video_create, name="video_create"),
    path("videos/<int:pk>/", views.video_edit, name="video_edit"),

    # Bundles (Video Clusters)
    path("bundles/", views.cluster_list, name="cluster_list"),
    path("bundles/new/", views.cluster_create, name="cluster_create"),
    path("bundles/<int:pk>/", views.cluster_edit, name="cluster_edit"),

    # Trigger Maps
    path("trigger-maps/", views.map_list, name="map_list"),
    path("trigger-maps/new/", views.map_create, name="map_create"),
    path("trigger-maps/<int:pk>/", views.map_edit, name="map_edit"),
]

================================================================================
FILE: publisher/views.py
================================================================================

from __future__ import annotations

from django.contrib import messages
from django.contrib.admin.views.decorators import staff_member_required
from django.db import transaction
from django.db.models import Q
from django.shortcuts import get_object_or_404, redirect, render

from catalog.models import (
    TherapyArea,
    Trigger,
    TriggerCluster,
    Video,
    VideoCluster,
    VideoTriggerMap,
    VideoClusterVideo,
)
from publisher.forms import (
    BundleTriggerMapForm,
    TherapyAreaForm,
    TriggerClusterForm,
    TriggerForm,
    VideoClusterForm,
    VideoForm,
    VideoTriggerMapForm,  # legacy, retained
    make_cluster_language_formset,
    make_cluster_video_formset,
    make_video_language_formset,
)


@staff_member_required
def dashboard(request):
    return render(request, "publisher/dashboard.html")


# ---------------------------
# Therapy Areas
# ---------------------------
@staff_member_required
def therapy_list(request):
    q = (request.GET.get("q") or "").strip()
    rows = TherapyArea.objects.all().order_by("display_name", "code")
    if q:
        rows = rows.filter(Q(code__icontains=q) | Q(display_name__icontains=q))
    return render(request, "publisher/therapy_list.html", {"rows": rows, "q": q})


@staff_member_required
def therapy_create(request):
    if request.method == "POST":
        form = TherapyAreaForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Therapy area created.")
            return redirect("publisher:therapy_list")
    else:
        form = TherapyAreaForm()
    return render(request, "publisher/therapy_form.html", {"form": form, "object": None})


@staff_member_required
def therapy_edit(request, pk):
    obj = get_object_or_404(TherapyArea, pk=pk)
    if request.method == "POST":
        form = TherapyAreaForm(request.POST, instance=obj)
        if form.is_valid():
            form.save()
            messages.success(request, "Therapy area updated.")
            return redirect("publisher:therapy_list")
    else:
        form = TherapyAreaForm(instance=obj)
    return render(request, "publisher/therapy_form.html", {"form": form, "object": obj})


# ---------------------------
# Trigger Clusters
# ---------------------------
@staff_member_required
def trigger_cluster_list(request):
    q = (request.GET.get("q") or "").strip()
    rows = TriggerCluster.objects.all().order_by("display_name", "code")
    if q:
        rows = rows.filter(Q(code__icontains=q) | Q(display_name__icontains=q))
    return render(request, "publisher/trigger_cluster_list.html", {"rows": rows, "q": q})


@staff_member_required
def trigger_cluster_create(request):
    if request.method == "POST":
        form = TriggerClusterForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Trigger cluster created.")
            return redirect("publisher:triggercluster_list")
    else:
        form = TriggerClusterForm()
    return render(request, "publisher/triggercluster_form.html", {"form": form, "object": None})


@staff_member_required
def trigger_cluster_edit(request, pk):
    obj = get_object_or_404(TriggerCluster, pk=pk)
    if request.method == "POST":
        form = TriggerClusterForm(request.POST, instance=obj)
        if form.is_valid():
            form.save()
            messages.success(request, "Trigger cluster updated.")
            return redirect("publisher:triggercluster_list")
    else:
        form = TriggerClusterForm(instance=obj)
    return render(request, "publisher/triggercluster_form.html", {"form": form, "object": obj})


# ---------------------------
# Triggers
# ---------------------------
@staff_member_required
def trigger_list(request):
    q = (request.GET.get("q") or "").strip()
    rows = Trigger.objects.select_related("cluster", "primary_therapy").all().order_by("display_name", "code")
    if q:
        rows = rows.filter(Q(code__icontains=q) | Q(display_name__icontains=q))
    return render(request, "publisher/trigger_list.html", {"rows": rows, "q": q})


@staff_member_required
def trigger_create(request):
    if request.method == "POST":
        form = TriggerForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Trigger created.")
            return redirect("publisher:trigger_list")
    else:
        form = TriggerForm()
    return render(request, "publisher/trigger_form.html", {"form": form, "object": None})


@staff_member_required
def trigger_edit(request, pk):
    obj = get_object_or_404(Trigger, pk=pk)
    if request.method == "POST":
        form = TriggerForm(request.POST, instance=obj)
        if form.is_valid():
            form.save()
            messages.success(request, "Trigger updated.")
            return redirect("publisher:trigger_list")
    else:
        form = TriggerForm(instance=obj)
    return render(request, "publisher/trigger_form.html", {"form": form, "object": obj})


# ---------------------------
# Videos
# ---------------------------
@staff_member_required
def video_list(request):
    q = (request.GET.get("q") or "").strip()
    rows = Video.objects.all().order_by("code")
    if q:
        rows = rows.filter(Q(code__icontains=q))
    return render(request, "publisher/video_list.html", {"rows": rows, "q": q})


@staff_member_required
def video_create(request):
    FormSet = make_video_language_formset(extra=8)

    if request.method == "POST":
        form = VideoForm(request.POST)
        formset = FormSet(request.POST)

        if form.is_valid() and formset.is_valid():
            with transaction.atomic():
                video = form.save()

                clusters = list(form.cleaned_data.get("clusters") or [])
                for cluster in clusters:
                    VideoClusterVideo.objects.get_or_create(
                        video=video,
                        video_cluster=cluster,
                        defaults={"sort_order": 0},
                    )

                formset.instance = video
                formset.save()

            messages.success(request, "Video created.")
            return redirect("publisher:video_list")
    else:
        form = VideoForm()
        initial = [{"language_code": code} for code in ("en", "hi", "mr", "te", "ta", "bn", "ml", "kn")]
        formset = FormSet(initial=initial)

    return render(request, "publisher/video_form.html", {"form": form, "formset": formset, "object": None})


@staff_member_required
def video_edit(request, pk):
    video = get_object_or_404(Video, pk=pk)

    for code in ("en", "hi", "mr", "te", "ta", "bn", "ml", "kn"):
        video.languages.get_or_create(language_code=code, defaults={"title": "", "youtube_url": ""})

    FormSet = make_video_language_formset(extra=0)

    if request.method == "POST":
        form = VideoForm(request.POST, instance=video)
        formset = FormSet(request.POST, instance=video)

        if form.is_valid() and formset.is_valid():
            with transaction.atomic():
                form.save()
                formset.save()

                selected_clusters = list(form.cleaned_data.get("clusters") or [])
                selected_ids = {c.id for c in selected_clusters}
                existing_ids = set(video.clusters.values_list("id", flat=True))

                to_add = selected_ids - existing_ids
                to_remove = existing_ids - selected_ids

                if to_remove:
                    VideoClusterVideo.objects.filter(video=video, video_cluster_id__in=to_remove).delete()
                for cid in to_add:
                    VideoClusterVideo.objects.get_or_create(
                        video=video,
                        video_cluster_id=cid,
                        defaults={"sort_order": 0},
                    )

            messages.success(request, "Video updated.")
            return redirect("publisher:video_list")
    else:
        form = VideoForm(instance=video)
        formset = FormSet(instance=video)

    return render(request, "publisher/video_form.html", {"form": form, "formset": formset, "object": video})


# ---------------------------
# Bundles / Clusters
# ---------------------------
@staff_member_required
def cluster_list(request):
    q = (request.GET.get("q") or "").strip()
    rows = VideoCluster.objects.select_related("trigger").all().order_by("display_name", "code")
    if q:
        rows = rows.filter(Q(code__icontains=q) | Q(display_name__icontains=q))
    return render(request, "publisher/cluster_list.html", {"rows": rows, "q": q})


@staff_member_required
def cluster_create(request):
    # IMPORTANT: template expects lang_fs / vid_fs and cluster / is_new
    LangFS = make_cluster_language_formset(extra=8)
    VidFS = make_cluster_video_formset(extra=8)

    cluster = VideoCluster()

    if request.method == "POST":
        form = VideoClusterForm(request.POST)
        lang_fs = LangFS(request.POST, instance=cluster)
        vid_fs = VidFS(request.POST, instance=cluster)

        if form.is_valid() and lang_fs.is_valid() and vid_fs.is_valid():
            with transaction.atomic():
                cluster = form.save()
                lang_fs.instance = cluster
                vid_fs.instance = cluster
                lang_fs.save()
                vid_fs.save()

            messages.success(request, "Bundle created.")
            return redirect("publisher:cluster_list")
    else:
        form = VideoClusterForm()
        lang_fs = LangFS(instance=cluster)
        vid_fs = VidFS(instance=cluster)

    return render(
        request,
        "publisher/cluster_form.html",
        {
            "form": form,
            "cluster": cluster,
            "is_new": True,
            "lang_fs": lang_fs,
            "vid_fs": vid_fs,
            # Back-compat if any template still reads these
            "lang_formset": lang_fs,
            "video_formset": vid_fs,
            "object": None,
        },
    )


@staff_member_required
def cluster_edit(request, pk):
    cluster = get_object_or_404(VideoCluster, pk=pk)

    LangFS = make_cluster_language_formset(extra=5)
    VidFS = make_cluster_video_formset(extra=8)

    if request.method == "POST":
        form = VideoClusterForm(request.POST, instance=cluster)
        lang_fs = LangFS(request.POST, instance=cluster)
        vid_fs = VidFS(request.POST, instance=cluster)

        if form.is_valid() and lang_fs.is_valid() and vid_fs.is_valid():
            with transaction.atomic():
                form.save()
                lang_fs.save()
                vid_fs.save()

            messages.success(request, "Bundle updated.")
            return redirect("publisher:cluster_list")
    else:
        form = VideoClusterForm(instance=cluster)
        lang_fs = LangFS(instance=cluster)
        vid_fs = VidFS(instance=cluster)

    return render(
        request,
        "publisher/cluster_form.html",
        {
            "form": form,
            "cluster": cluster,
            "is_new": False,
            "lang_fs": lang_fs,
            "vid_fs": vid_fs,
            "lang_formset": lang_fs,
            "video_formset": vid_fs,
            "object": cluster,
        },
    )


# ---------------------------
# Bundle Trigger Maps (replaces Video Trigger Maps)
# ---------------------------
@staff_member_required
def map_list(request):
    q = (request.GET.get("q") or "").strip()

    bundles = VideoCluster.objects.select_related("trigger", "trigger__primary_therapy").all().order_by("display_name", "code")
    if q:
        bundles = bundles.filter(
            Q(code__icontains=q)
            | Q(display_name__icontains=q)
            | Q(trigger__code__icontains=q)
            | Q(trigger__display_name__icontains=q)
        )

    return render(request, "publisher/map_list.html", {"items": bundles, "q": q})


@staff_member_required
def map_create(request):
    if request.method == "POST":
        form = BundleTriggerMapForm(request.POST)
        if form.is_valid():
            bundle = form.cleaned_data["bundle"]
            trigger = form.cleaned_data["trigger"]
            bundle.trigger = trigger
            bundle.save(update_fields=["trigger"])
            messages.success(request, "Bundle trigger mapping saved.")
            return redirect("publisher:map_list")
    else:
        form = BundleTriggerMapForm()

    return render(request, "publisher/map_form.html", {"form": form, "object": None})


@staff_member_required
def map_edit(request, pk):
    bundle = get_object_or_404(VideoCluster, pk=pk)

    if request.method == "POST":
        form = BundleTriggerMapForm(request.POST, bundle_instance=bundle)
        if form.is_valid():
            trigger = form.cleaned_data["trigger"]
            bundle.trigger = trigger
            bundle.save(update_fields=["trigger"])
            messages.success(request, "Bundle trigger mapping updated.")
            return redirect("publisher:map_list")
    else:
        form = BundleTriggerMapForm(bundle_instance=bundle, initial={"trigger": bundle.trigger_id})

    return render(request, "publisher/map_form.html", {"form": form, "object": bundle})


@staff_member_required
def legacy_video_trigger_map_list(request):
    q = (request.GET.get("q") or "").strip()
    items = VideoTriggerMap.objects.select_related("trigger", "video").all().order_by("trigger__code", "video__code")
    if q:
        items = items.filter(Q(video__code__icontains=q) | Q(trigger__code__icontains=q))
    return render(request, "publisher/map_list.html", {"rows": items, "q": q})

================================================================================
FILE: publisher/templates/publisher/trigger_list.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>Triggers</h2>

  <form method="get" style="margin-bottom:12px;">
    <input name="q" value="{{ q }}" placeholder="Search trigger code/keywords" />
    <button type="submit">Search</button>
    <a href="{% url 'publisher:trigger_create' %}" style="margin-left:12px;">+ New trigger</a>
  </form>

  <table border="1" cellpadding="8" cellspacing="0" style="width:100%;">
    <tr>
      <th>Code</th>
      <th>Cluster</th>
      <th>Therapy</th>
      <th>Doctor label</th>
      <th>Active</th>
      <th>Action</th>
    </tr>
    {% for r in rows %}
      <tr>
        <td>{{ r.code }}</td>
        <td>{{ r.cluster.display_name }}</td>
        <td>{{ r.primary_therapy.display_name }}</td>
        <td>{{ r.doctor_trigger_label }}</td>
        <td>{{ r.is_active }}</td>
        <td><a href="{% url 'publisher:trigger_edit' r.pk %}">Edit</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="6">No triggers found.</td></tr>
    {% endfor %}
  </table>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/campaign_list.html
================================================================================

{% extends "base.html" %}

{% block title %}Campaigns{% endblock %}
{% block header_title %}Campaigns{% endblock %}

{% block content %}
<div class="card">
  <h2>Campaigns</h2>

  <form method="get" style="margin-bottom: 12px;">
    <input name="q" value="{{ q }}" placeholder="Search campaign-id or cluster name" />
    <button type="submit">Search</button>
    <a class="btn btn-secondary" style="margin-left: 10px;"
       href="{% url 'campaign_publisher:publisher_landing_page' %}">
      Back to landing
    </a>
  </form>

  <table>
    <tr>
      <th>Campaign ID</th>
      <th>Video Cluster</th>
      <th>Doctors Supported</th>
      <th>Start</th>
      <th>End</th>
      <th>Action</th>
    </tr>

    {% for r in rows %}
      <tr>
        <td>{{ r.campaign_id }}</td>
        <td>{{ r.new_video_cluster_name }}</td>
        <td>{{ r.doctors_supported }}</td>
        <td>{{ r.start_date }}</td>
        <td>{{ r.end_date }}</td>
        <td>
          <a class="btn btn-secondary" href="{% url 'campaign_publisher:edit_campaign_details' r.campaign_id %}">
            Edit
          </a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="6">No campaigns found.</td></tr>
    {% endfor %}
  </table>
</div>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/field_rep_landing_page.html
================================================================================

{% extends "base.html" %}

{% block title %}Field Rep Landing{% endblock %}
{% block header_title %}Field Rep Landing{% endblock %}

{% block content %}
  <div class="card">
    <h2>Register doctor for campaign</h2>

    <p><strong>Campaign ID:</strong> {{ campaign_id }}</p>

    {% if campaign %}
      <p><strong>Campaign name:</strong> {{ campaign.new_video_cluster_name }}</p>
      <p><strong>Doctors registered:</strong> {{ enrolled_count }}{% if doctors_supported %} / {{ doctors_supported }}{% endif %}</p>
    {% endif %}

    {% if limit_reached %}
      <div class="message error" style="margin-top: 12px;">
        {{ limit_message }}
      </div>
    {% else %}
      <form method="post">
        {% csrf_token %}
        {% for field in form %}
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% if field.errors %}
            <div class="message error">{{ field.errors|striptags }}</div>
          {% endif %}
        {% endfor %}
        <div style="margin-top: 16px;">
          <button type="submit">Submit</button>
        </div>
      </form>
    {% endif %}
  </div>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/cluster_form.html
================================================================================

{% extends "base.html" %}

{% block content %}
  <h2>
    {% if is_new %}
      Add Bundle
    {% else %}
      Edit Bundle: {{ cluster.code }}
    {% endif %}
  </h2>

  <form method="post">
    {% csrf_token %}

    <fieldset style="margin-bottom: 18px;">
      <legend>Bundle Details</legend>

      {% if form.non_field_errors %}
        <div style="color:#b00020; margin:8px 0;">{{ form.non_field_errors }}</div>
      {% endif %}

      <div style="margin:10px 0;">
        <label>Code:</label><br>
        {{ form.code }} {{ form.code.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Display name:</label><br>
        {{ form.display_name }} {{ form.display_name.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Description:</label><br>
        {{ form.description }} {{ form.description.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Trigger:</label><br>
        {{ form.trigger }} {{ form.trigger.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Is published:</label>
        {{ form.is_published }} {{ form.is_published.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Is active:</label>
        {{ form.is_active }} {{ form.is_active.errors }}
      </div>
    </fieldset>

    <fieldset style="margin-bottom: 18px;">
      <legend>Bundle Names (per language)</legend>

      {{ lang_fs.management_form }}

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Language</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Name</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Delete?</th>
          </tr>
        </thead>
        <tbody>
          {% for f in lang_fs.forms %}
            <tr>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {{ f.language_code }}
                {{ f.language_code.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {{ f.name }}
                {{ f.name.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {% if f.DELETE %}{{ f.DELETE }}{% endif %}
              </td>
            </tr>
            {% if f.non_field_errors %}
              <tr>
                <td colspan="3" style="padding:8px; border:1px solid #e5e7eb; color:#b00020;">
                  {{ f.non_field_errors }}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </fieldset>

    <fieldset style="margin-bottom: 18px;">
      <legend>Videos in this Bundle</legend>

      {{ vid_fs.management_form }}

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Video</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Sort order</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Delete?</th>
          </tr>
        </thead>
        <tbody>
          {% for f in vid_fs.forms %}
            <tr>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                <input type="text"
                       class="video-filter"
                       data-target="{{ f.video.id_for_label }}"
                       placeholder="Type to filter videos..."
                       style="width:100%; margin-bottom:8px; padding:8px; border:1px solid #d1d5db; border-radius:8px;">
                {{ f.video }}
                {{ f.video.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {{ f.sort_order }}
                {{ f.sort_order.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {% if f.DELETE %}{{ f.DELETE }}{% endif %}
              </td>
            </tr>
            {% if f.non_field_errors %}
              <tr>
                <td colspan="3" style="padding:8px; border:1px solid #e5e7eb; color:#b00020;">
                  {{ f.non_field_errors }}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:10px; color:#6b7280; font-size:13px;">
        Tip: Start typing above a dropdown to filter its video options.
      </div>
    </fieldset>

    <button type="submit">Save</button>
    <a href="{% url 'publisher:cluster_list' %}" style="margin-left: 12px;">Back</a>
  </form>

  <script>
  (function() {
    // Build an option cache per select
    const selectCache = new Map();

    function cacheSelect(selectEl) {
      if (!selectEl || selectCache.has(selectEl)) return;
      const opts = Array.from(selectEl.options).map(o => ({ value: o.value, text: o.text }));
      selectCache.set(selectEl, opts);
    }

    function applyFilter(selectEl, query) {
      cacheSelect(selectEl);
      const all = selectCache.get(selectEl) || [];
      const q = (query || "").toLowerCase().trim();

      const current = selectEl.value;

      const filtered = q
        ? all.filter(o => (o.text || "").toLowerCase().includes(q))
        : all;

      // Rebuild options
      selectEl.innerHTML = "";
      filtered.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.text;
        selectEl.appendChild(opt);
      });

      // Restore selection if still present
      if (filtered.some(o => o.value === current)) {
        selectEl.value = current;
      } else {
        // If current is not present, keep first option selected
        selectEl.selectedIndex = 0;
      }
    }

    // Hook all video selects
    document.querySelectorAll("select.video-select").forEach(cacheSelect);

    // Connect filter inputs
    document.querySelectorAll("input.video-filter").forEach(inp => {
      const targetId = inp.getAttribute("data-target");
      const selectEl = targetId ? document.getElementById(targetId) : null;
      if (!selectEl) return;

      cacheSelect(selectEl);

      inp.addEventListener("input", () => {
        applyFilter(selectEl, inp.value);
      });
    });
  })();
  </script>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/triggercluster_form.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>{% if is_new %}New trigger cluster{% else %}Edit trigger cluster{% endif %}</h2>

  <form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div style="color:#b00020;">{{ form.non_field_errors }}</div>
    {% endif %}

    {{ form.as_p }}

    <button type="submit">Save</button>
    <a href="{% url 'publisher:triggercluster_list' %}" style="margin-left:12px;">Back</a>
  </form>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/trigger_form.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>{% if is_new %}New trigger{% else %}Edit trigger{% endif %}</h2>

  <form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div style="color:#b00020;">{{ form.non_field_errors }}</div>
    {% endif %}

    {{ form.as_p }}

    <button type="submit">Save</button>
    <a href="{% url 'publisher:trigger_list' %}" style="margin-left:12px;">Back</a>
  </form>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/trigger_cluster_list.html
================================================================================

{% extends "publisher/triggercluster_list.html" %}

================================================================================
FILE: publisher/templates/publisher/edit_campaign_details.html
================================================================================

{% extends "base.html" %}

{% block title %}Edit Campaign{% endblock %}
{% block header_title %}Edit Campaign{% endblock %}

{% block content %}
<div class="card">
  <h2>Edit Campaign</h2>
  <p><strong>Campaign ID:</strong> {{ campaign.campaign_id }}</p>

  <div class="muted" style="margin-bottom: 10px;">
    Existing banners:
    {% if campaign.banner_small %}<div>Small: <a href="{{ campaign.banner_small.url }}" target="_blank">{{ campaign.banner_small.name }}</a></div>{% endif %}
    {% if campaign.banner_large %}<div>Large: <a href="{{ campaign.banner_large.url }}" target="_blank">{{ campaign.banner_large.name }}</a></div>{% endif %}
  </div>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="message error">{{ form.non_field_errors }}</div>
    {% endif %}

    {{ form.campaign_id }}

    <div style="margin-top: 12px;">
      <label for="{{ form.new_video_cluster_name.id_for_label }}">{{ form.new_video_cluster_name.label }}</label>
      {{ form.new_video_cluster_name }}
      {% if form.new_video_cluster_name.errors %}
        <div class="message error">{{ form.new_video_cluster_name.errors }}</div>
      {% endif %}
    </div>

    <hr>
    <h3>Selection</h3>

    <div style="margin-top: 10px;">
      <label for="searchInput">Search videos or clusters</label>
      <input id="searchInput" type="text" placeholder="Type keywords or video/cluster name..." autocomplete="off" />
    </div>

    <div id="searchResults" style="margin-top: 10px;"></div>

    <div style="margin-top: 16px;">
      <h4>Selected items</h4>
      <div id="selectedItems" class="muted">No selections yet.</div>
    </div>

    {{ form.selected_items_json }}

    <div style="margin-top: 16px;">
      <h4>Selected videos (expanded)</h4>
      <div id="expandedVideos" class="muted">Loading...</div>
      {% if form.selected_items_json.errors %}
        <div class="message error">{{ form.selected_items_json.errors }}</div>
      {% endif %}
    </div>

    <hr>

    <div class="row two">
      <div>
        <label for="{{ form.doctors_supported.id_for_label }}">{{ form.doctors_supported.label }}</label>
        {{ form.doctors_supported }}
        {% if form.doctors_supported.errors %}
          <div class="message error">{{ form.doctors_supported.errors }}</div>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.banner_target_url.id_for_label }}">{{ form.banner_target_url.label }}</label>
        {{ form.banner_target_url }}
        {% if form.banner_target_url.errors %}
          <div class="message error">{{ form.banner_target_url.errors }}</div>
        {% endif %}
      </div>
    </div>

    {# --- NEW FIELDS --- #}
    <div style="margin-top: 14px;">
      <label for="{{ form.email_registration.id_for_label }}">{{ form.email_registration.label }}</label>
      {{ form.email_registration }}
      {% if form.email_registration.errors %}
        <div class="message error">{{ form.email_registration.errors }}</div>
      {% endif %}
    </div>

    <div style="margin-top: 14px;">
      <label for="{{ form.wa_addition.id_for_label }}">{{ form.wa_addition.label }}</label>
      {{ form.wa_addition }}
      {% if form.wa_addition.errors %}
        <div class="message error">{{ form.wa_addition.errors }}</div>
      {% endif %}
    </div>
    {# ------------------ #}

    <div class="row two" style="margin-top: 14px;">
      <div>
        <label for="{{ form.banner_small.id_for_label }}">{{ form.banner_small.label }}</label>
        {{ form.banner_small }}
      </div>

      <div>
        <label for="{{ form.banner_large.id_for_label }}">{{ form.banner_large.label }}</label>
        {{ form.banner_large }}
      </div>
    </div>

    <div class="row two" style="margin-top: 14px;">
      <div>
        <label for="{{ form.start_date.id_for_label }}">{{ form.start_date.label }}</label>
        {{ form.start_date }}
        {% if form.start_date.errors %}
          <div class="message error">{{ form.start_date.errors }}</div>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.end_date.id_for_label }}">{{ form.end_date.label }}</label>
        {{ form.end_date }}
        {% if form.end_date.errors %}
          <div class="message error">{{ form.end_date.errors }}</div>
        {% endif %}
      </div>
    </div>

    <div style="margin-top: 18px;">
      <button type="submit">Save</button>
      <a class="btn btn-secondary" style="margin-left: 10px;"
         href="{% url 'campaign_publisher:campaign_list' %}">
        Back
      </a>
    </div>
  </form>
</div>

<script>
/* Identical JS to add_campaign_details.html, reused inline for simplicity */
(function() {
  const searchUrl = "{% url 'campaign_publisher:api_search_catalog' %}";
  const expandUrl = "{% url 'campaign_publisher:api_expand_selection' %}";

  const searchInput = document.getElementById("searchInput");
  const resultsDiv = document.getElementById("searchResults");
  const selectedDiv = document.getElementById("selectedItems");
  const expandedDiv = document.getElementById("expandedVideos");

  const hidden = document.getElementById("id_selected_items_json");

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  let selectedItems = [];
  try {
    selectedItems = JSON.parse(hidden.value || "[]");
    if (!Array.isArray(selectedItems)) selectedItems = [];
  } catch(e) {
    selectedItems = [];
  }

  function syncHidden() { hidden.value = JSON.stringify(selectedItems); }

  function renderSelectedItems() {
    if (!selectedItems.length) {
      selectedDiv.innerHTML = '<span class="muted">No selections yet.</span>';
      return;
    }
    const ul = document.createElement("ul");
    selectedItems.forEach((it, idx) => {
      const li = document.createElement("li");
      li.textContent = `${it.type} #${it.id} `;
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Remove";
      btn.style.marginLeft = "10px";
      btn.onclick = () => {
        selectedItems.splice(idx, 1);
        syncHidden();
        renderSelectedItems();
        refreshExpandedVideos();
      };
      li.appendChild(btn);
      ul.appendChild(li);
    });
    selectedDiv.innerHTML = "";
    selectedDiv.appendChild(ul);
  }

  async function refreshExpandedVideos() {
    if (!selectedItems.length) {
      expandedDiv.innerHTML = '<span class="muted">No videos selected yet.</span>';
      return;
    }

    expandedDiv.innerHTML = '<span class="muted">Loading...</span>';

    const resp = await fetch(expandUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({items: selectedItems})
    });

    if (!resp.ok) {
      expandedDiv.innerHTML = '<span class="muted">Unable to expand selection.</span>';
      return;
    }

    const data = await resp.json();
    const vids = (data && data.videos) ? data.videos : [];

    if (!vids.length) {
      expandedDiv.innerHTML = '<span class="muted">No videos found for selection.</span>';
      return;
    }

    const ul = document.createElement("ul");
    vids.forEach(v => {
      const li = document.createElement("li");
      li.textContent = `${v.code}, ${v.title}`;
      ul.appendChild(li);
    });
    expandedDiv.innerHTML = "";
    expandedDiv.appendChild(ul);
  }

  function addItem(type, id) {
    const exists = selectedItems.some(x => x.type === type && String(x.id) === String(id));
    if (exists) return;
    selectedItems.push({type: type, id: id});
    syncHidden();
    renderSelectedItems();
    refreshExpandedVideos();
  }

  let debounceTimer = null;
  searchInput.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const q = (searchInput.value || "").trim();
      if (q.length < 2) { resultsDiv.innerHTML = ""; return; }

      const resp = await fetch(searchUrl + "?q=" + encodeURIComponent(q));
      if (!resp.ok) { resultsDiv.innerHTML = '<div class="muted">Search failed.</div>'; return; }

      const data = await resp.json();
      const results = (data && data.results) ? data.results : [];

      if (!results.length) { resultsDiv.innerHTML = '<div class="muted">No matches.</div>'; return; }

      const wrap = document.createElement("div");
      results.forEach(r => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "12px";
        row.style.padding = "10px 12px";
        row.style.border = "1px solid rgba(0,0,0,0.08)";
        row.style.borderRadius = "10px";
        row.style.marginBottom = "8px";

        const label = document.createElement("div");
        const kind = (r.type === "cluster") ? "Cluster" : "Video";
        label.innerHTML = `<strong>[${kind}]</strong> ${r.code} - ${r.title}`;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "Add";
        btn.onclick = () => addItem(r.type, r.id);

        row.appendChild(label);
        row.appendChild(btn);
        wrap.appendChild(row);
      });

      resultsDiv.innerHTML = "";
      resultsDiv.appendChild(wrap);
    }, 250);
  });

  syncHidden();
  renderSelectedItems();
  refreshExpandedVideos();
})();
</script>

{% endblock %}

================================================================================
FILE: publisher/templates/publisher/cluster_list.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>Video Bundles</h2>

  <form method="get" style="margin-bottom:12px;">
    <input name="q" value="{{ q }}" placeholder="Search by code/keywords" />
    <button type="submit">Search</button>
    <a href="{% url 'publisher:cluster_create' %}" style="margin-left:12px;">+ New Bundle</a>
  </form>

  <table border="1" cellpadding="8" cellspacing="0">
    <tr>
      <th>Code</th>
      <th>Name</th>
      <th>Trigger</th>
      <th>Published</th>
      <th>Active</th>
      <th>Action</th>
    </tr>

    {% for r in rows %}
      <tr>
        <td>{{ r.code }}</td>
        <td>{{ r.display_name }}</td>
        <td>{% if r.trigger %}{{ r.trigger.display_name }}{% else %}-{% endif %}</td>
        <td>{{ r.is_published }}</td>
        <td>{{ r.is_active }}</td>
        <td><a href="{% url 'publisher:cluster_edit' r.pk %}">Edit</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="6">No bundles found.</td></tr>
    {% endfor %}
  </table>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/triggercluster_list.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>Trigger clusters</h2>

  <form method="get" style="margin-bottom:12px;">
    <input name="q" value="{{ q }}" placeholder="Search by code/name" />
    <button type="submit">Search</button>
    <a href="{% url 'publisher:triggercluster_create' %}" style="margin-left:12px;">+ New trigger cluster</a>
  </form>

  <table border="1" cellpadding="8" cellspacing="0" style="width:100%;">
    <tr>
      <th>Code</th>
      <th>Name</th>
      <th>Sort</th>
      <th>Active</th>
      <th>Action</th>
    </tr>
    {% for r in rows %}
      <tr>
        <td>{{ r.code }}</td>
        <td>{{ r.display_name }}</td>
        <td>{{ r.sort_order }}</td>
        <td>{{ r.is_active }}</td>
        <td><a href="{% url 'publisher:triggercluster_edit' r.pk %}">Edit</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="5">No trigger clusters found.</td></tr>
    {% endfor %}
  </table>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/dashboard.html
================================================================================

{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Publishing Dashboard</h2>
  <p class="muted" style="margin-bottom: 24px;">Manage all content for patient education system</p>
  
  <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
    <div class="card" style="border: 2px solid var(--border); transition: all 0.3s ease;">
      <h3 style="color: var(--primary); margin-bottom: 12px;">📚 Content Types</h3>
      <ul style="list-style: none; padding: 0; margin: 0;">
        <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid var(--border);">
          <a href="{% url 'publisher:therapy_list' %}" style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
            <span style="background: var(--surface-2); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">📁</span>
            Therapy Areas
          </a>
        </li>
        <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid var(--border);">
          <a href="{% url 'publisher:triggercluster_list' %}" style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
            <span style="background: var(--surface-2); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">🏷️</span>
            Trigger Clusters
          </a>
        </li>
        <li style="margin: 8px 0; padding: 8px 0;">
          <a href="{% url 'publisher:trigger_list' %}" style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
            <span style="background: var(--surface-2); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">🎯</span>
            Triggers
          </a>
        </li>
      </ul>
    </div>
    
    <div class="card" style="border: 2px solid var(--border); transition: all 0.3s ease;">
      <h3 style="color: var(--primary); margin-bottom: 12px;">🎬 Media & Organization</h3>
      <ul style="list-style: none; padding: 0; margin: 0;">
        <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid var(--border);">
          <a href="{% url 'publisher:video_list' %}" style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
            <span style="background: var(--surface-2); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">📹</span>
            Videos
          </a>
        </li>
        <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid var(--border);">
          <a href="{% url 'publisher:cluster_list' %}" style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
            <span style="background: var(--surface-2); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">📦</span>
            Video Bundles
          </a>
        </li>
        <li style="margin: 8px 0; padding: 8px 0;">
          <a href="{% url 'publisher:map_list' %}" style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
            <span style="background: var(--surface-2); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">🗺️</span>
            Bundle Trigger Maps
          </a>
        </li>
      </ul>
    </div>
  </div>
  
  <div class="card" style="margin-top: 24px; background: linear-gradient(135deg, var(--surface-2), transparent);">
    <h3 style="margin-bottom: 12px;">🚀 Quick Actions</h3>
    <div class="row three" style="gap: 16px; margin-top: 16px;">
      <a href="{% url 'publisher:video_create' %}" class="btn" style="width: 100%; justify-content: center;">
        ➕ Add New Video
      </a>
      <a href="{% url 'publisher:cluster_create' %}" class="btn btn-secondary" style="width: 100%; justify-content: center;">
        📦 Create Bundle
      </a>
      <a href="{% url 'publisher:map_create' %}" class="btn btn-secondary" style="width: 100%; justify-content: center;">
        🗺️ Create Map
      </a>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
FILE: publisher/templates/publisher/video_form.html
================================================================================

{% extends "base.html" %}
{% block title %}{% if object %}Edit Video{% else %}Add Video{% endif %}{% endblock %}
{% block header_title %}Patient Education{% endblock %}

{% block content %}
<div class="card">
  <h2>{% if object %}Edit Video{% else %}Add Video{% endif %}</h2>

  <p style="margin-top: 6px; color: #6b7280;">
    Note: A video cannot exist standalone. It must be part of at least one bundle/cluster.
    If the required bundle does not exist yet, create it first and then return here.
    <a href="{% url 'publisher:cluster_create' %}" style="margin-left: 8px;">+ Create Bundle</a>
    <a href="{% url 'publisher:cluster_list' %}" style="margin-left: 8px;">View Bundles</a>
  </p>

  {% if object %}
    <div class="card" style="margin: 14px 0; background: #f9fafb;">
      <strong>Bundles this video is part of:</strong>
      <div style="margin-top: 8px;">
        {% if object.clusters.all %}
          <ul style="margin: 0; padding-left: 18px;">
            {% for b in object.clusters.all %}
              <li>{{ b.code }} — {{ b.display_name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <span style="color: #6b7280;">None</span>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}

    <h3>Language Details (all languages required)</h3>
    <table class="table">
      <tr><th>Language Code</th><th>Title</th><th>YouTube URL</th></tr>
      {% for f in formset.forms %}
      <tr>
        <td>{{ f.language_code }}</td>
        <td>{{ f.title }}</td>
        <td>{{ f.youtube_url }}</td>
      </tr>
      {% endfor %}
    </table>

    <button class="btn" type="submit">Save</button>
    <a class="btn btn-secondary" href="{% url 'publisher:video_list' %}">Back</a>
  </form>
</div>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/therapy_list.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>Therapy areas</h2>

  <form method="get" style="margin-bottom:12px;">
    <input name="q" value="{{ q }}" placeholder="Search by code/name" />
    <button type="submit">Search</button>
    <a href="{% url 'publisher:therapy_create' %}" style="margin-left:12px;">+ New therapy area</a>
  </form>

  <table border="1" cellpadding="8" cellspacing="0" style="width:100%;">
    <tr>
      <th>Code</th>
      <th>Name</th>
      <th>Sort</th>
      <th>Active</th>
      <th>Action</th>
    </tr>
    {% for r in rows %}
      <tr>
        <td>{{ r.code }}</td>
        <td>{{ r.display_name }}</td>
        <td>{{ r.sort_order }}</td>
        <td>{{ r.is_active }}</td>
        <td><a href="{% url 'publisher:therapy_edit' r.pk %}">Edit</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="5">No therapy areas found.</td></tr>
    {% endfor %}
  </table>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/map_form.html
================================================================================

{% extends "base.html" %}
{% block title %}Bundle Trigger Map{% endblock %}
{% block header_title %}Publisher{% endblock %}

{% block content %}
<div class="card">
  <h2>{% if object %}Edit Bundle Trigger Map{% else %}New Bundle Trigger Map{% endif %}</h2>

  <p style="color:#6b7280; margin-top: 6px;">
    This updates the bundle's <strong>Trigger</strong>. The doctor share page uses Therapy Area → Trigger → Bundle filtering.
  </p>

  {% if object %}
    <div class="card" style="margin: 14px 0; background: #f9fafb;">
      <strong>Bundle:</strong> {{ object.code }} — {{ object.display_name }}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn" type="submit">Save</button>
    <a class="btn btn-secondary" href="{% url 'publisher:map_list' %}">Back</a>
  </form>
</div>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/publisher_landing_page.html
================================================================================

{% extends "base.html" %}

{% block title %}Publisher Landing{% endblock %}
{% block header_title %}Campaign Publishing{% endblock %}

{% block content %}
<div class="card">
  <h2>Publisher Landing Page</h2>

  <p class="muted">
    Authenticated publisher:
    <strong>{{ publisher.username }}</strong>
    {% if publisher.sub %} ({{ publisher.sub }}){% endif %}
  </p>

  {% if campaign_id %}
    <p><strong>Campaign ID:</strong> {{ campaign_id }}</p>

    {% if campaign_meta %}
      <div class="card" style="margin-top: 16px;">
        <h2>Campaign details from Project1</h2>
        <p><strong>Number of doctors supported:</strong> {{ campaign_meta.num_doctors_supported }}</p>
        <p><strong>Name:</strong> {{ campaign_meta.name }}</p>
        <p><strong>Company name:</strong> {{ campaign_meta.company_name }}</p>
        <p><strong>Contact person:</strong> {{ campaign_meta.contact_person_name }}</p>
        <p><strong>Contact phone:</strong> {{ campaign_meta.contact_person_phone }}</p>
        <p><strong>Contact email:</strong> {{ campaign_meta.contact_person_email }}</p>
      </div>
    {% endif %}

  {% else %}
    <p class="muted">
      No campaign-id was provided in the link. You can still edit existing campaigns.
    </p>
  {% endif %}

  <div class="row two" style="margin-top: 16px;">
    <div>
      {% if campaign_id %}
        <a class="btn" href="{% url 'campaign_publisher:add_campaign_details' %}?campaign-id={{ campaign_id|urlencode }}">
          Add details for this campaign
        </a>
      {% else %}
        <button class="btn" disabled>Add details for this campaign</button>
      {% endif %}
    </div>

    <div>
      <a class="btn btn-secondary" href="{% url 'campaign_publisher:campaign_list' %}">
        Edit details for any other campaign
      </a>
    </div>
  </div>
</div>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/video_list.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>Videos</h2>

  <form method="get" style="margin-bottom:12px;">
    <input name="q" value="{{ q }}" placeholder="Search by code/keywords" />
    <button type="submit">Search</button>
    <a href="{% url 'publisher:video_create' %}" style="margin-left:12px;">+ New Video</a>
  </form>

  <table border="1" cellpadding="8" cellspacing="0">
    <tr>
      <th>Code</th>
      <th>Published</th>
      <th>Active</th>
      <th>Action</th>
    </tr>

    {% for r in rows %}
      <tr>
        <td>{{ r.code }}</td>
        <td>{{ r.is_published }}</td>
        <td>{{ r.is_active }}</td>
        <td><a href="{% url 'publisher:video_edit' r.pk %}">Edit</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="4">No videos found.</td></tr>
    {% endfor %}
  </table>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/map_list.html
================================================================================

{% extends "base.html" %}
{% block title %}Bundle Trigger Maps{% endblock %}
{% block header_title %}Publisher{% endblock %}

{% block content %}
<div class="card">
  <h2>Bundle Trigger Maps</h2>
  <p style="color:#6b7280; margin-top: 6px;">
    This page maps <strong>Triggers</strong> to <strong>Bundles (Video Clusters)</strong>.
    Filtering on the doctor share page uses these mappings.
  </p>

  <div style="margin-top: 14px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
    <form method="get" style="display:flex; gap: 8px; align-items:center;">
      <input name="q" value="{{ q|default:'' }}" placeholder="Search bundle or trigger…" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; min-width: 260px;">
      <button class="btn btn-secondary" type="submit">Search</button>
      {% if q %}
        <a class="btn btn-secondary" href="{% url 'publisher:map_list' %}">Clear</a>
      {% endif %}
    </form>

    <a class="btn" href="{% url 'publisher:map_create' %}" style="margin-left: auto;">+ New Mapping</a>
  </div>

  <table class="table" style="margin-top: 14px;">
    <tr>
      <th>Bundle Code</th>
      <th>Bundle Name</th>
      <th>Therapy Area</th>
      <th>Trigger</th>
      <th style="width: 220px;">Actions</th>
    </tr>

    {% for b in items %}
      <tr>
        <td>{{ b.code }}</td>
        <td>{{ b.display_name }}</td>
        <td>
          {% if b.trigger.primary_therapy %}
            {{ b.trigger.primary_therapy.display_name }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>{{ b.trigger.display_name }} ({{ b.trigger.code }})</td>
        <td>
          <a href="{% url 'publisher:map_edit' b.id %}">Edit Mapping</a>
          &nbsp;|&nbsp;
          <a href="{% url 'publisher:cluster_edit' b.id %}">Edit Bundle</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="5" style="color:#6b7280;">No bundles found.</td></tr>
    {% endfor %}
  </table>

  <div style="margin-top: 14px;">
    <a class="btn btn-secondary" href="{% url 'publisher:dashboard' %}">Back</a>
  </div>
</div>
{% endblock %}

================================================================================
FILE: publisher/templates/publisher/add_campaign_details.html
================================================================================

{% extends "base.html" %}

{% block title %}Add Campaign Details{% endblock %}
{% block header_title %}Add Campaign Details{% endblock %}

{% block content %}
<div class="card">
  <h2>Add Campaign Details</h2>

  <p><strong>Campaign ID:</strong> {{ campaign_id }}</p>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="message error">{{ form.non_field_errors }}</div>
    {% endif %}

    {{ form.campaign_id }}

    <div style="margin-top: 12px;">
      <label for="{{ form.new_video_cluster_name.id_for_label }}">{{ form.new_video_cluster_name.label }}</label>
      {{ form.new_video_cluster_name }}
      {% if form.new_video_cluster_name.errors %}
        <div class="message error">{{ form.new_video_cluster_name.errors }}</div>
      {% endif %}
    </div>

    <hr>

    <h3>Select videos / video-clusters</h3>

    <div style="margin-top: 10px;">
      <label for="searchInput">Search videos or clusters</label>
      <input id="searchInput" type="text" placeholder="Type keywords or video/cluster name..." autocomplete="off" />
      <div class="muted" style="margin-top: 6px;">
        Start typing to see matches. Click “Add” to include items in this campaign.
      </div>
    </div>

    <div id="searchResults" style="margin-top: 10px;"></div>

    <div style="margin-top: 16px;">
      <h4>Selected items</h4>
      <div id="selectedItems" class="muted">No selections yet.</div>
    </div>

    {{ form.selected_items_json }}

    <div style="margin-top: 16px;">
      <h4>Selected videos (expanded)</h4>
      <div id="expandedVideos" class="muted">No videos selected yet.</div>
      {% if form.selected_items_json.errors %}
        <div class="message error">{{ form.selected_items_json.errors }}</div>
      {% endif %}
    </div>

    <hr>

    <div class="row two">
      <div>
        <label for="{{ form.doctors_supported.id_for_label }}">{{ form.doctors_supported.label }}</label>
        {{ form.doctors_supported }}
        {% if form.doctors_supported.errors %}
          <div class="message error">{{ form.doctors_supported.errors }}</div>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.banner_target_url.id_for_label }}">{{ form.banner_target_url.label }}</label>
        {{ form.banner_target_url }}
        {% if form.banner_target_url.errors %}
          <div class="message error">{{ form.banner_target_url.errors }}</div>
        {% endif %}
      </div>
    </div>

    {# --- NEW FIELDS --- #}
    <div style="margin-top: 14px;">
      <label for="{{ form.email_registration.id_for_label }}">{{ form.email_registration.label }}</label>
      {{ form.email_registration }}
      {% if form.email_registration.errors %}
        <div class="message error">{{ form.email_registration.errors }}</div>
      {% endif %}
    </div>

    <div style="margin-top: 14px;">
      <label for="{{ form.wa_addition.id_for_label }}">{{ form.wa_addition.label }}</label>
      {{ form.wa_addition }}
      {% if form.wa_addition.errors %}
        <div class="message error">{{ form.wa_addition.errors }}</div>
      {% endif %}
    </div>
    {# ------------------ #}

    <div class="row two" style="margin-top: 14px;">
      <div>
        <label for="{{ form.banner_small.id_for_label }}">{{ form.banner_small.label }}</label>
        {{ form.banner_small }}
        {% if form.banner_small.errors %}
          <div class="message error">{{ form.banner_small.errors }}</div>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.banner_large.id_for_label }}">{{ form.banner_large.label }}</label>
        {{ form.banner_large }}
        {% if form.banner_large.errors %}
          <div class="message error">{{ form.banner_large.errors }}</div>
        {% endif %}
      </div>
    </div>

    <div class="row two" style="margin-top: 14px;">
      <div>
        <label for="{{ form.start_date.id_for_label }}">{{ form.start_date.label }}</label>
        {{ form.start_date }}
        {% if form.start_date.errors %}
          <div class="message error">{{ form.start_date.errors }}</div>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.end_date.id_for_label }}">{{ form.end_date.label }}</label>
        {{ form.end_date }}
        {% if form.end_date.errors %}
          <div class="message error">{{ form.end_date.errors }}</div>
        {% endif %}
      </div>
    </div>

    <div style="margin-top: 18px;">
      <button type="submit">Save</button>
      <a class="btn btn-secondary" style="margin-left: 10px;"
         href="{% url 'campaign_publisher:publisher_landing_page' %}?campaign-id={{ campaign_id|urlencode }}">
        Back
      </a>
    </div>
  </form>
</div>

<script>
(function() {
  const searchUrl = "{% url 'campaign_publisher:api_search_catalog' %}";
  const expandUrl = "{% url 'campaign_publisher:api_expand_selection' %}";

  const searchInput = document.getElementById("searchInput");
  const resultsDiv = document.getElementById("searchResults");
  const selectedDiv = document.getElementById("selectedItems");
  const expandedDiv = document.getElementById("expandedVideos");

  const hidden = document.getElementById("id_selected_items_json");

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  let selectedItems = [];
  try {
    selectedItems = JSON.parse(hidden.value || "[]");
    if (!Array.isArray(selectedItems)) selectedItems = [];
  } catch(e) {
    selectedItems = [];
  }

  function syncHidden() {
    hidden.value = JSON.stringify(selectedItems);
  }

  function renderSelectedItems() {
    if (!selectedItems.length) {
      selectedDiv.innerHTML = '<span class="muted">No selections yet.</span>';
      return;
    }

    const ul = document.createElement("ul");
    selectedItems.forEach((it, idx) => {
      const li = document.createElement("li");
      li.textContent = `${it.type} #${it.id} `;
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Remove";
      btn.style.marginLeft = "10px";
      btn.onclick = () => {
        selectedItems.splice(idx, 1);
        syncHidden();
        renderSelectedItems();
        refreshExpandedVideos();
      };
      li.appendChild(btn);
      ul.appendChild(li);
    });
    selectedDiv.innerHTML = "";
    selectedDiv.appendChild(ul);
  }

  async function refreshExpandedVideos() {
    if (!selectedItems.length) {
      expandedDiv.innerHTML = '<span class="muted">No videos selected yet.</span>';
      return;
    }

    expandedDiv.innerHTML = '<span class="muted">Loading...</span>';

    const resp = await fetch(expandUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({items: selectedItems})
    });

    if (!resp.ok) {
      expandedDiv.innerHTML = '<span class="muted">Unable to expand selection.</span>';
      return;
    }

    const data = await resp.json();
    const vids = (data && data.videos) ? data.videos : [];

    if (!vids.length) {
      expandedDiv.innerHTML = '<span class="muted">No videos found for selection.</span>';
      return;
    }

    const ul = document.createElement("ul");
    vids.forEach(v => {
      const li = document.createElement("li");
      li.textContent = `${v.code}, ${v.title}`;
      ul.appendChild(li);
    });
    expandedDiv.innerHTML = "";
    expandedDiv.appendChild(ul);
  }

  function addItem(type, id) {
    const exists = selectedItems.some(x => x.type === type && String(x.id) === String(id));
    if (exists) return;
    selectedItems.push({type: type, id: id});
    syncHidden();
    renderSelectedItems();
    refreshExpandedVideos();
  }

  let debounceTimer = null;
  searchInput.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const q = (searchInput.value || "").trim();
      if (q.length < 2) {
        resultsDiv.innerHTML = "";
        return;
      }

      const resp = await fetch(searchUrl + "?q=" + encodeURIComponent(q));
      if (!resp.ok) {
        resultsDiv.innerHTML = '<div class="muted">Search failed.</div>';
        return;
      }

      const data = await resp.json();
      const results = (data && data.results) ? data.results : [];

      if (!results.length) {
        resultsDiv.innerHTML = '<div class="muted">No matches.</div>';
        return;
      }

      const wrap = document.createElement("div");
      results.forEach(r => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "12px";
        row.style.padding = "10px 12px";
        row.style.border = "1px solid rgba(0,0,0,0.08)";
        row.style.borderRadius = "10px";
        row.style.marginBottom = "8px";

        const label = document.createElement("div");
        const kind = (r.type === "cluster") ? "Cluster" : "Video";
        label.innerHTML = `<strong>[${kind}]</strong> ${r.code} - ${r.title}`;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "Add";
        btn.onclick = () => addItem(r.type, r.id);

        row.appendChild(label);
        row.appendChild(btn);
        wrap.appendChild(row);
      });

      resultsDiv.innerHTML = "";
      resultsDiv.appendChild(wrap);
    }, 250);
  });

  // Initial render
  syncHidden();
  renderSelectedItems();
  refreshExpandedVideos();
})();
</script>

{% endblock %}

================================================================================
FILE: publisher/templates/publisher/therapy_form.html
================================================================================

{% extends "base.html" %}
{% block content %}
  <h2>{% if is_new %}New therapy area{% else %}Edit therapy area{% endif %}</h2>

  <form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div style="color:#b00020;">{{ form.non_field_errors }}</div>
    {% endif %}

    {{ form.as_p }}

    <button type="submit">Save</button>
    <a href="{% url 'publisher:therapy_list' %}" style="margin-left:12px;">Back</a>
  </form>
{% endblock %}

================================================================================
FILE: catalog/signals.py
================================================================================

from django.core.cache import cache
from django.db.models.signals import post_delete, post_save
from django.dispatch import receiver

from .models import (
    TherapyArea,
    Trigger,
    TriggerCluster,
    Video,
    VideoCluster,
    VideoClusterVideo,
    VideoTriggerMap,
)

# IMPORTANT:
# Share page uses clinic_catalog_payload_v6 (previously v5).
# Old signal only deleted catalog_json_v1, causing stale payloads.
CATALOG_CACHE_KEYS = [
    "clinic_catalog_payload_v5",
    "clinic_catalog_payload_v6",
]


def clear_catalog_cache() -> None:
    """
    Clear all catalog payload caches to prevent stale
    bundles / topics / therapy areas on the share page.
    """
    for key in CATALOG_CACHE_KEYS:
        try:
            cache.delete(key)
        except Exception:
            pass


@receiver(post_save, sender=TherapyArea)
@receiver(post_delete, sender=TherapyArea)
@receiver(post_save, sender=TriggerCluster)
@receiver(post_delete, sender=TriggerCluster)
@receiver(post_save, sender=Trigger)
@receiver(post_delete, sender=Trigger)
@receiver(post_save, sender=VideoCluster)
@receiver(post_delete, sender=VideoCluster)
@receiver(post_save, sender=Video)
@receiver(post_delete, sender=Video)
@receiver(post_save, sender=VideoClusterVideo)
@receiver(post_delete, sender=VideoClusterVideo)
@receiver(post_save, sender=VideoTriggerMap)
@receiver(post_delete, sender=VideoTriggerMap)
def _on_catalog_change(*args, **kwargs):
    clear_catalog_cache()

================================================================================
FILE: catalog/models.py
================================================================================

from __future__ import annotations

from django.db import models
from django.utils.text import slugify

from .constants import LANGUAGES, DEFAULT_VIDEO_URL, DEFAULT_THUMBNAIL_URL


class TherapyArea(models.Model):
    code = models.CharField(max_length=50, unique=True)
    display_name = models.CharField(max_length=255)
    description = models.TextField(blank=True, default="")
    sort_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)

    @staticmethod
    def code_from_name(name: str) -> str:
        base = slugify((name or "").strip(), allow_unicode=False).replace("-", "_").upper()
        base = base.strip("_")
        return (base[:50] if base else "THERAPY")

    def __str__(self):
        return f"{self.code} - {self.display_name}"


class VideoCluster(models.Model):
    code = models.CharField(max_length=80, unique=True)
    display_name = models.CharField(max_length=255)
    description = models.TextField(blank=True, default="")
    trigger = models.ForeignKey(
        "Trigger",
        on_delete=models.PROTECT,
        related_name="video_clusters",
    )
    sort_order = models.IntegerField(default=0)
    is_published = models.BooleanField(default=False)
    search_keywords = models.TextField(blank=True, default="")
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.code} - {self.display_name}"


class Video(models.Model):
    code = models.CharField(max_length=80, unique=True)
    description = models.TextField(blank=True, default="")
    thumbnail_url = models.URLField(
        blank=True,
        default=DEFAULT_THUMBNAIL_URL,
        max_length=500,
    )
    primary_therapy = models.ForeignKey(
        TherapyArea,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="videos",
    )
    primary_trigger = models.ForeignKey(
        "Trigger",
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="primary_videos",
    )
    sort_order = models.IntegerField(default=0)
    is_published = models.BooleanField(default=False)
    search_keywords = models.TextField(blank=True, default="")
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    clusters = models.ManyToManyField(
        VideoCluster,
        through="VideoClusterVideo",
        related_name="videos",
        blank=True,
    )

    def __str__(self):
        return self.code


class VideoLanguage(models.Model):
    video = models.ForeignKey(
        Video,
        on_delete=models.CASCADE,
        related_name="languages",
    )
    language_code = models.CharField(max_length=10, choices=LANGUAGES)
    title = models.CharField(max_length=255)
    youtube_url = models.URLField(
        default=DEFAULT_VIDEO_URL,
        max_length=500,
    )

    class Meta:
        unique_together = ("video", "language_code")

    def __str__(self):
        return f"{self.video.code} [{self.language_code}] {self.title}"


class VideoClusterLanguage(models.Model):
    video_cluster = models.ForeignKey(
        VideoCluster,
        on_delete=models.CASCADE,
        related_name="languages",
    )
    language_code = models.CharField(max_length=10, choices=LANGUAGES)
    name = models.CharField(max_length=255)

    class Meta:
        unique_together = ("video_cluster", "language_code")

    def __str__(self):
        return f"{self.video_cluster.code} [{self.language_code}] {self.name}"


class Trigger(models.Model):
    code = models.CharField(max_length=80, unique=True)
    display_name = models.CharField(max_length=255)
    doctor_trigger_label = models.CharField(max_length=255, blank=True, default="")
    subtopic_title = models.CharField(max_length=255, blank=True, default="")
    navigation_pathways = models.TextField(blank=True, default="")
    search_keywords = models.TextField(blank=True, default="")
    cluster = models.ForeignKey(
        "TriggerCluster",
        on_delete=models.PROTECT,
        related_name="triggers",
    )
    primary_therapy = models.ForeignKey(
        TherapyArea,
        on_delete=models.PROTECT,
        related_name="triggers",
    )
    is_active = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0)

    def __str__(self):
        return f"{self.code} - {self.display_name}"


class TriggerCluster(models.Model):
    code = models.CharField(max_length=80, unique=True)
    display_name = models.CharField(max_length=255)
    description = models.TextField(blank=True, default="")
    language_code = models.CharField(
        max_length=10,
        choices=LANGUAGES,
        default="en",
    )
    is_active = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0)

    def __str__(self):
        return f"{self.code} - {self.display_name} ({self.language_code})"


class VideoClusterVideo(models.Model):
    video_cluster = models.ForeignKey(
        VideoCluster,
        on_delete=models.CASCADE,
        related_name="cluster_videos",
    )
    video = models.ForeignKey(
        Video,
        on_delete=models.CASCADE,
    )
    sort_order = models.IntegerField(default=0)

    class Meta:
        unique_together = ("video_cluster", "video")

    def __str__(self):
        return f"{self.video_cluster.code} - {self.video.code}"


class VideoTriggerMap(models.Model):
    video = models.ForeignKey(Video, on_delete=models.CASCADE)
    trigger = models.ForeignKey(Trigger, on_delete=models.CASCADE)
    is_primary = models.BooleanField(default=False)
    sort_order = models.IntegerField(default=0)

    class Meta:
        unique_together = ("video", "trigger")

================================================================================
FILE: catalog/constants.py
================================================================================

LANGUAGES = [
    ("en", "English"),
    ("hi", "हिन्दी"),
    ("te", "తెలుగు"),
    ("ml", "മലയാളം"),
    ("mr", "मराठी"),
    ("kn", "ಕನ್ನಡ"),
    ("ta", "தமிழ்"),
    ("bn", "বাংলা"),
]

LANGUAGE_CODES = [c for c, _ in LANGUAGES]

# For this stage, you requested using one standard URL for all videos.
# Replace this with your real YouTube embed URL later (or store per-language URLs in admin).
DEFAULT_VIDEO_URL = "https://www.youtube.com/embed/VIDEO_ID_PLACEHOLDER"

# Standard thumbnail for all videos (replace later)
DEFAULT_THUMBNAIL_URL = "https://via.placeholder.com/1280x720.png?text=Video"

================================================================================
FILE: catalog/__init__.py
================================================================================

default_app_config = "catalog.apps.CatalogConfig"

================================================================================
FILE: catalog/apps.py
================================================================================

from django.apps import AppConfig


class CatalogConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "catalog"

    def ready(self):
        # Register signal handlers
        from . import signals  # noqa: F401

================================================================================
FILE: catalog/admin.py
================================================================================

from django.contrib import admin

from .models import (
    TherapyArea,
    TriggerCluster,
    Trigger,
    Video,
    VideoLanguage,
    VideoCluster,
    VideoClusterLanguage,
    VideoClusterVideo,
    VideoTriggerMap,
)


@admin.register(TriggerCluster)
class TriggerClusterAdmin(admin.ModelAdmin):
    list_display = ("display_name", "language_code", "sort_order", "is_active")
    list_editable = ("sort_order", "is_active")
    search_fields = ("display_name",)


@admin.register(TherapyArea)
class TherapyAreaAdmin(admin.ModelAdmin):
    list_display = ("code", "display_name", "sort_order", "is_active")
    list_editable = ("sort_order", "is_active")
    search_fields = ("code", "display_name")


@admin.register(Trigger)
class TriggerAdmin(admin.ModelAdmin):
    list_display = ("display_name", "primary_therapy", "is_active", "sort_order")
    list_filter = ("primary_therapy", "is_active")
    search_fields = ("display_name",)


class VideoLanguageInline(admin.TabularInline):
    model = VideoLanguage
    extra = 0


@admin.register(Video)
class VideoAdmin(admin.ModelAdmin):
    list_display = ("code", "is_active", "sort_order")
    list_filter = ("is_active",)
    search_fields = ("code",)
    inlines = [VideoLanguageInline]


class VideoClusterLanguageInline(admin.TabularInline):
    model = VideoClusterLanguage
    extra = 0


class VideoClusterVideoInline(admin.TabularInline):
    model = VideoClusterVideo
    extra = 0


@admin.register(VideoCluster)
class VideoClusterAdmin(admin.ModelAdmin):
    list_display = ("code", "sort_order", "is_active")
    list_filter = ("is_active",)
    search_fields = ("code",)
    inlines = [VideoClusterLanguageInline, VideoClusterVideoInline]


@admin.register(VideoTriggerMap)
class VideoTriggerMapAdmin(admin.ModelAdmin):
    list_display = ("video", "trigger", "is_primary", "sort_order")
    list_filter = ("is_primary",)
    search_fields = ("video__code", "trigger__display_name")

================================================================================
FILE: catalog/urls.py
================================================================================

from django.urls import path

urlpatterns = [
    # (intentionally empty; catalog is managed via Django admin)
]

================================================================================
FILE: catalog/management/__init__.py
================================================================================


================================================================================
FILE: catalog/management/commands/__init__.py
================================================================================


================================================================================
FILE: catalog/management/commands/import_master_data.py
================================================================================

from __future__ import annotations

import csv
import os
import re
from typing import Dict, Optional

from django.core.management.base import BaseCommand
from django.db import transaction

from catalog.constants import DEFAULT_THUMBNAIL_URL, DEFAULT_VIDEO_URL, LANGUAGE_CODES
from catalog.models import (
    TherapyArea,
    TriggerCluster,
    Trigger,
    Video,
    VideoLanguage,
    VideoCluster,
    VideoClusterLanguage,
    VideoClusterVideo,
    VideoTriggerMap,
)


def parse_bool(v: str) -> bool:
    return str(v).strip().lower() in {"1", "true", "yes", "y"}


def normalize_for_translit(text: str) -> str:
    # AI4Bharat engine works best on "words"; clean punctuation a bit.
    text = (text or "").replace("&", "and")
    # Keep letters/digits/spaces; replace other chars with space
    text = re.sub(r"[^0-9A-Za-z\s]", " ", text)
    text = re.sub(r"\s+", " ", text).strip()
    return text


class TranslitEngines:
    def __init__(self):
        self._engines: Dict[str, object] = {}
        self.available = False
        try:
            from ai4bharat.transliteration import XlitEngine  # type: ignore

            self._XlitEngine = XlitEngine
            self.available = True
        except Exception:
            self._XlitEngine = None
            self.available = False

    def translit(self, text: str, lang_code: str) -> str:
        if lang_code == "en":
            return text
        if not text:
            return text
        if not self.available:
            return text
        try:
            engine = self._engines.get(lang_code)
            if engine is None:
                engine = self._XlitEngine(lang_code, beam_width=6, rescore=True)
                self._engines[lang_code] = engine

            cleaned = normalize_for_translit(text)
            if not cleaned:
                return text

            out = engine.translit_sentence(cleaned)
            # API returns dict {lang_code: "..."}
            if isinstance(out, dict) and lang_code in out and out[lang_code]:
                return out[lang_code]
            return text
        except Exception:
            # Fail safe: don't break import if transliteration fails for any row
            return text


CLUSTER_SEED = [
    {
        "code": "ACUTE_DIAGNOSED",
        "display_name": "Acute condition – diagnosed now",
        "description": "Clear acute diagnosis made today; home care & red flags.",
        "sort_order": 10,
    },
    {
        "code": "SUSPECTED_MONITORING",
        "display_name": "Suspected condition – monitoring / watchful waiting",
        "description": "Diagnosis not yet confirmed; symptom diary, warning signs, staged tests.",
        "sort_order": 20,
    },
    {
        "code": "CHRONIC_CONDITION",
        "display_name": "Chronic condition – long-term care",
        "description": "Known chronic disease; daily care, flare management, follow-up.",
        "sort_order": 30,
    },
    {
        "code": "DRUG_OR_DEVICE",
        "display_name": "Drug / device – use & adherence",
        "description": "Education tied to a specific medicine, device or regimen.",
        "sort_order": 40,
    },
    {
        "code": "PREVENTIVE_CARE",
        "display_name": "Prevention – vaccines / growth / development",
        "description": "Well-child visits: vaccines, nutrition, development, screening.",
        "sort_order": 50,
    },
]


class Command(BaseCommand):
    help = "Import trigger/video master data from the provided CSV files. Safe to re-run (idempotent)."

    def add_arguments(self, parser):
        parser.add_argument(
            "--path",
            type=str,
            default=".",
            help="Folder containing trigger_master.csv, video_master.csv, video_cluster_master.csv, video_cluster_video_master.csv, video_trigger_map_master.csv",
        )

    @transaction.atomic
    def handle(self, *args, **options):
        base_path = options["path"]

        trigger_csv = os.path.join(base_path, "trigger_master.csv")
        video_csv = os.path.join(base_path, "video_master.csv")
        cluster_csv = os.path.join(base_path, "video_cluster_master.csv")
        cluster_video_csv = os.path.join(base_path, "video_cluster_video_master.csv")
        video_trigger_map_csv = os.path.join(base_path, "video_trigger_map_master.csv")

        for p in [trigger_csv, video_csv, cluster_csv, cluster_video_csv, video_trigger_map_csv]:
            if not os.path.exists(p):
                raise FileNotFoundError(f"Missing required file: {p}")

        self.stdout.write(self.style.NOTICE("Seeding trigger clusters..."))
        for row in CLUSTER_SEED:
            TriggerCluster.objects.update_or_create(
                code=row["code"],
                defaults={
                    "display_name": row["display_name"],
                    "description": row["description"],
                    "sort_order": row["sort_order"],
                    "is_active": True,
                },
            )

        # Build therapy areas from triggers and videos
        therapy_names = set()
        with open(trigger_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                therapy_names.add((r.get("primary_therapy_area") or "").strip())
        with open(video_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                therapy_names.add((r.get("primary_therapy_area") or "").strip())
        therapy_names = {n for n in therapy_names if n}

        self.stdout.write(self.style.NOTICE(f"Upserting {len(therapy_names)} therapy areas..."))
        for name in sorted(therapy_names):
            code = TherapyArea.code_from_name(name)
            TherapyArea.objects.update_or_create(code=code, defaults={"display_name": name, "is_active": True})

        # Helper maps
        clusters_by_code = {c.code: c for c in TriggerCluster.objects.all()}
        therapy_by_name = {t.display_name: t for t in TherapyArea.objects.all()}

        self.stdout.write(self.style.NOTICE("Importing triggers..."))
        with open(trigger_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                code = (r.get("trigger_code") or "").strip()
                cluster_code = (r.get("cluster_code") or "").strip()
                therapy_name = (r.get("primary_therapy_area") or "").strip()

                Trigger.objects.update_or_create(
                    code=code,
                    defaults={
                        "cluster": clusters_by_code[cluster_code],
                        "primary_therapy": therapy_by_name[therapy_name],
                        "subtopic_title": (r.get("subtopic_title") or "").strip(),
                        "doctor_trigger_label": (r.get("doctor_trigger_label") or "").strip(),
                        "navigation_pathways": (r.get("navigation_pathways") or "").strip(),
                        "search_keywords": (r.get("trigger_search_keywords") or "").strip(),
                        "is_active": True,
                    },
                )

        triggers_by_code = {t.code: t for t in Trigger.objects.all()}

        translit = TranslitEngines()
        if translit.available:
            self.stdout.write(self.style.NOTICE("AI4Bharat transliteration engine detected; generating localized titles."))
        else:
            self.stdout.write(
                self.style.WARNING(
                    "AI4Bharat transliteration engine NOT installed. Localized titles will remain in English. "
                    "Install with: pip install ai4bharat-transliteration"
                )
            )

        self.stdout.write(self.style.NOTICE("Importing videos + language rows..."))
        with open(video_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                vcode = (r.get("video_code") or "").strip()
                title_en = (r.get("title") or "").strip()
                description = (r.get("description") or "").strip()
                primary_trigger_code = (r.get("primary_trigger_code") or "").strip()
                therapy_name = (r.get("primary_therapy_area") or "").strip()
                is_published = parse_bool(r.get("is_published") or "false")
                search_keywords = (r.get("video_search_keywords") or "").strip()

                video, _ = Video.objects.update_or_create(
                    code=vcode,
                    defaults={
                        "description": description,
                        "primary_trigger": triggers_by_code.get(primary_trigger_code),
                        "primary_therapy": therapy_by_name.get(therapy_name),
                        "thumbnail_url": DEFAULT_THUMBNAIL_URL,
                        "is_published": is_published,
                        "search_keywords": search_keywords,
                    },
                )

                for lang in LANGUAGE_CODES:
                    title_local = title_en if lang == "en" else translit.translit(title_en, lang)
                    VideoLanguage.objects.update_or_create(
                        video=video,
                        language_code=lang,
                        defaults={
                            "title": title_local,
                            "youtube_url": DEFAULT_VIDEO_URL,
                        },
                    )

        videos_by_code = {v.code: v for v in Video.objects.all()}

        self.stdout.write(self.style.NOTICE("Importing video clusters + language rows..."))
        with open(cluster_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                ccode = (r.get("video_cluster_code") or "").strip()
                tcode = (r.get("trigger_code") or "").strip()
                name_en = (r.get("name") or "").strip()
                description = (r.get("description") or "").strip()
                is_published = parse_bool(r.get("is_published") or "false")
                search_keywords = (r.get("cluster_search_keywords") or "").strip()

                cluster, _ = VideoCluster.objects.update_or_create(
                    code=ccode,
                    defaults={
                        "trigger": triggers_by_code[tcode],
                        "description": description,
                        "is_published": is_published,
                        "search_keywords": search_keywords,
                    },
                )

                for lang in LANGUAGE_CODES:
                    name_local = name_en if lang == "en" else translit.translit(name_en, lang)
                    VideoClusterLanguage.objects.update_or_create(
                        video_cluster=cluster,
                        language_code=lang,
                        defaults={"name": name_local},
                    )

        clusters_by_code = {c.code: c for c in VideoCluster.objects.all()}

        self.stdout.write(self.style.NOTICE("Importing video_cluster → video mappings..."))
        with open(cluster_video_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                ccode = (r.get("video_cluster_code") or "").strip()
                vcode = (r.get("video_code") or "").strip()
                sort_order = int((r.get("sort_order") or "0").strip() or 0)
                VideoClusterVideo.objects.update_or_create(
                    video_cluster=clusters_by_code[ccode],
                    video=videos_by_code[vcode],
                    defaults={"sort_order": sort_order},
                )

        self.stdout.write(self.style.NOTICE("Importing video → trigger map (optional multi-trigger)..."))
        with open(video_trigger_map_csv, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for r in reader:
                vcode = (r.get("video_code") or "").strip()
                tcode = (r.get("trigger_code") or "").strip()
                is_primary = parse_bool(r.get("is_primary") or "false")
                sort_order = int((r.get("sort_order") or "0").strip() or 0)
                if vcode in videos_by_code and tcode in triggers_by_code:
                    VideoTriggerMap.objects.update_or_create(
                        video=videos_by_code[vcode],
                        trigger=triggers_by_code[tcode],
                        defaults={"is_primary": is_primary, "sort_order": sort_order},
                    )

        self.stdout.write(self.style.SUCCESS("Import complete."))

================================================================================
FILE: peds_edu/asgi.py
================================================================================

"""ASGI config for peds_edu project."""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "peds_edu.settings")

application = get_asgi_application()

================================================================================
FILE: peds_edu/__init__.py
================================================================================


================================================================================
FILE: peds_edu/settings.py
================================================================================

"""Django settings for peds_edu.

This project is designed to be deployed on AWS Ubuntu with MySQL.
Configuration is done primarily via environment variables.
"""

from __future__ import annotations

import json
import os
from pathlib import Path

from dotenv import load_dotenv

from .aws_secrets import get_secret_string  # Optional fallback for secrets

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(BASE_DIR / ".env")

CSRF_TRUSTED_ORIGINS = [
    "https://portal.cpdinclinic.co.in",
    "https://www.portal.cpdinclinic.co.in",
    "http://3.6.101.52",
]


def env(name: str, default: str | None = None) -> str:
    value = os.getenv(name, default)
    if value is None:
        raise RuntimeError(f"Missing required env var: {name}")
    return value


SECRET_KEY = env("DJANGO_SECRET_KEY", "dev-insecure-change-me")
DEBUG = env("DJANGO_DEBUG", "1") == "1"

ALLOWED_HOSTS = [h.strip() for h in env("ALLOWED_HOSTS", "*").split(",") if h.strip()]

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "accounts.apps.AccountsConfig",
    "catalog.apps.CatalogConfig",
    "sharing.apps.SharingConfig",
    "publisher.apps.PublisherConfig",
    "sso.apps.SsoConfig",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "peds_edu.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
                "sharing.context_processors.clinic_branding",
            ],
        },
    },
]

WSGI_APPLICATION = "peds_edu.wsgi.application"

# ---------------- DATABASE ----------------
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",  # Force MySQL
        "NAME": env("DB_NAME", "peds_edu"),
        "USER": env("DB_USER", "peds_edu"),
        "PASSWORD": env("DB_PASSWORD", "Bv9ALOgzFszxDYso"),
        "HOST": env("DB_HOST", "35.154.221.92"),
        "PORT": env("DB_PORT", "3306"),
        "OPTIONS": {"charset": "utf8mb4"},
    }
}

# ---------------------------------------------------------------------
# MASTER FORMS DB (Project1 master DB) - new-forms-rds
# ---------------------------------------------------------------------

MASTER_DB_ALIAS = "master"

# ❌ Do NOT use env or secrets
MASTER_DB_ENGINE = "django.db.backends.mysql"
MASTER_DB_NAME = "YOUR_DATABASE_NAME"
MASTER_DB_USER = "root"
MASTER_DB_PASSWORD = "Hemsod-vytsew-7qypxa"
MASTER_DB_HOST = "new-forms-rds.cbnobb8kfeuq.ap-south-1.rds.amazonaws.com"
MASTER_DB_PORT = "3306"

# Table/column config (leave as-is unless schema differs)
MASTER_DB_DOCTOR_TABLE = "Doctor"
MASTER_DB_DOCTOR_ID_COLUMN = "doctor_id"
MASTER_DB_DOCTOR_WHATSAPP_COLUMN = "whatsapp_no"

MASTER_DB_ENROLLMENT_TABLE = "DoctorCampaignEnrollment"
MASTER_DB_ENROLLMENT_DOCTOR_COLUMN = "doctor_id"
MASTER_DB_ENROLLMENT_CAMPAIGN_COLUMN = "campaign_id"
MASTER_DB_ENROLLMENT_REGISTERED_BY_COLUMN = "registered_by_id"


if MASTER_DB_NAME and MASTER_DB_USER and MASTER_DB_PASSWORD and MASTER_DB_HOST:
    DATABASES[MASTER_DB_ALIAS] = {
        "ENGINE": MASTER_DB_ENGINE,
        "NAME": MASTER_DB_NAME,
        "USER": MASTER_DB_USER,
        "PASSWORD": MASTER_DB_PASSWORD,
        "HOST": MASTER_DB_HOST,
        "PORT": MASTER_DB_PORT,
    }

AUTH_PASSWORD_VALIDATORS = [
    {"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"},
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]

AUTH_USER_MODEL = "accounts.User"

LANGUAGE_CODE = "en"
LANGUAGES = [
    ("en", "English"),
    ("hi", "Hindi"),
    ("te", "Telugu"),
    ("ml", "Malayalam"),
    ("mr", "Marathi"),
    ("kn", "Kannada"),
    ("ta", "Tamil"),
    ("bn", "Bengali"),
]

TIME_ZONE = env("DJANGO_TIME_ZONE", "Asia/Kolkata")
USE_I18N = True
USE_TZ = True

STATIC_URL = "/static/"
STATIC_ROOT = BASE_DIR / "staticfiles"
STATICFILES_DIRS = [BASE_DIR / "static"]
STATICFILES_STORAGE = "whitenoise.storage.CompressedManifestStaticFilesStorage"

MEDIA_URL = env("MEDIA_URL", "/media/")
MEDIA_ROOT = Path(env("MEDIA_ROOT", "/home/ubuntu/patient-portal-media")).resolve()

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# ---------------- SESSIONS ----------------
SESSION_COOKIE_AGE = int(env("SESSION_COOKIE_AGE_SECONDS", str(60 * 60 * 24 * 90)))
SESSION_EXPIRE_AT_BROWSER_CLOSE = False
SESSION_SAVE_EVERY_REQUEST = True

# ---------------- SECURITY ----------------
CSRF_COOKIE_SECURE = env("CSRF_COOKIE_SECURE", "0") == "1"
SESSION_COOKIE_SECURE = env("SESSION_COOKIE_SECURE", "0") == "1"
SECURE_SSL_REDIRECT = env("SECURE_SSL_REDIRECT", "0") == "1"

# ---------------- APP BASE URL ----------------
APP_BASE_URL = env("APP_BASE_URL", "https://portal.cpdinclinic.co.in").rstrip("/")
SITE_BASE_URL = APP_BASE_URL

# ---------------- EMAIL / SENDGRID ----------------

def _extract_sendgrid_key_from_secret(secret_raw: str) -> str:
    raw = (secret_raw or "").strip()
    if not raw:
        return ""

    if raw.startswith("{") and raw.endswith("}"):
        try:
            obj = json.loads(raw)
            if isinstance(obj, dict):
                for k in (
                    "SendGrid_email",
                    "sendgrid_email",
                    "SENDGRID_API_KEY",
                    "sendgrid_api_key",
                    "api_key",
                    "apikey",
                    "key",
                ):
                    v = obj.get(k)
                    if isinstance(v, str) and v.strip():
                        return v.strip()
        except Exception:
            pass

    return raw


SENDGRID_API_KEY = env("SENDGRID_API_KEY", "").strip()
if not SENDGRID_API_KEY:
    secret_raw = (get_secret_string("SendGrid_API", region_name="ap-south-1") or "").strip()
    SENDGRID_API_KEY = _extract_sendgrid_key_from_secret(secret_raw)

SENDGRID_FROM_EMAIL = env("SENDGRID_FROM_EMAIL", "products@inditech.co.in").strip()
EMAIL_BACKEND_MODE = env("EMAIL_BACKEND_MODE", "smtp").strip().lower()

if EMAIL_BACKEND_MODE == "smtp":
    EMAIL_BACKEND = "django.core.mail.backends.smtp.EmailBackend"
else:
    EMAIL_BACKEND = "django.core.mail.backends.console.EmailBackend"

EMAIL_HOST = env("EMAIL_HOST", "smtp.sendgrid.net")
EMAIL_PORT = int(env("EMAIL_PORT", "587"))
EMAIL_USE_TLS = env("EMAIL_USE_TLS", "1") == "1"
EMAIL_USE_SSL = env("EMAIL_USE_SSL", "0") == "1"
EMAIL_HOST_USER = env("EMAIL_HOST_USER", "apikey")
EMAIL_HOST_PASSWORD = env("EMAIL_HOST_PASSWORD", SENDGRID_API_KEY)
DEFAULT_FROM_EMAIL = env("DEFAULT_FROM_EMAIL", SENDGRID_FROM_EMAIL)

# ---------------- CACHE ----------------
REDIS_URL = os.getenv("REDIS_URL")
if REDIS_URL:
    CACHES = {
        "default": {
            "BACKEND": "django_redis.cache.RedisCache",
            "LOCATION": REDIS_URL,
            "OPTIONS": {"CLIENT_CLASS": "django_redis.client.DefaultClient"},
            "TIMEOUT": int(env("CACHE_DEFAULT_TIMEOUT_SECONDS", "3600")),
        }
    }
else:
    CACHES = {
        "default": {
            "BACKEND": "django.core.cache.backends.locmem.LocMemCache",
            "LOCATION": "peds-edu-locmem",
            "TIMEOUT": int(env("CACHE_DEFAULT_TIMEOUT_SECONDS", "3600")),
        }
    }

CATALOG_CACHE_SECONDS = int(env("CATALOG_CACHE_SECONDS", str(60 * 60)))

# ---------------- LOGGING ----------------
LOGGING = {
    "version": 1,
    "disable_existing_loggers": False,
    "handlers": {"console": {"class": "logging.StreamHandler"}},
    "root": {"handlers": ["console"], "level": "INFO"},
}

import os

# ---------------------------------------------------------------------
# SSO consume configuration (Project2)
# ---------------------------------------------------------------------

SSO_USE_ENV = False  # TEMP: set True later when you can configure server env vars


def _sso_setting(name: str, default):
    if SSO_USE_ENV:
        return os.getenv(name, default)
    return default


SSO_EXPECTED_ISSUER = _sso_setting("SSO_EXPECTED_ISSUER", "project1")
SSO_EXPECTED_AUDIENCE = _sso_setting("SSO_EXPECTED_AUDIENCE", "project2")

SSO_SHARED_SECRET = _sso_setting(
    "SSO_SHARED_SECRET",
    _sso_setting("PUBLISHER_SSO_SHARED_SECRET", "CHANGE-ME-TO-A-LONG-RANDOM-STRING"),
)

SSO_SESSION_AGE_SECONDS = int(_sso_setting("SSO_SESSION_AGE_SECONDS", "3600"))
SSO_SESSION_KEY_IDENTITY = "sso_identity"
SSO_SESSION_KEY_CAMPAIGN = "campaign_id"


# Master DB alias name used throughout the code
MASTER_DB_ALIAS = os.getenv("MASTER_DB_ALIAS", "master").strip()

# ---------------------------------------------------------------------
# MASTER DATA TABLE NAMES (configure to match the admin Django project DB)
# ---------------------------------------------------------------------

# AuthorizedPublisher table
MASTER_DB_AUTH_PUBLISHER_TABLE = os.getenv(
    "MASTER_DB_AUTH_PUBLISHER_TABLE",
    "campaign_authorizedpublisher",   # <-- CHANGE to real table name
).strip()
MASTER_DB_AUTH_PUBLISHER_EMAIL_COLUMN = os.getenv(
    "MASTER_DB_AUTH_PUBLISHER_EMAIL_COLUMN",
    "email",
).strip()

# FieldRep table
MASTER_DB_FIELD_REP_TABLE = os.getenv(
    "MASTER_DB_FIELD_REP_TABLE",
    "campaign_campaignfieldrep;",              # <-- CHANGE to real table name
).strip()
MASTER_DB_FIELD_REP_PK_COLUMN = os.getenv("MASTER_DB_FIELD_REP_PK_COLUMN", "id").strip()
MASTER_DB_FIELD_REP_EXTERNAL_ID_COLUMN = os.getenv(
    "MASTER_DB_FIELD_REP_EXTERNAL_ID_COLUMN",
    "brand_supplied_field_rep_id",
).strip()
MASTER_DB_FIELD_REP_ACTIVE_COLUMN = os.getenv("MASTER_DB_FIELD_REP_ACTIVE_COLUMN", "is_active").strip()
MASTER_DB_FIELD_REP_FULL_NAME_COLUMN = os.getenv("MASTER_DB_FIELD_REP_FULL_NAME_COLUMN", "full_name").strip()
MASTER_DB_FIELD_REP_PHONE_COLUMN = os.getenv("MASTER_DB_FIELD_REP_PHONE_COLUMN", "phone_number").strip()

# Campaign table (the admin project’s campaign master)
MASTER_DB_CAMPAIGN_TABLE = os.getenv(
    "MASTER_DB_CAMPAIGN_TABLE",
    "campaign_campaign",              # <-- CHANGE to real table name (could be schema qualified)
).strip()
MASTER_DB_CAMPAIGN_ID_COLUMN = os.getenv("MASTER_DB_CAMPAIGN_ID_COLUMN", "campaign_id").strip()
MASTER_DB_CAMPAIGN_DOCTORS_SUPPORTED_COLUMN = os.getenv("MASTER_DB_CAMPAIGN_DOCTORS_SUPPORTED_COLUMN", "doctors_supported").strip()
MASTER_DB_CAMPAIGN_WA_ADDITION_COLUMN = os.getenv("MASTER_DB_CAMPAIGN_WA_ADDITION_COLUMN", "wa_addition").strip()
MASTER_DB_CAMPAIGN_VIDEO_CLUSTER_COLUMN = os.getenv("MASTER_DB_CAMPAIGN_VIDEO_CLUSTER_COLUMN", "new_video_cluster_name").strip()
MASTER_DB_CAMPAIGN_EMAIL_REGISTRATION_COLUMN = os.getenv("MASTER_DB_CAMPAIGN_EMAIL_REGISTRATION_COLUMN", "email_registration").strip()

# Public base URL used for absolute links
PUBLIC_BASE_URL = os.getenv("PUBLIC_BASE_URL", "https://portal.cpdinclinic.co.in").rstrip("/")


# -----------------------------
# MASTER DB alias + connection
# -----------------------------
MASTER_DB_ALIAS = "master"

DATABASES[MASTER_DB_ALIAS] = {
    "ENGINE": "django.db.backends.mysql",
    "NAME": "healthcare_forms",
    "USER": "admin",
    "PASSWORD": "Hemsod-vytsew-7qypxa",
    "HOST": "new-forms-rds.cbnobb8kfeuq.ap-south-1.rds.amazonaws.com",
    "PORT": "3306",
    "OPTIONS": {"charset": "utf8mb4"},
    "CONN_MAX_AGE": 60,
}



# -----------------------------
# MASTER TABLES/COLUMNS (based on your DB output + models)
# -----------------------------

# FieldRep table
MASTER_DB_FIELD_REP_TABLE = "campaign_fieldrep"
MASTER_DB_FIELD_REP_PK_COLUMN = "id"
MASTER_DB_FIELD_REP_USER_ID_COLUMN = "user_id"
MASTER_DB_FIELD_REP_EXTERNAL_ID_COLUMN = "brand_supplied_field_rep_id"
MASTER_DB_FIELD_REP_ACTIVE_COLUMN = "is_active"
MASTER_DB_FIELD_REP_FULL_NAME_COLUMN = "full_name"
MASTER_DB_FIELD_REP_PHONE_COLUMN = "phone_number"

# CampaignFieldRep join table
MASTER_DB_CAMPAIGN_FIELD_REP_TABLE = "campaign_campaignfieldrep"
MASTER_DB_CAMPAIGN_FIELD_REP_PK_COLUMN = "id"
MASTER_DB_CAMPAIGN_FIELD_REP_CAMPAIGN_COLUMN = "campaign_id"
MASTER_DB_CAMPAIGN_FIELD_REP_FIELD_REP_COLUMN = "field_rep_id"

# Campaign table (IMPORTANT: id is the primary key)
MASTER_DB_CAMPAIGN_TABLE = "campaign_campaign"
MASTER_DB_CAMPAIGN_ID_COLUMN = "id"
MASTER_DB_CAMPAIGN_DOCTORS_SUPPORTED_COLUMN = "num_doctors_supported"
MASTER_DB_CAMPAIGN_WA_ADDITION_COLUMN = "add_to_campaign_message"   # used as wa_addition in Project2 flow
MASTER_DB_CAMPAIGN_VIDEO_CLUSTER_COLUMN = "name"                    # used as new_video_cluster_name in Project2 flow
MASTER_DB_CAMPAIGN_EMAIL_REGISTRATION_COLUMN = "register_message"   # used as email_registration in Project2 flow

PUBLIC_BASE_URL = "https://portal.cpdinclinic.co.in"


# -----------------------------
# MASTER Doctor table mapping
# -----------------------------
MASTER_DB_DOCTOR_TABLE = "redflags_doctor"

MASTER_DB_DOCTOR_ID_COLUMN = "doctor_id"
MASTER_DB_DOCTOR_FIRST_NAME_COLUMN = "first_name"
MASTER_DB_DOCTOR_LAST_NAME_COLUMN = "last_name"
MASTER_DB_DOCTOR_EMAIL_COLUMN = "email"
MASTER_DB_DOCTOR_WHATSAPP_COLUMN = "whatsapp_no"

================================================================================
FILE: peds_edu/urls.py
================================================================================

from django.contrib import admin
from django.urls import include, path

from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path("admin/", admin.site.urls),

    # SSO consume endpoint (Project2 destination)
    path("sso/", include("sso.urls")),

    # Campaign publishing module routes at root:
    # /publisher-landing-page/, /add-campaign-details/, /campaigns/, /publisher-api/...
    path("", include(("publisher.campaign_urls", "campaign_publisher"), namespace="campaign_publisher")),

    # Existing app routes
    path("", include("sharing.urls")),
    path("accounts/", include("accounts.urls")),
    path("publisher/", include("publisher.urls")),
]

# Serve uploaded media (doctor photos + campaign banners)
urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)


================================================================================
FILE: peds_edu/aws_secrets.py
================================================================================

from __future__ import annotations

import base64
import os
from functools import lru_cache
from typing import Optional

try:
    import boto3
    from botocore.exceptions import (
        BotoCoreError,
        ClientError,
        EndpointConnectionError,
        NoCredentialsError,
        NoRegionError,
        PartialCredentialsError,
    )
except Exception as e:  # pragma: no cover
    # Keep this extremely lightweight; do not crash import-time.
    print("[DEBUG] boto3 import failed:", repr(e))
    boto3 = None  # type: ignore
    BotoCoreError = Exception  # type: ignore
    ClientError = Exception  # type: ignore
    EndpointConnectionError = Exception  # type: ignore
    NoCredentialsError = Exception  # type: ignore
    NoRegionError = Exception  # type: ignore
    PartialCredentialsError = Exception  # type: ignore


_LAST_ERROR: str = ""


def _debug_enabled() -> bool:
    # Enable with DEBUG_AWS_SECRETS=1
    return os.getenv("DEBUG_AWS_SECRETS", "0") == "1"


def get_last_error() -> str:
    """Best-effort last error string from the most recent Secrets Manager call in this process."""
    return _LAST_ERROR


@lru_cache(maxsize=32)
def get_secret_string(secret_name: str, region_name: str = "ap-south-1") -> Optional[str]:
    """
    Fetch a secret string from AWS Secrets Manager.

    Best-effort: never raises.
    """
    global _LAST_ERROR
    _LAST_ERROR = ""

    if _debug_enabled():
        print(f"[DEBUG] get_secret_string called | secret_name={secret_name} | region={region_name}")

    if boto3 is None:
        _LAST_ERROR = "boto3_unavailable"
        if _debug_enabled():
            print("[DEBUG] boto3 unavailable")
        return None

    try:
        if _debug_enabled():
            print("[DEBUG] Creating boto3 session")
        session = boto3.session.Session()

        if _debug_enabled():
            print("[DEBUG] Creating Secrets Manager client")
        client = session.client(service_name="secretsmanager", region_name=region_name)

        if _debug_enabled():
            print("[DEBUG] Calling get_secret_value")
        response = client.get_secret_value(SecretId=secret_name)

    except (
        ClientError,
        NoCredentialsError,
        PartialCredentialsError,
        NoRegionError,
        EndpointConnectionError,
        BotoCoreError,
    ) as e:
        _LAST_ERROR = f"{type(e).__name__}: {e}"
        if _debug_enabled():
            print("[DEBUG] AWS error while fetching secret")
            print("[DEBUG] Error:", _LAST_ERROR)
        return None

    except Exception as e:
        _LAST_ERROR = f"{type(e).__name__}: {e}"
        if _debug_enabled():
            print("[DEBUG] Unexpected error while fetching secret")
            print("[DEBUG] Error:", _LAST_ERROR)
        return None

    if isinstance(response, dict) and response.get("SecretString"):
        if _debug_enabled():
            print("[DEBUG] SecretString returned")
        return str(response["SecretString"]).strip()

    if isinstance(response, dict) and response.get("SecretBinary"):
        if _debug_enabled():
            print("[DEBUG] SecretBinary returned, attempting base64 decode")
        try:
            decoded = base64.b64decode(response["SecretBinary"]).decode("utf-8").strip()
            if _debug_enabled():
                print("[DEBUG] SecretBinary decoded successfully")
            return decoded
        except Exception as e:
            _LAST_ERROR = f"decode_error:{type(e).__name__}: {e}"
            if _debug_enabled():
                print("[DEBUG] Failed to decode SecretBinary")
                print("[DEBUG] Error:", _LAST_ERROR)
            return None

    if _debug_enabled():
        print("[DEBUG] No SecretString or SecretBinary found in response")
    return None

================================================================================
FILE: peds_edu/wsgi.py
================================================================================

"""WSGI config for peds_edu project."""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "peds_edu.settings")

application = get_wsgi_application()

================================================================================
FILE: sso/__init__.py
================================================================================

# empty

================================================================================
FILE: sso/apps.py
================================================================================

from django.apps import AppConfig


class SsoConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "sso"

================================================================================
FILE: sso/urls.py
================================================================================

from django.urls import path
from . import views

urlpatterns = [
    path("consume/", views.consume, name="sso_consume"),
]

================================================================================
FILE: sso/views.py
================================================================================

from __future__ import annotations

import uuid

from django.conf import settings
from django.contrib import messages
from django.shortcuts import redirect
from django.utils.http import url_has_allowed_host_and_scheme
from django.views.decorators.http import require_http_methods

from .jwt import decode_and_verify_hs256_jwt, JWTError


@require_http_methods(["GET"])
def consume(request):
    """
    SSO endpoint:
      GET /sso/consume/?token=...&campaign_id=...&next=/some/path

    Validates token and then creates Project2 session.
    """
    token = (request.GET.get("token") or "").strip()
    campaign_id_raw = (request.GET.get("campaign_id") or request.GET.get("campaign-id") or "").strip()
    next_url = (request.GET.get("next") or "/").strip() or "/"

    if not token or not campaign_id_raw:
        messages.error(request, "Missing token or campaign_id.")
        return redirect("/")

    if not getattr(settings, "SSO_SHARED_SECRET", ""):
        messages.error(request, "SSO not configured.")
        return redirect("/")

    try:
        payload = decode_and_verify_hs256_jwt(
            token,
            secret=settings.SSO_SHARED_SECRET,
            issuer=settings.SSO_EXPECTED_ISSUER,
            audience=settings.SSO_EXPECTED_AUDIENCE,
        )
    except JWTError:
        messages.error(
            request,
            "SSO link is invalid or expired. Please reopen it from the publisher portal."
        )
        return redirect("/")

    # Required claim checks (per your specified format)
    sub = (payload.get("sub") or "").strip()
    username = (payload.get("username") or "").strip()
    roles = payload.get("roles") or []

    if not sub or not username or not isinstance(roles, list):
        messages.error(request, "SSO token missing required claims.")
        return redirect("/")

    # Optional hardening:
    # If Project1 includes campaign_id inside JWT, validate queryparam vs claim.
    token_campaign = (payload.get("campaign_id") or "").strip()
    if token_campaign and token_campaign != campaign_id_raw:
        messages.error(request, "Invalid campaign_id.")
        return redirect("/")

    # Normalize campaign_id if it is a UUID; otherwise keep as string.
    campaign_id_value = campaign_id_raw
    try:
        campaign_id_value = str(uuid.UUID(campaign_id_raw))
    except Exception:
        pass

    # Create destination session (Project2’s own session)
    request.session[getattr(settings, "SSO_SESSION_KEY_IDENTITY", "sso_identity")] = {
        "sub": sub,
        "username": username,
        "roles": roles,
        "iss": payload.get("iss"),
        "aud": payload.get("aud"),
    }
    request.session[getattr(settings, "SSO_SESSION_KEY_CAMPAIGN", "campaign_id")] = str(campaign_id_value)

    # Session length on destination side:
    request.session.set_expiry(getattr(settings, "SSO_SESSION_AGE_SECONDS", 3600))
    request.session.modified = True

    # Safe redirect
    if not url_has_allowed_host_and_scheme(
        next_url,
        allowed_hosts={request.get_host()},
        require_https=request.is_secure(),
    ):
        next_url = "/"

    return redirect(next_url)

================================================================================
FILE: sso/jwt.py
================================================================================

from __future__ import annotations

import base64
import hashlib
import hmac
import json
import time
from typing import Any, Dict


class JWTError(ValueError):
    pass


class JWTInvalid(JWTError):
    pass


class JWTExpired(JWTError):
    pass


def _b64url_decode(data: str) -> bytes:
    pad = "=" * (-len(data) % 4)
    return base64.urlsafe_b64decode((data + pad).encode("ascii"))


def decode_and_verify_hs256_jwt(
    token: str,
    *,
    secret: str,
    issuer: str,
    audience: str,
    leeway_seconds: int = 30,
) -> Dict[str, Any]:
    """
    Verifies:
      - HS256 signature
      - iss == issuer
      - aud == audience
      - exp not expired (with leeway)
    Returns payload dict.
    """
    try:
        header_b64, payload_b64, sig_b64 = token.split(".")
    except ValueError:
        raise JWTInvalid("Malformed JWT")

    # header
    try:
        header = json.loads(_b64url_decode(header_b64).decode("utf-8"))
    except Exception:
        raise JWTInvalid("Invalid JWT header")

    if header.get("alg") != "HS256":
        raise JWTInvalid("Unsupported alg")

    # signature
    signing_input = f"{header_b64}.{payload_b64}".encode("ascii")
    expected_sig = hmac.new(secret.encode("utf-8"), signing_input, hashlib.sha256).digest()
    try:
        actual_sig = _b64url_decode(sig_b64)
    except Exception:
        raise JWTInvalid("Invalid signature encoding")

    if not hmac.compare_digest(expected_sig, actual_sig):
        raise JWTInvalid("Invalid signature")

    # payload
    try:
        payload = json.loads(_b64url_decode(payload_b64).decode("utf-8"))
    except Exception:
        raise JWTInvalid("Invalid JWT payload")

    if not isinstance(payload, dict):
        raise JWTInvalid("Invalid payload type")

    if payload.get("iss") != issuer:
        raise JWTInvalid("Invalid issuer")

    if payload.get("aud") != audience:
        raise JWTInvalid("Invalid audience")

    now = int(time.time())
    exp = int(payload.get("exp") or 0)
    if exp <= 0:
        raise JWTInvalid("Missing exp")
    if now > exp + int(leeway_seconds or 0):
        raise JWTExpired("Token expired")

    iat = int(payload.get("iat") or 0)
    if iat and iat > now + 60:
        raise JWTInvalid("iat is in the future")

    return payload

================================================================================
FILE: sso/decorators.py
================================================================================

from __future__ import annotations

from functools import wraps
from typing import Iterable, Optional

from django.conf import settings
from django.shortcuts import redirect


def sso_required(required_roles: Optional[Iterable[str]] = None):
    """
    Protect views so only users who came via SSO (valid token -> session created) can access.
    Optionally enforce roles like ["publisher"].
    """
    required_roles = list(required_roles or [])

    def decorator(view_func):
        @wraps(view_func)
        def _wrapped(request, *args, **kwargs):
            ident = request.session.get(getattr(settings, "SSO_SESSION_KEY_IDENTITY", "sso_identity"))
            if not isinstance(ident, dict):
                return redirect("/")

            if required_roles:
                roles = ident.get("roles") or []
                if not isinstance(roles, list) or not any(r in roles for r in required_roles):
                    return redirect("/")

            return view_func(request, *args, **kwargs)

        return _wrapped

    return decorator

================================================================================
FILE: accounts/pincode_directory.py
================================================================================

from __future__ import annotations

import json
import re
from functools import lru_cache
from pathlib import Path
from typing import Optional

from .models import INDIA_STATES_AND_UTS


PINCODE_DIRECTORY_PATH = Path(__file__).resolve().parent / "data" / "india_pincode_directory.json"


class IndiaPincodeDirectoryNotReady(RuntimeError):
    """Raised when the pincode directory JSON is missing/unreadable."""


# Common synonyms / spelling variants => project canonical names (must match INDIA_STATES_AND_UTS)
_STATE_NORMALIZATION = {
    "NCT of Delhi": "Delhi",
    "Delhi NCR": "Delhi",
    "Orissa": "Odisha",
    "Pondicherry": "Puducherry",
    "Dadra and Nagar Haveli": "Dadra and Nagar Haveli and Daman and Diu",
    "Daman and Diu": "Dadra and Nagar Haveli and Daman and Diu",
    "Dadra & Nagar Haveli": "Dadra and Nagar Haveli and Daman and Diu",
    "Dadra & Nagar Haveli and Daman & Diu": "Dadra and Nagar Haveli and Daman and Diu",
    "Jammu & Kashmir": "Jammu and Kashmir",
    "Andaman & Nicobar Islands": "Andaman and Nicobar Islands",
}


def _canon_state_name(raw: str) -> str:
    s = (raw or "").strip()
    if not s:
        return ""

    # Normalize spacing and punctuation
    s = re.sub(r"\s+", " ", s)
    s = s.replace("&", "and").strip()

    # Synonyms
    for k, v in _STATE_NORMALIZATION.items():
        if s.lower() == k.lower():
            s = v
            break

    # Match against canonical list ignoring case
    for canon in INDIA_STATES_AND_UTS:
        if s.lower() == canon.lower():
            return canon

    return s


@lru_cache(maxsize=1)
def load_pincode_directory() -> dict[str, str]:
    """Load {"110001": "Delhi", ...} mapping from JSON."""
    if not PINCODE_DIRECTORY_PATH.exists():
        raise IndiaPincodeDirectoryNotReady(
            f"Missing pincode directory JSON at {PINCODE_DIRECTORY_PATH}. "
            "Create it (full Indian PIN directory) or run: "
            "python manage.py build_pincode_directory --input <csv_path>"
        )

    try:
        with PINCODE_DIRECTORY_PATH.open("r", encoding="utf-8") as f:
            data = json.load(f)
    except Exception as e:
        raise IndiaPincodeDirectoryNotReady(
            f"Unable to read pincode directory JSON at {PINCODE_DIRECTORY_PATH}: {e}"
        )

    mapping: dict[str, str] = {}

    # Preferred format: dict
    if isinstance(data, dict):
        for k, v in data.items():
            pin = re.sub(r"\D", "", str(k or ""))
            if not re.fullmatch(r"\d{6}", pin):
                continue
            state = _canon_state_name(str(v or ""))
            if not state:
                continue
            mapping[pin] = state
        return mapping

    # Alternative format: list of objects
    if isinstance(data, list):
        for row in data:
            if not isinstance(row, dict):
                continue
            pin = re.sub(r"\D", "", str(row.get("pincode") or row.get("pin") or row.get("postal_code") or ""))
            if not re.fullmatch(r"\d{6}", pin):
                continue
            state = _canon_state_name(str(row.get("state") or row.get("State") or row.get("state_name") or ""))
            if not state:
                continue
            mapping[pin] = state
        return mapping

    raise IndiaPincodeDirectoryNotReady(
        f"Unsupported pincode directory JSON format at {PINCODE_DIRECTORY_PATH}. "
        "Expected a dict or list of objects."
    )


def get_state_for_pincode(pincode: str) -> Optional[str]:
    """Return canonical state name for a 6-digit pincode, or None if not found."""
    pin = re.sub(r"\D", "", str(pincode or ""))
    if not re.fullmatch(r"\d{6}", pin):
        return None
    directory = load_pincode_directory()
    state = directory.get(pin)
    if not state:
        return None
    return _canon_state_name(state)

import os
import urllib.request

def get_district_for_pincode(pincode: str) -> Optional[str]:
    """
    Placeholder implementation to fetch district from PIN:
    - Uses India Post public API by default.
    - Replace with your internal PIN master / dataset if you have one.

    Control with env:
      PINCODE_DISTRICT_LOOKUP_MODE = "india_post_api" | "none"
    """
    mode = (os.getenv("PINCODE_DISTRICT_LOOKUP_MODE", "india_post_api") or "").strip().lower()
    if mode in ("none", "off", "0"):
        return None

    pin = re.sub(r"\D", "", str(pincode or ""))
    if not re.fullmatch(r"\d{6}", pin):
        return None

    try:
        url = f"https://api.postalpincode.in/pincode/{pin}"
        with urllib.request.urlopen(url, timeout=3) as resp:
            payload = resp.read().decode("utf-8")
        data = json.loads(payload)
        if not isinstance(data, list) or not data:
            return None
        item = data[0] if isinstance(data[0], dict) else {}
        pos = item.get("PostOffice") or []
        if not pos or not isinstance(pos, list):
            return None
        po0 = pos[0] if isinstance(pos[0], dict) else {}
        district = (po0.get("District") or "").strip()
        return district or None
    except Exception:
        return None


def get_state_and_district_for_pincode(pincode: str) -> tuple[Optional[str], Optional[str]]:
    return get_state_for_pincode(pincode), get_district_for_pincode(pincode)

================================================================================
FILE: accounts/models.py
================================================================================

from __future__ import annotations

import re
import secrets
import string

from django.contrib.auth.models import AbstractBaseUser, BaseUserManager, PermissionsMixin
from django.core.validators import RegexValidator
from django.db import models
from django.utils import timezone


# ---------------------------------------------------------------------
# Constants
# ---------------------------------------------------------------------

INDIA_STATES_AND_UTS = [
    "Andhra Pradesh",
    "Arunachal Pradesh",
    "Assam",
    "Bihar",
    "Chhattisgarh",
    "Goa",
    "Gujarat",
    "Haryana",
    "Himachal Pradesh",
    "Jharkhand",
    "Karnataka",
    "Kerala",
    "Madhya Pradesh",
    "Maharashtra",
    "Manipur",
    "Meghalaya",
    "Mizoram",
    "Nagaland",
    "Odisha",
    "Punjab",
    "Rajasthan",
    "Sikkim",
    "Tamil Nadu",
    "Telangana",
    "Tripura",
    "Uttar Pradesh",
    "Uttarakhand",
    "West Bengal",
    "Andaman and Nicobar Islands",
    "Chandigarh",
    "Dadra and Nagar Haveli and Daman and Diu",
    "Delhi",
    "Jammu and Kashmir",
    "Ladakh",
    "Lakshadweep",
    "Puducherry",
]

INDIA_STATE_CHOICES = [(s, s) for s in INDIA_STATES_AND_UTS]


def extract_postal_code(address_text: str) -> str | None:
    if not address_text:
        return None
    match = re.search(r"(\d{6})", address_text)
    return match.group(1) if match else None


# ---------------------------------------------------------------------
# Custom User
# ---------------------------------------------------------------------

class UserManager(BaseUserManager):
    def create_user(self, email, full_name="", password=None, **extra_fields):
        if not email:
            raise ValueError("The Email must be set")
        email = self.normalize_email(email)
        user = self.model(email=email, full_name=full_name, **extra_fields)
        if password:
            user.set_password(password)
        else:
            user.set_unusable_password()
        user.save(using=self._db)
        return user

    def create_superuser(self, email, full_name="", password=None, **extra_fields):
        extra_fields.setdefault("is_staff", True)
        extra_fields.setdefault("is_superuser", True)
        return self.create_user(email, full_name, password, **extra_fields)


class User(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(unique=True)
    full_name = models.CharField(max_length=255, blank=True)
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)

    # matches DB expectation
    date_joined = models.DateTimeField(default=timezone.now)

    USERNAME_FIELD = "email"
    REQUIRED_FIELDS = []

    objects = UserManager()

    def __str__(self):
        return self.email


# ---------------------------------------------------------------------
# Clinic
# ---------------------------------------------------------------------

import random
import string

import random
import string

class Clinic(models.Model):
    clinic_code = models.CharField(max_length=50, unique=True)
    display_name = models.CharField(max_length=255)
    clinic_phone = models.CharField(max_length=15)
    clinic_whatsapp_number = models.CharField(max_length=10, blank=True, null=True)
    address_text = models.TextField()
    postal_code = models.CharField(max_length=6)
    state = models.CharField(max_length=64, choices=INDIA_STATE_CHOICES)

    def generate_clinic_code(self):
        """Generates a unique clinic code."""
        return ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))

    def save(self, *args, **kwargs):
        """Ensure the clinic_code is generated if not provided."""
        if not self.clinic_code:
            self.clinic_code = self.generate_clinic_code()
        super().save(*args, **kwargs)
    
    def __str__(self):
        return self.display_name



# ---------------------------------------------------------------------
# Doctor Profile
# ---------------------------------------------------------------------

def default_doctor_id() -> str:
    alphabet = string.ascii_uppercase + string.digits
    return "".join(secrets.choice(alphabet) for _ in range(8))


class DoctorProfile(models.Model):
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name="doctor_profile"
    )

    doctor_id = models.CharField(max_length=12, unique=True, default=default_doctor_id)
    whatsapp_number = models.CharField(max_length=10, unique=True)
    imc_number = models.CharField(max_length=64)
    postal_code = models.CharField(max_length=6, blank=True, null=True)
    photo = models.ImageField(upload_to="doctor_photos/", null=True, blank=True)

    clinic = models.ForeignKey(
        Clinic,
        on_delete=models.CASCADE,
        db_column="clinic_id"
    )

    # REQUIRED by DB
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.user.email} ({self.doctor_id})"

================================================================================
FILE: accounts/sendgrid_utils.py
================================================================================

from __future__ import annotations

import hashlib
import html as html_lib
import json
import os
import smtplib
import socket
import ssl
from dataclasses import dataclass
from email.message import EmailMessage
from typing import Iterable, Optional, Tuple
from urllib.error import HTTPError, URLError
from urllib.request import Request, urlopen

from django.apps import apps
from django.conf import settings

from peds_edu.aws_secrets import get_last_error, get_secret_string

SENDGRID_API_URL = "https://api.sendgrid.com/v3/mail/send"


def _truncate(s: str, limit: int = 12000) -> str:
    s = s or ""
    if len(s) <= limit:
        return s
    return s[:limit] + f"\n... (truncated; len={len(s)})"


def _sanitize_secret(s: str) -> str:
    s = (s or "").strip()
    if not s:
        return ""
    if s.lower().startswith("bearer "):
        s = s[7:].strip()
    if (s.startswith('"') and s.endswith('"')) or (s.startswith("'") and s.endswith("'")):
        s = s[1:-1].strip()
    return s.strip()


def _extract_sendgrid_key(raw: str) -> str:
    """
    Supports secrets stored as:
      - Plain string: "SG...."
      - JSON: {"SendGrid_email":"SG...."}  <-- YOUR CURRENT SECRET FORMAT
      - JSON: {"SENDGRID_API_KEY":"SG...."} or {"api_key":"SG...."} etc.
    """
    raw = (raw or "").strip()
    if not raw:
        return ""

    if raw.startswith("{") and raw.endswith("}"):
        try:
            obj = json.loads(raw)
            if isinstance(obj, dict):
                for k in (
                    # Your sample output key
                    "SendGrid_email",
                    "sendgrid_email",
                    # Other common variants
                    "SENDGRID_API_KEY",
                    "sendgrid_api_key",
                    "api_key",
                    "apikey",
                    "key",
                    "SENDGRID_KEY",
                    "sendgrid_key",
                ):
                    v = obj.get(k)
                    if isinstance(v, str) and v.strip():
                        return _sanitize_secret(v)
        except Exception:
            pass

    return _sanitize_secret(raw)


def _fingerprint(secret: str) -> str:
    secret = secret or ""
    if not secret:
        return "missing"
    h = hashlib.sha256(secret.encode("utf-8")).hexdigest()[:12]
    return f"len={len(secret)} sha256_12={h}"


def _redacted_tail(secret: str, n: int = 4) -> str:
    secret = secret or ""
    if len(secret) < max(1, n):
        return "<short>"
    return secret[-n:]


def _aws_region() -> str:
    return (
        os.getenv("AWS_REGION")
        or os.getenv("AWS_DEFAULT_REGION")
        or getattr(settings, "AWS_REGION", None)
        or "ap-south-1"
    )


def _aws_secret_name() -> str:
    return (
        os.getenv("SENDGRID_SECRET_NAME")
        or getattr(settings, "SENDGRID_SECRET_NAME", None)
        or "SendGrid_API"
    )


def _get_secret_string_uncached(secret_name: str, region_name: str) -> Tuple[str, Optional[str]]:
    try:
        wrapped = getattr(get_secret_string, "__wrapped__", None)
        if wrapped is not None:
            val = wrapped(secret_name, region_name=region_name)  # type: ignore[misc]
        else:
            val = get_secret_string(secret_name, region_name=region_name)

        err = (get_last_error() or "").strip()
        return (val or "").strip(), (err or None)
    except Exception as e:
        return "", f"{type(e).__name__}: {e}"


@dataclass(frozen=True)
class _KeyCandidate:
    source: str
    key: str

    @property
    def fp(self) -> str:
        return _fingerprint(self.key)

    @property
    def tail(self) -> str:
        try:
            n = int(os.getenv("SENDGRID_KEY_TAIL_CHARS", "4"))
        except Exception:
            n = 4
        n = max(2, min(12, n))
        return _redacted_tail(self.key, n=n)


def _iter_sendgrid_api_key_candidates() -> Tuple[list[_KeyCandidate], dict]:
    region = _aws_region()
    secret_name = _aws_secret_name()

    diag = {
        "secret_name": secret_name,
        "region": region,
        "aws_secret_attempted": True,
        "aws_secret_error": "",
        "aws_secret_value_present": False,
    }

    candidates_raw: list[tuple[str, str]] = []

    # AWS Secrets first
    secret_raw, secret_err = _get_secret_string_uncached(secret_name, region)
    if secret_err:
        diag["aws_secret_error"] = secret_err
    if secret_raw:
        diag["aws_secret_value_present"] = True

    secret_key = _extract_sendgrid_key(secret_raw)
    if secret_key:
        candidates_raw.append((f"aws_secrets:{secret_name}@{region}", secret_key))

    # Settings/env fallbacks
    candidates_raw.append(("settings.SENDGRID_API_KEY", str(getattr(settings, "SENDGRID_API_KEY", "") or "")))
    candidates_raw.append(("settings.EMAIL_HOST_PASSWORD", str(getattr(settings, "EMAIL_HOST_PASSWORD", "") or "")))
    candidates_raw.append(("env:SENDGRID_API_KEY", os.getenv("SENDGRID_API_KEY", "") or ""))
    candidates_raw.append(("env:EMAIL_HOST_PASSWORD", os.getenv("EMAIL_HOST_PASSWORD", "") or ""))

    out: list[_KeyCandidate] = []
    seen_fp: set[str] = set()
    for src, raw in candidates_raw:
        key = _extract_sendgrid_key(raw)
        if not key:
            continue
        fp = _fingerprint(key)
        if fp in seen_fp:
            continue
        seen_fp.add(fp)
        out.append(_KeyCandidate(source=src, key=key))

    return out, diag


def _resolve_from_email(from_email: Optional[str] = None) -> str:
    if from_email and str(from_email).strip():
        return str(from_email).strip()
    v = getattr(settings, "SENDGRID_FROM_EMAIL", None) or getattr(settings, "DEFAULT_FROM_EMAIL", None)
    if v and str(v).strip():
        return str(v).strip()
    return "no-reply@example.com"


def _get_backend_mode() -> str:
    v = str(getattr(settings, "EMAIL_BACKEND_MODE", "") or "").strip().lower()
    if v in ("sendgrid", "smtp", "console"):
        return v
    # Default: if we have any key candidate, prefer sendgrid API
    cands, _ = _iter_sendgrid_api_key_candidates()
    return "sendgrid" if cands else "smtp"


def _probe_tcp(host: str, port: int, timeout: float = 3.0) -> str:
    try:
        with socket.create_connection((host, port), timeout=timeout):
            return "tcp_ok"
    except Exception as e:
        return f"tcp_fail:{type(e).__name__}"


def _log_email_attempt(
    *,
    to_email: str,
    subject: str,
    provider: str,
    success: bool,
    status_code: Optional[int] = None,
    response_body: str = "",
    error: str = "",
) -> None:
    try:
        EmailLog = apps.get_model("accounts", "EmailLog")
    except Exception:
        EmailLog = None

    if EmailLog is None:
        return

    try:
        EmailLog.objects.create(
            to_email=to_email,
            subject=subject,
            provider=provider,
            success=bool(success),
            status_code=status_code,
            response_body=_truncate(response_body or ""),
            error=_truncate(error or "", limit=8000),
        )
    except Exception:
        return


def _send_via_sendgrid_api(
    *,
    subject: str,
    to_emails: list[str],
    plain_text: str,
    from_email: str,
) -> Tuple[bool, Optional[int], str, str]:
    candidates, aws_diag = _iter_sendgrid_api_key_candidates()

    diag_base = {
        "provider": "sendgrid",
        "from_email": from_email,
        "to_count": len(to_emails),
        "aws_secrets": aws_diag,
        "candidates": [{"source": c.source, "fp": c.fp} for c in candidates],
        "sendgrid_api_url": SENDGRID_API_URL,
        "authorization_header_set": True,
    }

    if not candidates:
        return False, None, json.dumps(diag_base), "No SendGrid API key candidates found"

    safe_html = "<pre>" + html_lib.escape(plain_text or "") + "</pre>"

    payload = {
        "personalizations": [{"to": [{"email": e} for e in to_emails]}],
        "from": {"email": from_email},
        "subject": subject,
        "content": [
            {"type": "text/plain", "value": plain_text or ""},
            {"type": "text/html", "value": safe_html},
        ],
    }
    payload_bytes = json.dumps(payload).encode("utf-8")

    last_status: Optional[int] = None
    last_err_text: str = ""
    last_err_body: str = ""

    for cand in candidates:
        api_key = cand.key
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json",
        }

        try:
            req = Request(SENDGRID_API_URL, data=payload_bytes, headers=headers, method="POST")
            with urlopen(req, timeout=25) as resp:
                status = getattr(resp, "status", None) or resp.getcode()
                body = resp.read().decode("utf-8", errors="ignore") if resp else ""

            ok = isinstance(status, int) and 200 <= status < 300

            diag = dict(diag_base)
            diag.update(
                {
                    "selected_source": cand.source,
                    "sendgrid_api_key_fp": cand.fp,
                    "sendgrid_api_key_tail": cand.tail,
                    "status_code": status,
                }
            )

            combined = json.dumps(diag)
            if body:
                combined += "\n" + _truncate(body, 12000)

            if ok:
                return True, int(status), combined, ""

            last_status = int(status) if isinstance(status, int) else None
            last_err_text = f"HTTP {status}"
            last_err_body = body

            if status in (401, 403):
                continue

            break

        except HTTPError as e:
            status = getattr(e, "code", None)
            body = ""
            try:
                body = e.read().decode("utf-8", errors="ignore")  # type: ignore[attr-defined]
            except Exception:
                pass
            last_status = int(status) if isinstance(status, int) else None
            last_err_text = f"HTTPError {status}"
            last_err_body = body
            if status in (401, 403):
                continue
            break
        except URLError as e:
            last_status = None
            last_err_text = f"URLError: {e}"
            break
        except Exception as e:
            last_status = None
            last_err_text = f"{type(e).__name__}: {e}"
            break

    diag = dict(diag_base)
    diag.update({"selected_source": None, "last_status": last_status, "last_error": _truncate(last_err_text, 2000)})
    combined = json.dumps(diag)
    if last_err_body:
        combined += "\n" + _truncate(last_err_body, 12000)
    return False, last_status, combined, last_err_text or "SendGrid API send failed"


def _send_via_smtp(
    *,
    subject: str,
    to_emails: list[str],
    plain_text: str,
    from_email: str,
) -> Tuple[bool, Optional[int], str, str]:
    host = str(getattr(settings, "EMAIL_HOST", "") or "smtp.sendgrid.net").strip()
    port = int(getattr(settings, "EMAIL_PORT", 587) or 587)
    use_tls = bool(getattr(settings, "EMAIL_USE_TLS", True))
    use_ssl = bool(getattr(settings, "EMAIL_USE_SSL", False))
    user = str(getattr(settings, "EMAIL_HOST_USER", "apikey") or "apikey").strip()

    candidates, aws_diag = _iter_sendgrid_api_key_candidates()
    probe = _probe_tcp(host, port)

    # Prefer EMAIL_HOST_PASSWORD, but allow SendGrid candidates as SMTP password
    pw = _sanitize_secret(str(getattr(settings, "EMAIL_HOST_PASSWORD", "") or ""))
    pw_src = "settings.EMAIL_HOST_PASSWORD"
    if not pw and candidates:
        pw = candidates[0].key
        pw_src = candidates[0].source

    if not pw:
        diag = {
            "provider": "smtp",
            "host": host,
            "port": port,
            "use_tls": use_tls,
            "use_ssl": use_ssl,
            "probe": probe,
            "aws_secrets": aws_diag,
        }
        return False, None, json.dumps(diag), "No SMTP password available"

    msg = EmailMessage()
    msg["Subject"] = subject
    msg["From"] = from_email
    msg["To"] = ", ".join(to_emails)
    msg.set_content(plain_text or "")

    try:
        if use_ssl:
            server: smtplib.SMTP = smtplib.SMTP_SSL(host=host, port=port, timeout=20)
        else:
            server = smtplib.SMTP(host=host, port=port, timeout=20)

        try:
            server.ehlo()
            if use_tls and not use_ssl:
                ctx = ssl.create_default_context()
                server.starttls(context=ctx)
                server.ehlo()
            server.login(user, pw)
            server.send_message(msg)
            try:
                server.quit()
            except Exception:
                pass
        finally:
            try:
                server.close()
            except Exception:
                pass

        diag = {
            "provider": "smtp",
            "host": host,
            "port": port,
            "use_tls": use_tls,
            "use_ssl": use_ssl,
            "probe": probe,
            "smtp_user": user,
            "smtp_password_source": pw_src,
            "smtp_password_tail": _redacted_tail(pw, 4),
            "aws_secrets": aws_diag,
        }
        return True, 250, json.dumps(diag), ""
    except Exception as e:
        diag = {
            "provider": "smtp",
            "host": host,
            "port": port,
            "use_tls": use_tls,
            "use_ssl": use_ssl,
            "probe": probe,
            "smtp_user": user,
            "smtp_password_source": pw_src,
            "aws_secrets": aws_diag,
        }
        return False, None, json.dumps(diag), str(e)


def send_email_via_sendgrid(
    subject: str,
    to_emails: Iterable[str],
    plain_text_content: str,
    from_email: Optional[str] = None,
) -> bool:
    subject = (subject or "").strip()
    recipients = [str(e).strip() for e in (to_emails or []) if e and str(e).strip()]
    recipients = list(dict.fromkeys(recipients))

    if not subject or not recipients:
        for r in recipients or [""]:
            _log_email_attempt(
                to_email=r or "(missing)",
                subject=subject or "(missing)",
                provider="internal",
                success=False,
                status_code=None,
                response_body="",
                error="Missing subject and/or recipients",
            )
        return False

    mode = _get_backend_mode()
    from_addr = _resolve_from_email(from_email)

    providers = ["smtp", "sendgrid"] if mode == "smtp" else ["sendgrid", "smtp"]

    for provider in providers:
        if provider == "sendgrid":
            ok, status, resp_body, err = _send_via_sendgrid_api(
                subject=subject,
                to_emails=recipients,
                plain_text=plain_text_content or "",
                from_email=from_addr,
            )
        else:
            ok, status, resp_body, err = _send_via_smtp(
                subject=subject,
                to_emails=recipients,
                plain_text=plain_text_content or "",
                from_email=from_addr,
            )

        for r in recipients:
            _log_email_attempt(
                to_email=r,
                subject=subject,
                provider=provider,
                success=ok,
                status_code=status,
                response_body=resp_body,
                error=err,
            )

        if ok:
            return True

    return False

================================================================================
FILE: accounts/__init__.py
================================================================================

default_app_config = "accounts.apps.AccountsConfig"

================================================================================
FILE: accounts/tokens.py
================================================================================

from django.contrib.auth.tokens import PasswordResetTokenGenerator


class DoctorPasswordTokenGenerator(PasswordResetTokenGenerator):
    """Token generator for doctor password setup/reset."""


doctor_password_token = DoctorPasswordTokenGenerator()

================================================================================
FILE: accounts/apps.py
================================================================================

from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "accounts"

================================================================================
FILE: accounts/forms.py
================================================================================

from __future__ import annotations


from django import forms
from django.contrib.auth.forms import AuthenticationForm, SetPasswordForm
from django.core.validators import RegexValidator


import re
from django import forms
from django.core.validators import RegexValidator

# Keep the existing RegexValidator import if already present above; otherwise add it.

_digits_only = RegexValidator(r"^\d+$", "Digits only.")
_pin_6 = RegexValidator(r"^\d{6}$", "PIN must be 6 digits.")
_phone_like = RegexValidator(r"^\d{8,15}$", "Enter a valid phone number (digits only).")


class DoctorRegistrationForm(forms.Form):
    # passed in URL (and persisted via hidden fields)
    campaign_id = forms.CharField(required=False, widget=forms.HiddenInput())
    field_rep_id = forms.CharField(required=False, widget=forms.HiddenInput())

    first_name = forms.CharField(label="First Name", max_length=150, required=True)
    last_name = forms.CharField(label="Last name", max_length=150, required=True)
    email = forms.EmailField(label="Email", required=True)

    clinic_name = forms.CharField(label="Clinic name", max_length=255, required=True)

    imc_registration_number = forms.CharField(
        label="Doctor’s IMC Registration Number",
        max_length=30,
        required=True,
        validators=[_digits_only],
    )

    clinic_appointment_number = forms.CharField(
        label="Clinic Appointment Booking Number (phone)",
        max_length=20,
        required=True,
        validators=[_phone_like],
    )

    clinic_address = forms.CharField(
        label="Clinic Address (full address)",
        required=True,
        widget=forms.Textarea(attrs={"rows": 4}),
    )

    postal_code = forms.CharField(
        label="Postal Code (PIN – 6 digits)",
        max_length=6,
        required=True,
        validators=[_pin_6],
    )

    clinic_whatsapp_number = forms.CharField(
        label="Clinic WhatsApp Number",
        max_length=20,
        required=True,
        validators=[_phone_like],
    )

    photo = forms.ImageField(label="Doctor’s Photo (JPEG/JPG/PNG upload)", required=True)

    def save_to_master_db(
        self,
        *,
        doctor_id: str,
        state: str,
        district: str,
        photo_path: str,
        recruited_via: str,
    ) -> None:
        """
        Inserts into MASTER DB:
          1) Doctor
          2) DoctorCampaignEnrollment
        """
        if not self.is_valid():
            raise ValueError("Form must be valid before calling save_to_master_db().")

        from . import master_db  # local import
        from django.db import IntegrityError

        cd = self.cleaned_data

        campaign_id = (cd.get("campaign_id") or "").strip()
        field_rep_id = (cd.get("field_rep_id") or "").strip()

        master_db.insert_doctor_row(
            doctor_id=doctor_id,
            first_name=cd["first_name"].strip(),
            last_name=cd["last_name"].strip(),
            email=cd["email"].strip().lower(),
            clinic_name=cd["clinic_name"].strip(),
            imc_registration_number=cd["imc_registration_number"].strip(),
            clinic_phone=cd["clinic_appointment_number"].strip(),
            clinic_appointment_number=cd["clinic_appointment_number"].strip(),
            clinic_address=cd["clinic_address"].strip(),
            postal_code=cd["postal_code"].strip(),
            state=state or "",
            district=district or "",
            whatsapp_no=cd["clinic_whatsapp_number"].strip(),
            receptionist_whatsapp_number=cd["clinic_whatsapp_number"].strip(),
            photo_path=photo_path or "",
            field_rep_id=field_rep_id,
            recruited_via=recruited_via,
        )

        # Enrollment insert (only if campaign_id present)
        if campaign_id:
            try:
                master_db.ensure_enrollment(
                    doctor_id=doctor_id,
                    campaign_id=campaign_id,
                    registered_by=field_rep_id,
                )
            except IntegrityError:
                # ignore duplicates
                pass

class DoctorClinicDetailsForm(forms.Form):
    doctor_id = forms.CharField(label="Doctor ID", max_length=12, required=True, widget=forms.TextInput(attrs={"readonly": "readonly"}))
    full_name = forms.CharField(label="Full Name", max_length=255, required=True)
    email = forms.EmailField(label="Email", required=True)
    whatsapp_number = forms.CharField(label="WhatsApp Number", max_length=20, required=True)
    clinic_number = forms.CharField(label="Clinic Phone Number", max_length=20, required=True)
    clinic_whatsapp_number = forms.CharField(label="Clinic WhatsApp Number", max_length=20, required=True)
    imc_number = forms.CharField(label="IMC Registration Number", max_length=20, required=True)
    postal_code = forms.CharField(label="Postal Code (PIN)", max_length=6, required=True)
    address_text = forms.CharField(label="Clinic Address", required=True, widget=forms.Textarea(attrs={"rows": 4}))
    photo = forms.ImageField(label="Doctor Photo (optional)", required=False)


class EmailAuthenticationForm(AuthenticationForm):
    username = forms.EmailField(label="Email")


class DoctorSetPasswordForm(SetPasswordForm):
    pass

================================================================================
FILE: accounts/admin.py
================================================================================

from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as DjangoUserAdmin

from .models import User, Clinic, DoctorProfile
from .email_log import EmailLog


# ---------------------------------------------------------------------
# Email Log
# ---------------------------------------------------------------------

@admin.register(EmailLog)
class EmailLogAdmin(admin.ModelAdmin):
    list_display = ("created_at", "to_email", "subject", "success", "status_code")
    search_fields = ("to_email", "subject", "response_body", "error")
    list_filter = ("success", "provider", "created_at")


# ---------------------------------------------------------------------
# User Admin
# ---------------------------------------------------------------------

@admin.register(User)
class UserAdmin(DjangoUserAdmin):
    ordering = ("email",)
    list_display = ("email", "full_name", "is_staff", "is_active")
    search_fields = ("email", "full_name")

    fieldsets = (
        (None, {"fields": ("email", "password", "full_name")}),
        (
            "Permissions",
            {
                "fields": (
                    "is_active",
                    "is_staff",
                    "is_superuser",
                    "groups",
                    "user_permissions",
                )
            },
        ),
        ("Important dates", {"fields": ("last_login",)}),
    )

    add_fieldsets = (
        (
            None,
            {
                "classes": ("wide",),
                "fields": ("email", "full_name", "password1", "password2"),
            },
        ),
    )


# ---------------------------------------------------------------------
# Clinic Admin
# ---------------------------------------------------------------------

@admin.register(Clinic)
class ClinicAdmin(admin.ModelAdmin):
    list_display = ("clinic_code", "display_name", "state", "clinic_phone")
    search_fields = ("display_name", "clinic_phone", "state")

    def clinic_code(self, obj):
        """
        Admin-only readable clinic identifier.
        Example: CLN-0001
        """
        return f"CLN-{obj.id:04d}" if obj.id else "-"

    clinic_code.short_description = "Clinic Code"
    clinic_code.admin_order_field = "id"


# ---------------------------------------------------------------------
# Doctor Profile Admin
# ---------------------------------------------------------------------

@admin.register(DoctorProfile)
class DoctorProfileAdmin(admin.ModelAdmin):
    list_display = (
        "doctor_id",
        "user",
        "clinic",
        "whatsapp_number",
        "imc_number",
    )
    search_fields = (
        "doctor_id",
        "user__email",
        "user__full_name",
        "whatsapp_number",
        "imc_number",
    )
    list_select_related = ("user", "clinic")

================================================================================
FILE: accounts/master_db.py
================================================================================

from __future__ import annotations

import json
import re
import time
from dataclasses import dataclass
from typing import Optional
from urllib.parse import quote

from django.conf import settings
from django.db import connections, IntegrityError


class MasterDBNotConfigured(RuntimeError):
    pass


def master_alias() -> str:
    return getattr(settings, "MASTER_DB_ALIAS", "master")


def get_master_connection():
    alias = master_alias()
    if alias not in connections.databases:
        raise MasterDBNotConfigured(
            f"MASTER DB alias '{alias}' is not configured in settings.DATABASES."
        )
    return connections[alias]


def qn(name: str) -> str:
    """
    Quote identifiers safely per backend.
    Supports schema-qualified names like: schema.table
    """
    conn = get_master_connection()
    parts = [p for p in (name or "").split(".") if p]
    if len(parts) > 1:
        return ".".join(conn.ops.quote_name(p) for p in parts)
    return conn.ops.quote_name(name)


# -------------------------------
# WhatsApp helpers
# -------------------------------

def normalize_wa_for_lookup(raw: str) -> str:
    s = re.sub(r"\D", "", str(raw or ""))
    if len(s) == 12 and s.startswith("91"):
        return s[2:]
    return s


def wa_link_number(raw: str, default_country_code: str = "91") -> str:
    s = re.sub(r"\D", "", str(raw or ""))
    if len(s) == 10:
        return f"{default_country_code}{s}"
    if s.startswith("0") and len(s) == 11:
        return f"{default_country_code}{s[1:]}"
    return s


def build_whatsapp_deeplink(raw_phone: str, message: str) -> str:
    phone = wa_link_number(raw_phone)
    return f"https://wa.me/{phone}?text={quote(message or '')}"


# -------------------------------
# MASTER: AuthorizedPublisher
# -------------------------------

def authorized_publisher_exists(email: str) -> bool:
    """
    Checks AuthorizedPublisher in MASTER DB.
    """
    e = (email or "").strip().lower()
    if not e:
        return False

    conn = get_master_connection()
    table = getattr(settings, "MASTER_DB_AUTH_PUBLISHER_TABLE", "publisher_authorizedpublisher")
    email_col = getattr(settings, "MASTER_DB_AUTH_PUBLISHER_EMAIL_COLUMN", "email")

    sql = f"SELECT 1 FROM {qn(table)} WHERE LOWER({qn(email_col)}) = LOWER(%s) LIMIT 1"
    with conn.cursor() as cur:
        cur.execute(sql, [e])
        return cur.fetchone() is not None


# -------------------------------
# MASTER: FieldRep
# -------------------------------

@dataclass(frozen=True)
class MasterFieldRep:
    id: str
    full_name: str
    phone_number: str
    brand_supplied_field_rep_id: str
    is_active: bool


# -------------------------------
# MASTER: Campaign
# -------------------------------

@dataclass(frozen=True)
class MasterCampaign:
    campaign_id: str
    doctors_supported: int
    wa_addition: str
    new_video_cluster_name: str
    email_registration: str


def get_campaign(campaign_id: str) -> Optional[MasterCampaign]:
    """
    MASTER Campaign lookup for the admin-project schema.

    - Campaign PK column is 'id' (UUIDField).
    - In MySQL, UUIDField is typically stored as CHAR(32) without hyphens.
    - Accepts both:
        7ea0883d-9791-4703-b569-c1f9f8d25705  (hyphenated)
        7ea0883d97914703b569c1f9f8d25705      (hex)
    """
    cid_raw = (campaign_id or "").strip()
    if not cid_raw:
        return None

    cid_norm = cid_raw.replace("-", "")

    conn = get_master_connection()

    table = getattr(settings, "MASTER_DB_CAMPAIGN_TABLE", "campaign_campaign")
    id_col = getattr(settings, "MASTER_DB_CAMPAIGN_ID_COLUMN", "id")

    ds_col = getattr(settings, "MASTER_DB_CAMPAIGN_DOCTORS_SUPPORTED_COLUMN", "num_doctors_supported")
    wa_col = getattr(settings, "MASTER_DB_CAMPAIGN_WA_ADDITION_COLUMN", "add_to_campaign_message")
    vc_col = getattr(settings, "MASTER_DB_CAMPAIGN_VIDEO_CLUSTER_COLUMN", "name")
    er_col = getattr(settings, "MASTER_DB_CAMPAIGN_EMAIL_REGISTRATION_COLUMN", "register_message")

    sql = (
        f"SELECT {qn(id_col)}, {qn(ds_col)}, {qn(wa_col)}, {qn(vc_col)}, {qn(er_col)} "
        f"FROM {qn(table)} "
        f"WHERE {qn(id_col)} = %s OR {qn(id_col)} = %s "
        f"LIMIT 1"
    )

    with conn.cursor() as cur:
        cur.execute(sql, [cid_norm, cid_raw])
        row = cur.fetchone()

    if not row:
        return None

    try:
        doctors_supported = int(row[1] or 0)
    except Exception:
        doctors_supported = 0

    return MasterCampaign(
        campaign_id=str(row[0] or "").strip(),  # will typically be CHAR(32) (no hyphens)
        doctors_supported=doctors_supported,
        wa_addition=str(row[2] or ""),          # mapped from add_to_campaign_message
        new_video_cluster_name=str(row[3] or ""),  # mapped from name
        email_registration=str(row[4] or ""),   # mapped from register_message
    )



# -------------------------------
# MASTER: Doctor & Enrollment (as before)
# -------------------------------

@dataclass(frozen=True)
class MasterDoctor:
    doctor_id: str
    first_name: str = ""
    last_name: str = ""
    email: str = ""
    whatsapp_no: str = ""

    @property
    def full_name(self) -> str:
        return (f"{self.first_name} {self.last_name}").strip()


def doctor_id_exists(doctor_id: str) -> bool:
    did = (doctor_id or "").strip()
    if not did:
        return False

    conn = get_master_connection()
    table = getattr(settings, "MASTER_DB_DOCTOR_TABLE", "redflags_doctor")
    id_col = getattr(settings, "MASTER_DB_DOCTOR_ID_COLUMN", "doctor_id")

    sql = f"SELECT 1 FROM {qn(table)} WHERE {qn(id_col)} = %s LIMIT 1"
    with conn.cursor() as cur:
        cur.execute(sql, [did])
        return cur.fetchone() is not None



def get_doctor_by_whatsapp(whatsapp_no: str) -> Optional[MasterDoctor]:
    """
    Lookup doctor in MASTER DB by WhatsApp number from table redflags_doctor.

    Handles common formatting:
      - 10 digit
      - 91 + 10 digit
      - +91 + 10 digit
      - 0 + 10 digit
      - mixed formatting with spaces/dashes

    Returns MasterDoctor or None.
    """
    import re

    raw = (whatsapp_no or "").strip()
    digits = re.sub(r"\D", "", raw)

    if not digits:
        return None

    # Normalize down to 10 digits where possible
    base10 = digits
    if len(base10) == 12 and base10.startswith("91"):
        base10 = base10[2:]
    elif len(base10) == 11 and base10.startswith("0"):
        base10 = base10[1:]
    elif len(base10) > 10:
        # last 10 digits is often the actual number
        base10 = base10[-10:]

    candidates = []
    seen = set()

    def _add(x: str) -> None:
        x = (x or "").strip()
        if x and x not in seen:
            seen.add(x)
            candidates.append(x)

    # Add candidates in likely-match order
    _add(base10)                 # 10-digit
    _add("91" + base10)          # 91XXXXXXXXXX
    _add("+91" + base10)         # +91XXXXXXXXXX
    _add("0" + base10)           # 0XXXXXXXXXX
    _add(digits)                 # original digits-only form (fallback)

    conn = get_master_connection()

    table = getattr(settings, "MASTER_DB_DOCTOR_TABLE", "redflags_doctor")
    id_col = getattr(settings, "MASTER_DB_DOCTOR_ID_COLUMN", "doctor_id")
    fn_col = getattr(settings, "MASTER_DB_DOCTOR_FIRST_NAME_COLUMN", "first_name")
    ln_col = getattr(settings, "MASTER_DB_DOCTOR_LAST_NAME_COLUMN", "last_name")
    email_col = getattr(settings, "MASTER_DB_DOCTOR_EMAIL_COLUMN", "email")
    wa_col = getattr(settings, "MASTER_DB_DOCTOR_WHATSAPP_COLUMN", "whatsapp_no")

    where = " OR ".join([f"{qn(wa_col)} = %s"] * len(candidates))
    sql = (
        f"SELECT {qn(id_col)}, {qn(fn_col)}, {qn(ln_col)}, {qn(email_col)}, {qn(wa_col)} "
        f"FROM {qn(table)} "
        f"WHERE {where} "
        f"LIMIT 1"
    )

    with conn.cursor() as cur:
        cur.execute(sql, candidates)
        row = cur.fetchone()

    if not row:
        return None

    return MasterDoctor(
        doctor_id=str(row[0] or "").strip(),
        first_name=str(row[1] or "").strip(),
        last_name=str(row[2] or "").strip(),
        email=str(row[3] or "").strip(),
        whatsapp_no=str(row[4] or "").strip(),
    )



from typing import Dict, List, Optional, Tuple

_ENROLLMENT_META_CACHE: Optional[Dict[str, str]] = None


def _db_schema_name(conn) -> str:
    return (conn.settings_dict.get("NAME") or "").strip()


def _table_exists(conn, table_name: str) -> bool:
    schema = _db_schema_name(conn)
    if not schema or not table_name:
        return False
    sql = """
        SELECT 1
        FROM information_schema.tables
        WHERE table_schema = %s AND table_name = %s
        LIMIT 1
    """
    with conn.cursor() as cur:
        cur.execute(sql, [schema, table_name])
        return cur.fetchone() is not None


def _find_table_by_patterns(conn, patterns: List[str]) -> Optional[str]:
    """
    Find the first table whose name matches any of the LIKE patterns (case-insensitive).
    """
    schema = _db_schema_name(conn)
    if not schema:
        return None

    sql = """
        SELECT table_name
        FROM information_schema.tables
        WHERE table_schema = %s AND LOWER(table_name) LIKE %s
        ORDER BY LENGTH(table_name) ASC, table_name ASC
        LIMIT 1
    """

    for pat in patterns:
        with conn.cursor() as cur:
            cur.execute(sql, [schema, pat.lower()])
            row = cur.fetchone()
        if row and row[0]:
            return str(row[0])
    return None


def _get_table_columns(conn, table_name: str) -> List[str]:
    schema = _db_schema_name(conn)
    sql = """
        SELECT column_name
        FROM information_schema.columns
        WHERE table_schema = %s AND table_name = %s
    """
    with conn.cursor() as cur:
        cur.execute(sql, [schema, table_name])
        rows = cur.fetchall()
    return [str(r[0]) for r in (rows or []) if r and r[0]]


def _pick_first_column(cols: List[str], candidates: List[str]) -> Optional[str]:
    cols_l = {c.lower(): c for c in cols}
    for cand in candidates:
        if cand.lower() in cols_l:
            return cols_l[cand.lower()]
    return None


def _normalize_uuid_for_mysql(raw: str) -> str:
    """
    MySQL Django UUIDField commonly stored as CHAR(32) without hyphens.
    """
    return (raw or "").strip().replace("-", "")


def _get_enrollment_meta() -> Dict[str, str]:
    """
    Discover enrollment table + columns once per process and cache.

    Returns dict:
      {
        "table": <table_name>,
        "campaign_col": <campaign_column_name>,
        "doctor_col": <doctor_column_name>,
        "registered_by_col": <optional column name or "">,
      }
    """
    global _ENROLLMENT_META_CACHE
    if _ENROLLMENT_META_CACHE is not None:
        return _ENROLLMENT_META_CACHE

    conn = get_master_connection()

    # If you hardcoded an explicit table in settings, prefer it.
    explicit_table = (getattr(settings, "MASTER_DB_ENROLLMENT_TABLE", "") or "").strip()
    if explicit_table and _table_exists(conn, explicit_table):
        table = explicit_table
    else:
        # Auto-discover by Django model naming patterns
        patterns = [
            "%doctorcampaignenrollment%",
            "%doctor_campaign_enrollment%",
            "%campaignenrollment%",
            "%enrolment%",  # UK spelling fallback
        ]
        table = _find_table_by_patterns(conn, patterns)

    if not table:
        raise RuntimeError(
            "Enrollment table not found in master DB. "
            "Create/migrate the enrollment model or set settings.MASTER_DB_ENROLLMENT_TABLE explicitly."
        )

    cols = _get_table_columns(conn, table)
    if not cols:
        raise RuntimeError(f"Could not read columns for enrollment table '{table}' in master DB.")

    # Common Django FK column naming: campaign_id, doctor_id, registered_by_id
    campaign_col = _pick_first_column(cols, ["campaign_id", "campaign", "campaign_uuid"])
    doctor_col = _pick_first_column(cols, ["doctor_id", "doctor", "doctor_uuid"])

    # registered_by may be FK to FieldRep => registered_by_id
    registered_by_col = _pick_first_column(
        cols,
        ["registered_by_id", "registered_by", "field_rep_id", "fieldrep_id"],
    )

    if not campaign_col or not doctor_col:
        raise RuntimeError(
            f"Enrollment table '{table}' does not have expected columns. "
            f"Found columns: {cols}"
        )

    _ENROLLMENT_META_CACHE = {
        "table": table,
        "campaign_col": campaign_col,
        "doctor_col": doctor_col,
        "registered_by_col": registered_by_col or "",
    }

    print(json.dumps({
        "ts": int(time.time()),
        "event": "master_db.enrollment_meta.discovered",
        "table": table,
        "campaign_col": campaign_col,
        "doctor_col": doctor_col,
        "registered_by_col": registered_by_col or "",
    }, default=str))

    return _ENROLLMENT_META_CACHE


def count_campaign_enrollments(campaign_id: str) -> int:
    """
    Count doctors enrolled for a campaign in MASTER DB.
    Tries both hyphenated and non-hyphenated UUID formats.
    """
    meta = _get_enrollment_meta()
    table = meta["table"]
    campaign_col = meta["campaign_col"]

    cid_raw = (campaign_id or "").strip()
    if not cid_raw:
        return 0

    cid_norm = _normalize_uuid_for_mysql(cid_raw)

    conn = get_master_connection()

    sql = f"SELECT COUNT(*) FROM {qn(table)} WHERE {qn(campaign_col)} = %s"

    counts = []
    with conn.cursor() as cur:
        # normalized (CHAR32)
        cur.execute(sql, [cid_norm])
        row = cur.fetchone()
        counts.append(int(row[0] or 0))

        # raw (hyphenated) only if different
        if cid_raw != cid_norm:
            cur.execute(sql, [cid_raw])
            row = cur.fetchone()
            counts.append(int(row[0] or 0))

    return max(counts) if counts else 0



def insert_doctor_row(
    *,
    doctor_id: str,
    first_name: str,
    last_name: str,
    email: str,
    clinic_name: str,
    imc_registration_number: str,
    clinic_phone: str,
    clinic_appointment_number: str,
    clinic_address: str,
    postal_code: str,
    state: str,
    district: str,
    whatsapp_no: str,
    receptionist_whatsapp_number: str,
    photo_path: str,
    field_rep_id: str = "",
    recruited_via: str = "FIELD_REP",
) -> None:
    conn = get_master_connection()
    table = getattr(settings, "MASTER_DB_DOCTOR_TABLE", "Doctor")

    cols = (
        "doctor_id",
        "first_name",
        "last_name",
        "email",
        "clinic_name",
        "imc_registration_number",
        "clinic_phone",
        "clinic_appointment_number",
        "clinic_address",
        "postal_code",
        "state",
        "district",
        "whatsapp_no",
        "receptionist_whatsapp_number",
        "photo",
        "field_rep_id",
        "recruited_via",
    )

    vals = [
        doctor_id,
        first_name,
        last_name,
        email.lower(),
        clinic_name,
        imc_registration_number,
        clinic_phone,
        clinic_appointment_number,
        clinic_address,
        postal_code,
        state,
        district,
        normalize_wa_for_lookup(whatsapp_no) or whatsapp_no,
        normalize_wa_for_lookup(receptionist_whatsapp_number) or receptionist_whatsapp_number,
        photo_path or "",
        field_rep_id or "",
        recruited_via or "FIELD_REP",
    ]

    placeholders = ", ".join(["%s"] * len(cols))
    sql = f"INSERT INTO {qn(table)} ({', '.join(qn(c) for c in cols)}) VALUES ({placeholders})"
    with conn.cursor() as cur:
        cur.execute(sql, vals)


def ensure_enrollment(*, doctor_id: str, campaign_id: str, registered_by: str) -> None:
    """
    Insert enrollment row in MASTER DB (MySQL) if not already present.
    Uses INSERT IGNORE to avoid duplicate key failures (if unique constraint exists).
    """
    if not (doctor_id and campaign_id):
        return

    meta = _get_enrollment_meta()
    table = meta["table"]
    doctor_col = meta["doctor_col"]
    campaign_col = meta["campaign_col"]
    registered_by_col = meta.get("registered_by_col") or ""

    cid_raw = (campaign_id or "").strip()
    cid_norm = _normalize_uuid_for_mysql(cid_raw)

    cols = [doctor_col, campaign_col]
    vals = [doctor_id, cid_norm]

    if registered_by_col:
        cols.append(registered_by_col)
        vals.append(registered_by or "")

    placeholders = ", ".join(["%s"] * len(cols))
    sql = f"INSERT IGNORE INTO {qn(table)} ({', '.join(qn(c) for c in cols)}) VALUES ({placeholders})"

    conn = get_master_connection()
    with conn.cursor() as cur:
        cur.execute(sql, vals)



def normalize_campaign_id(campaign_id: str) -> str:
    """
    Your join table stores campaign_id WITHOUT hyphens:
      7ea0883d97914703b569c1f9f8d25705
    but URLs pass UUID with hyphens:
      7ea0883d-9791-4703-b569-c1f9f8d25705

    Normalize by removing hyphens and trimming.
    """
    return (campaign_id or "").strip().replace("-", "")


def get_campaign_fieldrep_link_fieldrep_id(*, campaign_id: str, link_pk: int) -> Optional[int]:
    """
    Treat `field_rep_id` URL as join-table primary key and resolve to actual field_rep_id.
    """
    conn = get_master_connection()

    table = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_TABLE", "campaign_campaignfieldrep")
    pk_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_PK_COLUMN", "id")
    campaign_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_CAMPAIGN_COLUMN", "campaign_id")
    fr_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_FIELD_REP_COLUMN", "field_rep_id")

    cid = normalize_campaign_id(campaign_id)
    sql = (
        f"SELECT {qn(fr_col)} "
        f"FROM {qn(table)} "
        f"WHERE {qn(pk_col)} = %s AND {qn(campaign_col)} = %s "
        f"LIMIT 1"
    )

    with conn.cursor() as cur:
        cur.execute(sql, [int(link_pk), cid])
        row = cur.fetchone()

    if not row:
        return None

    try:
        return int(row[0])
    except Exception:
        return None


def is_fieldrep_linked_to_campaign(*, campaign_id: str, field_rep_id: int) -> bool:
    """
    Enforce that the field rep is allowed for this campaign (join table must contain row).
    """
    conn = get_master_connection()

    table = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_TABLE", "campaign_campaignfieldrep")
    campaign_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_CAMPAIGN_COLUMN", "campaign_id")
    fr_col = getattr(settings, "MASTER_DB_CAMPAIGN_FIELD_REP_FIELD_REP_COLUMN", "field_rep_id")

    cid = normalize_campaign_id(campaign_id)
    sql = (
        f"SELECT 1 FROM {qn(table)} "
        f"WHERE {qn(campaign_col)} = %s AND {qn(fr_col)} = %s "
        f"LIMIT 1"
    )

    with conn.cursor() as cur:
        cur.execute(sql, [cid, int(field_rep_id)])
        return cur.fetchone() is not None


def get_field_rep(field_rep_id: str) -> Optional[MasterFieldRep]:
    """
    Deterministic FieldRep lookup.

    Priority:
      1) brand_supplied_field_rep_id exact match (string)
      2) id (pk) match if numeric (or trailing digits)
      3) user_id match if numeric (or trailing digits)

    This prevents the bug where id=15 accidentally returns the row whose user_id=15.
    """
    fid_raw = (field_rep_id or "").strip()
    if not fid_raw:
        return None

    # pull trailing digits e.g. "fieldrep_15" -> 15
    tail_digits = None
    m = re.search(r"(\d+)$", fid_raw)
    if m:
        try:
            tail_digits = int(m.group(1))
        except Exception:
            tail_digits = None

    conn = get_master_connection()

    table = getattr(settings, "MASTER_DB_FIELD_REP_TABLE", "campaign_fieldrep")
    pk_col = getattr(settings, "MASTER_DB_FIELD_REP_PK_COLUMN", "id")
    user_id_col = getattr(settings, "MASTER_DB_FIELD_REP_USER_ID_COLUMN", "user_id")
    ext_col = getattr(settings, "MASTER_DB_FIELD_REP_EXTERNAL_ID_COLUMN", "brand_supplied_field_rep_id")
    active_col = getattr(settings, "MASTER_DB_FIELD_REP_ACTIVE_COLUMN", "is_active")
    name_col = getattr(settings, "MASTER_DB_FIELD_REP_FULL_NAME_COLUMN", "full_name")
    phone_col = getattr(settings, "MASTER_DB_FIELD_REP_PHONE_COLUMN", "phone_number")

    def _row_to_obj(row):
        return MasterFieldRep(
            id=str(row[0]),
            full_name=str(row[1] or "").strip(),
            phone_number=str(row[2] or "").strip(),
            brand_supplied_field_rep_id=str(row[3] or "").strip(),
            is_active=bool(row[4]),
        )

    # 1) external id exact match
    sql_ext = (
        f"SELECT {qn(pk_col)}, {qn(name_col)}, {qn(phone_col)}, {qn(ext_col)}, {qn(active_col)} "
        f"FROM {qn(table)} WHERE {qn(ext_col)} = %s LIMIT 1"
    )
    with conn.cursor() as cur:
        cur.execute(sql_ext, [fid_raw])
        row = cur.fetchone()
    if row:
        return _row_to_obj(row)

    # numeric candidates: fid_raw if numeric, else trailing digits
    num = int(fid_raw) if fid_raw.isdigit() else tail_digits
    if num is None:
        return None

    # 2) pk match FIRST
    sql_pk = (
        f"SELECT {qn(pk_col)}, {qn(name_col)}, {qn(phone_col)}, {qn(ext_col)}, {qn(active_col)} "
        f"FROM {qn(table)} WHERE {qn(pk_col)} = %s LIMIT 1"
    )
    with conn.cursor() as cur:
        cur.execute(sql_pk, [num])
        row = cur.fetchone()
    if row:
        return _row_to_obj(row)

    # 3) user_id match
    sql_uid = (
        f"SELECT {qn(pk_col)}, {qn(name_col)}, {qn(phone_col)}, {qn(ext_col)}, {qn(active_col)} "
        f"FROM {qn(table)} WHERE {qn(user_id_col)} = %s LIMIT 1"
    )
    with conn.cursor() as cur:
        cur.execute(sql_uid, [num])
        row = cur.fetchone()
    if row:
        return _row_to_obj(row)

    return None



def resolve_field_rep_for_campaign(*, campaign_id: str, field_rep_identifier: str, token_sub: str = "") -> Optional[MasterFieldRep]:
    """
    The one function you should call from field_rep_landing_page.

    It supports the real-world situation you have:
      - URL field_rep_id may actually be the join-table id (e.g. 56)
      - token_sub may be "fieldrep_15"

    Resolution order:
      1) Try identifier directly in FieldRep table (id/user_id/external id)
         and enforce join exists for campaign.
      2) If not found, treat identifier as join-table PK:
         resolve to actual field_rep_id, fetch FieldRep, enforce join exists.
      3) Try token_sub (and token_sub tail digits) as fallback (same enforcement).
    """
    cid = normalize_campaign_id(campaign_id)

    # 1) direct candidates first
    direct_candidates = [field_rep_identifier]
    if token_sub:
        direct_candidates.append(token_sub)
        m = re.search(r"(\d+)$", token_sub)
        if m:
            direct_candidates.append(m.group(1))

    # Try direct fieldrep matches + campaign link enforcement
    for cand in direct_candidates:
        if not cand:
            continue
        fr = get_field_rep(cand)
        if fr and fr.is_active:
            try:
                if is_fieldrep_linked_to_campaign(campaign_id=cid, field_rep_id=int(fr.id)):
                    return fr
            except Exception:
                # if id is non-numeric, skip link check (should not happen with your schema)
                pass

    # 2) treat URL identifier as join-table pk
    if (field_rep_identifier or "").strip().isdigit():
        link_pk = int(field_rep_identifier.strip())
        fr_id = get_campaign_fieldrep_link_fieldrep_id(campaign_id=cid, link_pk=link_pk)
        if fr_id:
            fr = get_field_rep(str(fr_id))
            if fr and fr.is_active:
                if is_fieldrep_linked_to_campaign(campaign_id=cid, field_rep_id=fr_id):
                    return fr

    return None


def find_doctor_by_email_or_whatsapp(*, email: str, whatsapp: str) -> Optional[MasterDoctor]:
    """
    Find existing doctor in MASTER DB by email OR WhatsApp.
    """
    email_n = (email or "").strip().lower()
    wa_n = normalize_wa_for_lookup(whatsapp)

    if not email_n and not wa_n:
        return None

    conn = get_master_connection()
    table = getattr(settings, "MASTER_DB_DOCTOR_TABLE", "redflags_doctor")

    id_col = getattr(settings, "MASTER_DB_DOCTOR_ID_COLUMN", "doctor_id")
    fn_col = getattr(settings, "MASTER_DB_DOCTOR_FIRST_NAME_COLUMN", "first_name")
    ln_col = getattr(settings, "MASTER_DB_DOCTOR_LAST_NAME_COLUMN", "last_name")
    email_col = getattr(settings, "MASTER_DB_DOCTOR_EMAIL_COLUMN", "email")
    wa_col = getattr(settings, "MASTER_DB_DOCTOR_WHATSAPP_COLUMN", "whatsapp_no")

    where = []
    vals = []

    if email_n:
        where.append(f"LOWER({qn(email_col)}) = LOWER(%s)")
        vals.append(email_n)

    if wa_n:
        where.append(f"{qn(wa_col)} = %s")
        vals.append(wa_n)

    sql = (
        f"SELECT {qn(id_col)}, {qn(fn_col)}, {qn(ln_col)}, {qn(email_col)}, {qn(wa_col)} "
        f"FROM {qn(table)} "
        f"WHERE {' OR '.join(where)} "
        f"LIMIT 1"
    )

    with conn.cursor() as cur:
        cur.execute(sql, vals)
        row = cur.fetchone()

    if not row:
        return None

    return MasterDoctor(
        doctor_id=str(row[0] or "").strip(),
        first_name=str(row[1] or "").strip(),
        last_name=str(row[2] or "").strip(),
        email=str(row[3] or "").strip(),
        whatsapp_no=str(row[4] or "").strip(),
    )


def generate_doctor_id(prefix: str = "DR", max_tries: int = 10) -> str:
    """
    Generate a unique doctor_id for MASTER DB.
    Example: DR1706012345
    """
    for _ in range(max_tries):
        did = f"{prefix}{int(time.time() * 1000)}"
        if not doctor_id_exists(did):
            return did
        time.sleep(0.01)

    raise RuntimeError("Unable to generate unique doctor_id in MASTER DB")


def create_doctor_with_enrollment(
    *,
    doctor_id: str,
    first_name: str,
    last_name: str,
    email: str,
    whatsapp: str,
    clinic_name: str,
    clinic_phone: str = "",
    clinic_appointment_number: str = "",
    clinic_address: str = "",
    imc_number: str = "",
    postal_code: str = "",
    state: str = "",
    district: str = "",
    photo_path: str = "",
    campaign_id: Optional[str] = None,
    recruited_via: str = "SELF",
    registered_by: Optional[str] = None,
) -> None:
    """
    Atomically:
      1) Insert doctor into MASTER DB
      2) Ensure campaign enrollment (if campaign_id provided)

    This is the ONLY function register_doctor should call.
    """

    conn = get_master_connection()

    with conn.cursor() as cur:
        try:
            # -------------------------
            # Insert doctor
            # -------------------------
            insert_doctor_row(
                doctor_id=doctor_id,
                first_name=first_name,
                last_name=last_name,
                email=email,
                clinic_name=clinic_name,
                imc_registration_number=imc_number,
                clinic_phone=clinic_phone,
                clinic_appointment_number=clinic_appointment_number,
                clinic_address=clinic_address,
                postal_code=postal_code,
                state=state,
                district=district,
                whatsapp_no=whatsapp,
                receptionist_whatsapp_number="",
                photo_path=photo_path,
                field_rep_id=registered_by or "",
                recruited_via=recruited_via,
            )

            # -------------------------
            # Campaign enrollment
            # -------------------------
            if campaign_id:
                ensure_enrollment(
                    doctor_id=doctor_id,
                    campaign_id=campaign_id,
                    registered_by=registered_by or "",
                )

        except IntegrityError:
            # Doctor already exists (race / retry case)
            pass

================================================================================
FILE: accounts/email_log.py
================================================================================

from django.db import models


class EmailLog(models.Model):
    created_at = models.DateTimeField(auto_now_add=True)

    to_email = models.EmailField()
    subject = models.CharField(max_length=255)

    provider = models.CharField(max_length=50, default="sendgrid")

    success = models.BooleanField(default=False)
    status_code = models.IntegerField(null=True, blank=True)

    response_body = models.TextField(blank=True)
    error = models.TextField(blank=True)

    def __str__(self) -> str:
        return f"{self.created_at} {self.to_email} {self.subject} ({'OK' if self.success else 'FAIL'})"

================================================================================
FILE: accounts/urls.py
================================================================================

from django.urls import path
from . import views

app_name = "accounts"

urlpatterns = [
    path("register/", views.register_doctor, name="register"),
    path("modify/<str:doctor_id>/", views.modify_clinic_details, name="modify_clinic_details"),
    path("login/", views.doctor_login, name="login"),
    path("logout/", views.doctor_logout, name="logout"),
    path("request-password-reset/", views.request_password_reset, name="request_password_reset"),
    path("reset/<uidb64>/<token>/", views.password_reset, name="password_reset"),
]

================================================================================
FILE: accounts/views.py
================================================================================

from __future__ import annotations

from django.conf import settings
from django.contrib import messages
from django.contrib.auth import login, logout
from django.contrib.auth.decorators import login_required
from django.contrib.auth.tokens import default_token_generator
from django.db import transaction
from django.http import HttpResponseForbidden, HttpResponseServerError
from django.shortcuts import redirect, render
from django.urls import reverse
from django.utils.encoding import force_bytes
from django.utils.http import urlsafe_base64_encode

from .forms import DoctorRegistrationForm, DoctorClinicDetailsForm, EmailAuthenticationForm, DoctorSetPasswordForm
from .pincode_directory import IndiaPincodeDirectoryNotReady, get_state_and_district_for_pincode
from publisher.models import Campaign
from . import master_db

from .models import User, Clinic, DoctorProfile

from .sendgrid_utils import send_email_via_sendgrid


# ---------------------------------------------------------------------
# Utilities
# ---------------------------------------------------------------------

def _build_absolute_url(path: str) -> str:
    base = (settings.SITE_BASE_URL or "").rstrip("/")
    return f"{base}{path}"


def _send_doctor_links_email(doctor: DoctorProfile, campaign_id: str | None = None, password_setup: bool = True) -> bool:
    """Send doctor/staff share link + (optional) password setup/reset link, using campaign email template if present."""
    if not doctor or not doctor.user:
        return False

    clinic_link = _build_absolute_url(reverse("sharing:doctor_share", args=[doctor.doctor_id]))
    login_link = _build_absolute_url(reverse("accounts:login"))

    setup_link = ""
    if password_setup:
        token = default_token_generator.make_token(doctor.user)
        uid = urlsafe_base64_encode(force_bytes(doctor.user.pk))
        setup_link = _build_absolute_url(reverse("accounts:password_reset", args=[uid, token]))

    # Default fallback text (in case campaign template missing)
    fallback_lines = [
        f"Hello {doctor.user.full_name or doctor.user.email},",
        "",
        "Your clinic has access to the CPD in Clinic portal.",
        "",
        f"Clinic link (doctor/staff sharing screen): {clinic_link}",
        f"Login link: {login_link}",
        "",
    ]
    if setup_link:
        fallback_lines.extend(["To set/reset your password, use the link below:", setup_link, ""])
    fallback_lines.append("Thank you.")
    fallback_body = "\n".join(fallback_lines)

    template_text = ""
    if campaign_id:
        template_text = (
            Campaign.objects.filter(campaign_id=campaign_id)
            .values_list("email_registration", flat=True)
            .first()
            or ""
        )

    if template_text.strip():
        # Reuse the same placeholder strategy as the field-rep WhatsApp renderer.
        def _render(template: str) -> str:
            text = template or ""
            replacements = {
                "<doctor.user.full_name>": doctor.user.full_name or doctor.user.email,
                "<doctor_name>": doctor.user.full_name or doctor.user.email,
                "{{doctor_name}}": doctor.user.full_name or doctor.user.email,

                "<clinic_link>": clinic_link,
                "{{clinic_link}}": clinic_link,
                "<LinkShare>": clinic_link,

                "<setup_link>": setup_link,
                "{{setup_link}}": setup_link,
                "<LinkPW>": setup_link,
            }
            for k, v in replacements.items():
                if v:
                    text = text.replace(k, v)
            return text

        body = _render(template_text).strip()
    else:
        body = fallback_body

    return send_email_via_sendgrid(
        subject="CPD in Clinic portal access",
        to_emails=[doctor.user.email],
        plain_text_content=body,
    )


def _store_registration_draft(request, *, draft: dict, session_key: str) -> None:
    """Store a draft (excluding files) in session for repopulation."""
    request.session[session_key] = draft
    request.session.modified = True


def _pop_registration_draft(request, session_key: str) -> dict | None:
    draft = request.session.pop(session_key, None)
    if draft:
        request.session.modified = True
    return draft


# ---------------------------------------------------------------------
# Registration (new doctor)
# ---------------------------------------------------------------------

from django.shortcuts import render
from django.urls import reverse
from django.http import HttpResponseServerError

from accounts import master_db


from django.http import HttpResponseServerError
from django.shortcuts import render
from django.urls import reverse

def register_doctor(request):
    # -----------------------------
    # GET
    # -----------------------------
    if request.method == "GET":
        form = DoctorRegistrationForm(initial=request.GET)
        return render(
            request,
            "accounts/register.html",
            {"form": form, "mode": "register"},
        )

    # -----------------------------
    # POST
    # -----------------------------
    form = DoctorRegistrationForm(request.POST, request.FILES)
    if not form.is_valid():
        return render(
            request,
            "accounts/register.html",
            {"form": form, "mode": "register"},
        )

    cd = form.cleaned_data

    email = cd["email"].strip().lower()
    whatsapp = cd["clinic_whatsapp_number"].strip()

    campaign_id = (cd.get("campaign_id") or "").strip()
    field_rep_id = (cd.get("field_rep_id") or "").strip()

    recruited_via = "FIELD_REP" if field_rep_id else "SELF"

    # --------------------------------------------------
    # 1️⃣ CHECK EXISTING DOCTOR — MASTER DB
    # --------------------------------------------------
    existing_doctor = master_db.find_doctor_by_email_or_whatsapp(
        email=email,
        whatsapp=whatsapp,
    )

    if existing_doctor:
        if campaign_id:
            master_db.ensure_enrollment(
                doctor_id=existing_doctor["doctor_id"],
                campaign_id=campaign_id,
                registered_by=field_rep_id or None,
            )

        _send_doctor_links_email(
            doctor_id=existing_doctor["doctor_id"],
            email=email,
            campaign_id=campaign_id or None,
            password_setup=True,
        )

        return render(
            request,
            "accounts/already_registered.html",
            {
                "message": (
                    "This doctor is already registered. "
                    "Access details have been sent to the registered email."
                ),
                "login_url": reverse("accounts:login"),
            },
        )

    # --------------------------------------------------
    # 2️⃣ CREATE DOCTOR — MASTER DB
    # --------------------------------------------------
    doctor_id = master_db.generate_doctor_id()

    photo_path = ""
    if cd.get("photo"):
        photo_path = cd["photo"].name

    # ✅ SAFE extraction (NO KeyError)
    state = (cd.get("state") or "").strip()
    district = (cd.get("district") or "").strip()

    try:
        master_db.create_doctor_with_enrollment(
            doctor_id=doctor_id,
            first_name=cd["first_name"].strip(),
            last_name=cd["last_name"].strip(),
            email=email,
            whatsapp=whatsapp,
            clinic_name=cd["clinic_name"].strip(),
            clinic_phone=cd["clinic_appointment_number"].strip(),
            clinic_address=cd["clinic_address"].strip(),
            imc_number=cd["imc_registration_number"].strip(),
            postal_code=cd["postal_code"].strip(),
            state=state or None,       # ✅ DB-safe
            district=district or None, # ✅ DB-safe
            photo_path=photo_path,
            campaign_id=campaign_id or None,
            recruited_via=recruited_via,
            registered_by=field_rep_id or None,
        )

    except Exception as e:
        import traceback
        traceback.print_exc()
        print("[Doctor registration failed] error ->", e)
        return HttpResponseServerError(
            "Doctor registration failed. Please try again later."
        )

    # --------------------------------------------------
    # 3️⃣ SEND ACCESS LINKS
    # --------------------------------------------------
    _send_doctor_links_email(
        doctor_id=doctor_id,
        email=email,
        campaign_id=campaign_id or None,
        password_setup=True,
    )

    return render(
        request,
        "accounts/register_success.html",
        {
            "doctor_id": doctor_id,
            "clinic_link": _build_absolute_url(
                reverse("sharing:doctor_share", args=[doctor_id])
            ),
        },
    )





# ---------------------------------------------------------------------
# Modify clinic details (from doctor's sharing screen)
# ---------------------------------------------------------------------

@login_required
def modify_clinic_details(request, doctor_id: str):
    doctor = getattr(request.user, "doctor_profile", None)
    if not doctor or doctor.doctor_id != doctor_id:
        return HttpResponseForbidden("Not allowed.")

    session_key = f"doctor_modify_draft_{doctor_id}"

    if request.method == "GET":
        initial = {
            "doctor_id": doctor.doctor_id,
            "full_name": doctor.user.full_name,
            "email": doctor.user.email,
            "whatsapp_number": doctor.whatsapp_number,
            "clinic_number": doctor.clinic.clinic_phone if doctor.clinic else "",
            "clinic_whatsapp_number": getattr(doctor.clinic, "clinic_whatsapp_number", "") if doctor.clinic else "",
            "imc_number": doctor.imc_number,
            "postal_code": doctor.postal_code or (doctor.clinic.postal_code if doctor.clinic else ""),
            "address_text": doctor.clinic.address_text if doctor.clinic else "",
        }

        draft = _pop_registration_draft(request, session_key=session_key)
        if isinstance(draft, dict):
            initial.update(draft)

        form = DoctorClinicDetailsForm(initial=initial)
        return render(request, "accounts/register.html", {"form": form, "mode": "modify"})

    # POST
    form = DoctorClinicDetailsForm(request.POST, request.FILES)
    if not form.is_valid():
        return render(request, "accounts/register.html", {"form": form, "mode": "modify"})

    # Ensure doctor_id isn't tampered (field is readonly, but still validate)
    if (form.cleaned_data.get("doctor_id") or "") != doctor_id:
        form.add_error("doctor_id", "Doctor ID mismatch.")
        return render(request, "accounts/register.html", {"form": form, "mode": "modify"})

    full_name = form.cleaned_data.get("full_name") or ""
    email = form.cleaned_data.get("email") or ""
    whatsapp_number = form.cleaned_data.get("whatsapp_number") or ""
    clinic_number = form.cleaned_data.get("clinic_number") or ""
    clinic_whatsapp_number = form.cleaned_data.get("clinic_whatsapp_number") or ""
    imc_number = form.cleaned_data.get("imc_number") or ""
    postal_code = form.cleaned_data.get("postal_code") or ""
    address_text = form.cleaned_data.get("address_text") or ""
    new_photo = form.cleaned_data.get("photo")

    try:
        state, district = get_state_and_district_for_pincode(postal_code)
    except IndiaPincodeDirectoryNotReady as e:
        return HttpResponseServerError(str(e))

    if not state:
        _store_registration_draft(
            request,
            session_key=session_key,
            draft={
                "doctor_id": doctor_id,
                "full_name": full_name,
                "email": email,
                "whatsapp_number": whatsapp_number,
                "clinic_number": clinic_number,
                "clinic_whatsapp_number": clinic_whatsapp_number,
                "imc_number": imc_number,
                "postal_code": postal_code,
                "address_text": address_text,
            },
        )
        return render(
            request,
            "accounts/pincode_invalid.html",
            {
                "return_url": reverse("accounts:modify_clinic_details", args=[doctor_id]),
            },
        )

    # Enforce uniqueness (excluding current doctor/user)
    if User.objects.filter(email=email).exclude(pk=doctor.user.pk).exists():
        form.add_error("email", "This email address is already registered.")
        return render(request, "accounts/register.html", {"form": form, "mode": "modify"})

    if DoctorProfile.objects.filter(whatsapp_number=whatsapp_number).exclude(pk=doctor.pk).exists():
        form.add_error("whatsapp_number", "This WhatsApp number is already registered.")
        return render(request, "accounts/register.html", {"form": form, "mode": "modify"})

    clinic_display_name = f"Dr. {full_name}" if full_name else ""

    with transaction.atomic():
        # Update user
        doctor.user.full_name = full_name
        doctor.user.email = email
        doctor.user.save(update_fields=["full_name", "email"])

        # Update clinic
        if doctor.clinic:
            doctor.clinic.display_name = clinic_display_name
            doctor.clinic.clinic_phone = clinic_number
            doctor.clinic.clinic_whatsapp_number = clinic_whatsapp_number
            doctor.clinic.address_text = address_text
            doctor.clinic.postal_code = postal_code
            doctor.clinic.state = state
            doctor.clinic.district = district
            doctor.clinic.save(
                update_fields=[
                    "display_name",
                    "clinic_phone",
                    "clinic_whatsapp_number",
                    "address_text",
                    "postal_code",
                    "state",
                    "district"
                ]
            )

        # Update doctor profile
        doctor.whatsapp_number = whatsapp_number
        doctor.imc_number = imc_number
        doctor.postal_code = postal_code
        if new_photo:
            doctor.photo = new_photo
            doctor.save(update_fields=["whatsapp_number", "imc_number", "postal_code", "photo"])
        else:
            doctor.save(update_fields=["whatsapp_number", "imc_number", "postal_code"])

    messages.success(request, "Clinic details updated.")
    return redirect("sharing:doctor_share", doctor_id=doctor_id)


# ---------------------------------------------------------------------
# Auth + password reset (doctor login)
# ---------------------------------------------------------------------

def doctor_login(request):
    if request.method == "POST":
        form = EmailAuthenticationForm(request, data=request.POST)
        if form.is_valid():
            user = form.get_user()
            login(request, user)
            doctor = getattr(user, "doctor_profile", None)
            if doctor:
                return redirect("sharing:doctor_share", doctor_id=doctor.doctor_id)
            return redirect("publisher:dashboard")
        messages.error(request, "Invalid login.")
    else:
        form = EmailAuthenticationForm(request)
    return render(request, "accounts/login.html", {"form": form})


@login_required
def doctor_logout(request):
    logout(request)
    messages.info(request, "Logged out.")
    return redirect("accounts:login")


def _send_password_reset_email(user: User) -> bool:
    token = default_token_generator.make_token(user)
    uid = urlsafe_base64_encode(force_bytes(user.pk))
    reset_link = _build_absolute_url(reverse("accounts:password_reset", args=[uid, token]))

    body_lines = [
        f"Hello {user.full_name or user.email},",
        "",
        "To reset your password, use the link below:",
        reset_link,
        "",
        "If you did not request this, you can ignore this email.",
        "",
        "Thank you.",
    ]

    return send_email_via_sendgrid(
        subject="Password reset",
        to_emails=[user.email],
        plain_text_content="\n".join(body_lines),
    )


def request_password_reset(request):
    if request.method == "POST":
        email = (request.POST.get("email") or "").strip().lower()
        user = User.objects.filter(email=email).first()
        if user:
            _send_password_reset_email(user)
        messages.success(
            request,
            "If the email exists in our system, a password reset link has been sent.",
        )
        return redirect("accounts:login")

    return render(request, "accounts/request_password_reset.html")


def password_reset(request, uidb64: str, token: str):
    user = None
    try:
        from django.utils.http import urlsafe_base64_decode
        uid = urlsafe_base64_decode(uidb64).decode()
        user = User.objects.get(pk=uid)
    except Exception:
        user = None

    if not user or not default_token_generator.check_token(user, token):
        messages.error(request, "Invalid or expired password reset link.")
        return redirect("accounts:login")

    if request.method == "POST":
        form = DoctorSetPasswordForm(user=user, data=request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Password updated. You can now login.")
            return redirect("accounts:login")
    else:
        form = DoctorSetPasswordForm(user=user)

    return render(request, "accounts/password_reset.html", {"form": form})

================================================================================
FILE: accounts/management/__init__.py
================================================================================



================================================================================
FILE: accounts/management/commands/build_pincode_directory.py
================================================================================

from __future__ import annotations

import csv
import json
import re
from pathlib import Path

from django.core.management.base import BaseCommand, CommandError

from accounts.pincode_directory import PINCODE_DIRECTORY_PATH, _canon_state_name


PIN_CANDIDATES = {"pincode", "pin_code", "pin", "postal_code", "postalcode", "pin code"}
STATE_CANDIDATES = {"state", "state_name", "statename", "state/ut", "state_ut", "circle", "circlename"}


def _clean_pin(value: str) -> str:
    digits = re.sub(r"\D", "", str(value or ""))
    return digits if re.fullmatch(r"\d{6}", digits) else ""


def _is_blank_row(row: list[str]) -> bool:
    return (not row) or all((c or "").strip() == "" for c in row)


def _looks_like_header(row: list[str]) -> bool:
    """
    Treat as header if it contains obvious column names (pin/state),
    irrespective of case. This also works if there are extra columns.
    """
    lowered = {str(c or "").strip().lower() for c in row if str(c or "").strip()}
    if not lowered:
        return False
    has_pin = any(any(token in col for token in ["pin", "pincode", "postal"]) for col in lowered)
    has_state = any("state" in col or "circle" in col for col in lowered)
    return has_pin and has_state


def _detect_delimiter(sample: str) -> str:
    # Try to sniff; if it fails, default to comma.
    try:
        dialect = csv.Sniffer().sniff(sample, delimiters=[",", ";", "\t", "|"])
        return dialect.delimiter
    except Exception:
        return ","


class Command(BaseCommand):
    help = (
        "Build accounts/data/india_pincode_directory.json (PIN -> State mapping) from a CSV file.\n\n"
        "Works with:\n"
        "- CSVs WITH header row (recommended)\n"
        "- CSVs WITHOUT header row (assumes first column = PIN, second column = State)\n"
        "- CSVs with leading blank lines\n"
    )

    def add_arguments(self, parser):
        parser.add_argument(
            "--input",
            required=True,
            help="Path to the source CSV containing all-India PIN directory data.",
        )
        parser.add_argument(
            "--output",
            default=str(PINCODE_DIRECTORY_PATH),
            help=f"Output JSON path (default: {PINCODE_DIRECTORY_PATH}).",
        )

    def handle(self, *args, **options):
        input_path = Path(options["input"]).expanduser().resolve()
        if not input_path.exists():
            raise CommandError(f"Input CSV not found: {input_path}")

        output_path = Path(options["output"]).expanduser().resolve()
        output_path.parent.mkdir(parents=True, exist_ok=True)

        # Read a small sample to sniff delimiter
        with input_path.open("r", encoding="utf-8-sig", newline="") as f:
            sample = f.read(8192)
            f.seek(0)

            delimiter = _detect_delimiter(sample)
            reader = csv.reader(f, delimiter=delimiter)

            # Find the first non-empty row (skip leading blank lines)
            first_row = None
            for row in reader:
                if not _is_blank_row(row):
                    first_row = row
                    break

            if first_row is None:
                raise CommandError("CSV is empty or contains only blank lines.")

            has_header = _looks_like_header(first_row)

            # Determine column indices
            pin_idx = None
            state_idx = None

            if has_header:
                headers = [str(c or "").strip().lower() for c in first_row]
                for i, h in enumerate(headers):
                    if any(h == cand or cand in h for cand in PIN_CANDIDATES):
                        pin_idx = i
                        break

                for i, h in enumerate(headers):
                    if any(h == cand or cand in h for cand in STATE_CANDIDATES):
                        state_idx = i
                        break

                if pin_idx is None or state_idx is None:
                    raise CommandError(
                        "Header row found but could not detect PIN/State columns.\n"
                        f"Header columns: {first_row}\n"
                        "Expected something like 'pincode' and 'state'."
                    )
            else:
                # No header: assume first column is PIN, second column is State.
                pin_idx = 0
                state_idx = 1

            mapping: dict[str, str] = {}
            invalid_pin = 0
            empty_state = 0
            short_rows = 0

            # If there was no header, first_row is data and must be processed.
            if not has_header:
                row = first_row
                if len(row) <= max(pin_idx, state_idx):
                    short_rows += 1
                else:
                    pin = _clean_pin(row[pin_idx])
                    if not pin:
                        invalid_pin += 1
                    else:
                        state = _canon_state_name(row[state_idx])
                        if not state:
                            empty_state += 1
                        else:
                            mapping[pin] = state

            # Process the rest
            for row in reader:
                if _is_blank_row(row):
                    continue
                if len(row) <= max(pin_idx, state_idx):
                    short_rows += 1
                    continue

                pin = _clean_pin(row[pin_idx])
                if not pin:
                    invalid_pin += 1
                    continue

                state = _canon_state_name(row[state_idx])
                if not state:
                    empty_state += 1
                    continue

                mapping[pin] = state

        # Fail loudly if mapping is suspiciously small
        if len(mapping) < 1000:
            raise CommandError(
                "PIN->State mapping generated is too small. "
                f"Generated={len(mapping)}. invalid_pin_rows={invalid_pin}, empty_state_rows={empty_state}, short_rows={short_rows}. "
                "This typically indicates the CSV was not parsed correctly (wrong delimiter/columns) or the file is not the expected one."
            )

        with output_path.open("w", encoding="utf-8") as out:
            json.dump(mapping, out, ensure_ascii=False, indent=2, sort_keys=True)

        self.stdout.write(
            self.style.SUCCESS(
                f"Wrote {len(mapping):,} PIN entries to {output_path} "
                f"(delimiter='{delimiter}', header={has_header}, invalid_pin_rows={invalid_pin}, empty_state_rows={empty_state}, short_rows={short_rows})"
            )
        )

================================================================================
FILE: accounts/management/commands/__init__.py
================================================================================



================================================================================
FILE: templates/base.html
================================================================================

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <title>{% block title %}Patient Education{% endblock %}</title>
  <style>
:root {
  --bg: #f8fafc;
  --surface: #ffffff;
  --surface-2: #f1f5f9;
  --text: #1e293b;
  --muted: #64748b;
  --border: #e2e8f0;
  --border-strong: #cbd5e1;

  --primary: #2563eb;
  --primary-hover: #1d4ed8;
  --primary-contrast: #ffffff;

  --secondary: #475569;
  --secondary-hover: #334155;

  --link: #2563eb;
  --link-hover: #1d4ed8;

  --danger: #dc2626;
  --success: #059669;
  --warning: #d97706;

  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;

  --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
  --shadow-md: 0 4px 20px rgba(15, 23, 42, 0.1);
  --shadow-lg: 0 10px 40px rgba(15, 23, 42, 0.12);
  --ring: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

* { 
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body { 
  height: 100%;
  scroll-behavior: smooth;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

img, svg, video { 
  max-width: 100%; 
  height: auto;
  display: block;
}

a { 
  color: var(--link); 
  text-decoration: none;
  transition: color 0.2s ease;
}
a:hover { 
  color: var(--link-hover); 
  text-decoration: underline;
}

/* Container System */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px 16px 40px;
  width: 100%;
}

@media (max-width: 640px) {
  .container { 
    padding: 16px 12px 32px; 
  }
}

/* Header */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

@media (max-width: 640px) {
  .header-inner { 
    padding: 12px; 
    gap: 12px;
  }
}

.brand {
  font-weight: 800;
  letter-spacing: 0.3px;
  color: var(--text);
  font-size: 1.1rem;
  white-space: nowrap;
}

.muted { 
  color: var(--muted);
  font-size: 0.875rem;
}

/* Typography */
h1, h2, h3, h4 {
  margin: 0 0 12px;
  line-height: 1.3;
  color: var(--text);
  font-weight: 700;
}

h1 { 
  font-size: 1.875rem; 
  margin-bottom: 16px;
}
h2 { 
  font-size: 1.5rem; 
}
h3 { 
  font-size: 1.25rem; 
}
h4 { 
  font-size: 1.125rem; 
}

@media (max-width: 640px) {
  h1 { font-size: 1.625rem; }
  h2 { font-size: 1.375rem; }
  h3 { font-size: 1.125rem; }
}

p { 
  margin: 0 0 16px; 
}
ul, ol { 
  margin: 12px 0 16px 20px; 
}
li { 
  margin: 6px 0; 
}

hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 24px 0;
}

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: box-shadow 0.2s ease, transform 0.2s ease;
  margin-bottom: 20px;
}

.card:hover {
  box-shadow: var(--shadow-md);
}

@media (max-width: 640px) {
  .card { 
    padding: 20px 16px; 
    border-radius: 12px;
  }
}

.card + .card { 
  margin-top: 16px; 
}

/* Form Elements */
label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #334155;
  display: block;
  margin-bottom: 8px;
}

/* Text inputs / selects / textareas (exclude checkbox & radio) */
input:not([type="checkbox"]):not([type="radio"]), select, textarea {
  width: 100%;
  padding: 12px;
  border: 1.5px solid var(--border-strong);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--text);
  font: inherit;
  font-size: 0.9375rem;
  transition: all 0.2s ease;
  -webkit-appearance: none;
  appearance: none;
}

/* Checkbox / Radio */
input[type="checkbox"],
input[type="radio"] {
  width: auto;
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
  box-shadow: none;
  -webkit-appearance: auto;
  appearance: auto;
  accent-color: var(--primary);
}

input[type="checkbox"]:focus,
input[type="radio"]:focus {
  outline: none;
  box-shadow: var(--ring);
}

input::placeholder, 
textarea::placeholder { 
  color: #94a3b8; 
  opacity: 0.8;
}

textarea { 
  min-height: 120px; 
  resize: vertical;
  line-height: 1.5;
}

input:focus, 
select:focus, 
textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: var(--ring);
}

select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 36px;
}

/* Buttons */
button, 
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: var(--radius-sm);
  border: none;
  background: var(--primary);
  color: var(--primary-contrast);
  font-weight: 600;
  font-size: 0.9375rem;
  line-height: 1;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  min-height: 44px;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

button:hover, 
.btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

button:active,
.btn:active {
  transform: translateY(0);
}

button:disabled,
.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: var(--surface);
  color: var(--secondary);
  border: 1.5px solid var(--border-strong);
}

.btn-secondary:hover {
  background: var(--surface-2);
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-1px);
}

/* Messages */
.messages { 
  margin: 0 0 20px; 
}

.message {
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  margin: 8px 0;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 8px;
  border-left: 4px solid transparent;
}

.message:before {
  content: '';
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  background-size: contain;
}

.message.success { 
  background: #f0fdf4;
  border-color: rgba(5, 150, 105, 0.3);
  color: #065f46;
  border-left-color: var(--success);
}
.message.success:before {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23059669'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
}

.message.error { 
  background: #fef2f2;
  border-color: rgba(220, 38, 38, 0.3);
  color: #991b1b;
  border-left-color: var(--danger);
}
.message.error:before {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc2626'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
}

/* Grid System */
.row { 
  display: grid; 
  gap: 16px; 
  width: 100%;
}

@media (min-width: 768px) {
  .row.two { 
    grid-template-columns: repeat(2, 1fr); 
  }
  .row.three { 
    grid-template-columns: repeat(3, 1fr); 
  }
}

@media (max-width: 767px) {
  .row.two,
  .row.three {
    grid-template-columns: 1fr;
  }
}

/* Tables */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
  margin: 20px 0;
}

th, td {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  text-align: left;
  vertical-align: middle;
  overflow-wrap: anywhere;
}

tr:last-child td { 
  border-bottom: none; 
}

th {
  background: var(--surface-2);
  color: #475569;
  font-weight: 700;
  font-size: 0.8125rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  white-space: nowrap;
}

tr:hover td {
  background: rgba(241, 245, 249, 0.5);
}

@media (max-width: 768px) {
  table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  thead, 
  tbody, 
  tr { 
    width: 100%; 
  }
  
  th, 
  td {
    min-width: 120px;
    padding: 12px;
  }
}

/* Fieldset & Legend */
fieldset {
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  padding: 20px;
  margin: 24px 0;
  background: var(--surface);
}

legend {
  padding: 0 12px;
  font-weight: 700;
  color: var(--text);
  font-size: 1.125rem;
  background: var(--surface);
}

/* Form Layout */
.form-group {
  margin-bottom: 20px;
}

.form-row {
  display: flex;
  gap: 16px;
  align-items: flex-start;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

@media (max-width: 640px) {
  .form-row {
    flex-direction: column;
    gap: 12px;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Print Styles */
@media print {
  .header,
  .messages,
  button:not(.print),
  .btn:not(.print) {
    display: none !important;
  }
  
  .card {
    border: 1px solid #000;
    box-shadow: none;
  }
}
  </style>
  {% block head %}{% endblock %}
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="brand">{% block header_title %}Patient Education{% endblock %}</div>
      <div>
        {% if show_auth_links|default:True %}
          {% if user.is_authenticated %}
            <span class="muted">{{ user.full_name }}</span>
            &nbsp;·&nbsp;
            <a href="{% url 'accounts:logout' %}" class="btn-secondary" style="padding: 6px 12px; font-size: 0.875rem;">Logout</a>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="btn-secondary" style="padding: 6px 12px; font-size: 0.875rem;">Login</a>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <div class="container">
    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </div>
</body>
</html>

================================================================================
FILE: templates/sharing/patient_cluster.html
================================================================================

{% extends "base.html" %}
{% block title %}{{ clinic.display_name }} — {{ cluster_title }}{% endblock %}
{% block header_title %}{{ clinic.display_name }}{% endblock %}

{% block content %}
<div class="card">
  <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap; padding-bottom: 24px; border-bottom: 1px solid var(--border);">
    <div style="width: 80px; height: 80px; border-radius: 20px; border: 2px solid var(--border); background: linear-gradient(135deg, var(--primary), #3b82f6); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; position: relative; overflow: hidden; flex-shrink: 0;">
      <div style="line-height: 1;">{{ doctor.user.full_name|default:"D"|slice:":1"|upper }}</div>
      {% if doctor.photo %}
        <img src="{{ doctor.photo.url }}"
             alt="Doctor photo"
             loading="lazy"
             onerror="this.remove();"
             style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" />
      {% endif %}
    </div>

    <div style="flex: 1; min-width: 0;">
      <div style="font-size: 1.5rem; font-weight: 800; color: var(--text); margin-bottom: 4px;">Dr. {{ doctor.user.full_name }}</div>
      <div class="muted" style="font-size: 0.9375rem; margin-bottom: 8px;">{{ clinic.display_name }}</div>
      <div class="muted" style="font-size: 0.875rem; margin-bottom: 4px;">{{ clinic.state }}{% if clinic.postal_code %} — {{ clinic.postal_code }}{% endif %}</div>

      <div class="muted" style="margin-top: 12px; font-size: 0.875rem; line-height: 1.5;">
        {{ clinic.address_text|linebreaksbr }}
      </div>

      <div class="muted" style="margin-top: 8px; font-size: 0.875rem;">
        <div style="display: inline-flex; align-items: center; gap: 6px;">
          <span style="font-size: 1rem;">📞</span>
          <span>Clinic phone: {{ clinic.clinic_phone }}</span>
        </div>
        {% if clinic.clinic_whatsapp_number %}
          <div style="display: inline-flex; align-items: center; gap: 6px; margin-left: 16px;">
            <span style="font-size: 1rem;">💬</span>
            <span>WhatsApp: {{ clinic.clinic_whatsapp_number }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div style="margin-top: 24px;">
    <div style="text-align: center; margin-bottom: 32px;">
      <div style="font-size: 2rem; font-weight: 800; color: var(--text); margin-bottom: 8px; line-height: 1.2;">{{ cluster_title }}</div>
      <div class="muted" style="font-size: 1.125rem; margin-bottom: 8px;">Patient education bundle</div>
      <div class="muted" style="font-size: 0.875rem;">
        {% if items %}
          {{ items|length }} video{{ items|length|pluralize:"s" }} in this collection
        {% else %}
          No videos in this bundle
        {% endif %}
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <div class="row" style="max-width: 300px;">
        <div>
          <label for="lang" style="font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">Language</label>
          <select id="lang" style="width: 100%; padding: 12px; border: 1.5px solid var(--border-strong); border-radius: var(--radius-sm); background: var(--surface); color: var(--text); font-size: 0.9375rem;">
            {% for code, name in languages %}
              <option value="{{ code }}" {% if code == selected_lang %}selected{% endif %}>
                {{ name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    {% if items %}
      {% for it in items %}
        <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0;">
              {{ forloop.counter }}
            </div>
            <div style="font-size: 1.125rem; font-weight: 700; color: var(--text);">{{ it.title }}</div>
          </div>
          
          {% if it.url %}
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px; border: 1px solid var(--border); background: #000; box-shadow: var(--shadow-sm);">
              <iframe class="yt-player"
                      data-youtube-url="{{ it.url }}"
                      referrerpolicy="strict-origin-when-cross-origin"
                      loading="lazy"
                      style="position: absolute; top:0; left:0; width:100%; height:100%; border:0;"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                      allowfullscreen></iframe>

              <div class="yt-fallback"
                   style="display:none; position: absolute; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; flex-direction: column; gap: 16px; padding: 24px; background: var(--surface-2); text-align: center;">
                <div style="font-size: 48px; opacity: 0.5;">🎬</div>
                <div class="muted" style="margin-bottom: 16px;">Unable to embed this video.</div>
                <a href="{{ it.url }}" target="_blank" rel="noopener noreferrer" style="padding: 12px 20px; background: var(--primary); color: #fff; border-radius: var(--radius-sm); font-weight: 600; text-decoration: none; font-size: 0.9375rem;">
                  Open on YouTube
                </a>
              </div>
            </div>
          {% else %}
            <div style="padding: 32px 24px; background: var(--surface-2); border-radius: 16px; text-align: center; margin-top: 16px;">
              <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">⏳</div>
              <div style="font-size: 1.125rem; font-weight: 600; color: var(--text); margin-bottom: 8px;">Video Coming Soon</div>
              <div class="muted">This educational video will be available shortly.</div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div style="margin-top: 48px; padding: 48px 24px; background: var(--surface-2); border-radius: 16px; text-align: center; border: 2px dashed var(--border);">
        <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.5; color: var(--muted);">📭</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 12px;">No Videos Available</div>
        <div class="muted" style="max-width: 400px; margin: 0 auto;">
          This educational bundle is currently being prepared. Please check back soon for video content.
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function () {
  function toEmbedSrc(videoId) {
    const params = new URLSearchParams({
      rel: "0",
      modestbranding: "1",
      iv_load_policy: "3",
      playsinline: "1",
      disablekb: "1",
      controls: "1",
      fs: "1",
      origin: window.location.origin
    });
    return "https://www.youtube-nocookie.com/embed/" + videoId + "?" + params.toString();
  }

  document.querySelectorAll(".yt-player").forEach(function (iframe) {
    const rawUrl = iframe.dataset.youtubeUrl || "";
    const fallback = iframe.nextElementSibling;

    const match = rawUrl.match(
      /(?:youtube\.com\/watch\?v=|youtube\.com\/embed\/|youtube-nocookie\.com\/embed\/|youtu\.be\/)([A-Za-z0-9_-]{11})/
    );

    if (!match) {
      iframe.style.display = "none";
      if (fallback) fallback.style.display = "flex";
      return;
    }

    iframe.src = toEmbedSrc(match[1]);

    iframe.addEventListener("error", () => {
      iframe.style.display = "none";
      if (fallback) fallback.style.display = "flex";
    });
  });

  document.getElementById("lang").addEventListener("change", function () {
    const url = new URL(window.location.href);
    url.searchParams.set("lang", this.value);
    window.location.href = url.toString();
  });
})();
</script>
{% endblock %}

================================================================================
FILE: templates/sharing/patient_video.html
================================================================================

{% extends "base.html" %}
{% block title %}{{ clinic.display_name }} — Video{% endblock %}
{% block header_title %}{{ clinic.display_name }}{% endblock %}

{% block content %}
<div class="card">
  <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap; padding-bottom: 24px; border-bottom: 1px solid var(--border);">
    <div style="width: 80px; height: 80px; border-radius: 20px; border: 2px solid var(--border); background: linear-gradient(135deg, var(--primary), #3b82f6); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; position: relative; overflow: hidden; flex-shrink: 0;">
      <div style="line-height: 1;">{{ doctor.user.full_name|default:"D"|slice:":1"|upper }}</div>
      {% if doctor.photo %}
        <img src="{{ doctor.photo.url }}"
             alt="Doctor photo"
             loading="lazy"
             onerror="this.remove();"
             style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" />
      {% endif %}
    </div>

    <div style="flex: 1; min-width: 0;">
      <div style="font-size: 1.5rem; font-weight: 800; color: var(--text); margin-bottom: 4px;">Dr. {{ doctor.user.full_name }}</div>
      <div class="muted" style="font-size: 0.9375rem; margin-bottom: 8px;">{{ clinic.display_name }}</div>
      <div class="muted" style="font-size: 0.875rem; margin-bottom: 4px;">{{ clinic.state }}{% if clinic.postal_code %} — {{ clinic.postal_code }}{% endif %}</div>

      <div class="muted" style="margin-top: 12px; font-size: 0.875rem; line-height: 1.5;">
        {{ clinic.address_text|linebreaksbr }}
      </div>

      <div class="muted" style="margin-top: 8px; font-size: 0.875rem;">
        <div style="display: inline-flex; align-items: center; gap: 6px;">
          <span style="font-size: 1rem;">📞</span>
          <span>Clinic phone: {{ clinic.clinic_phone }}</span>
        </div>
        {% if clinic.clinic_whatsapp_number %}
          <div style="display: inline-flex; align-items: center; gap: 6px; margin-left: 16px;">
            <span style="font-size: 1rem;">💬</span>
            <span>WhatsApp: {{ clinic.clinic_whatsapp_number }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div style="margin-top: 24px; margin-bottom: 24px;">
    <div class="row" style="max-width: 300px;">
      <div>
        <label for="lang" style="font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">Language</label>
        <select id="lang" style="width: 100%; padding: 12px; border: 1.5px solid var(--border-strong); border-radius: var(--radius-sm); background: var(--surface); color: var(--text); font-size: 0.9375rem;">
          {% for code,name in languages %}
            <option value="{{ code }}" {% if code == selected_lang %}selected{% endif %}>
              {{ name }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div style="margin-top: 24px;">
    {% if vlang and vlang.youtube_url %}
      <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px; border: 1px solid var(--border); background: #000; box-shadow: var(--shadow-md);">
        <iframe id="yt-player"
                data-youtube-url="{{ vlang.youtube_url }}"
                referrerpolicy="strict-origin-when-cross-origin"
                loading="lazy"
                style="position: absolute; top:0; left:0; width:100%; height:100%; border:0;"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>

        <div id="yt-fallback"
             style="display:none; position: absolute; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; flex-direction: column; gap: 16px; padding: 24px; background: var(--surface-2); text-align: center;">
          <div style="font-size: 48px; opacity: 0.5;">🎬</div>
          <div class="muted" style="margin-bottom: 16px;">Unable to embed this video.</div>
          <a id="yt-fallback-link" href="{{ vlang.youtube_url }}" target="_blank" rel="noopener noreferrer" style="padding: 12px 20px; background: var(--primary); color: #fff; border-radius: var(--radius-sm); font-weight: 600; text-decoration: none; font-size: 0.9375rem;">
            Open on YouTube
          </a>
        </div>
      </div>
    {% else %}
      <div style="padding: 48px 24px; background: var(--surface-2); border-radius: 16px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">⏳</div>
        <div style="font-size: 1.125rem; font-weight: 600; color: var(--text); margin-bottom: 8px;">Video Coming Soon</div>
        <div class="muted">This educational video will be available shortly.</div>
      </div>
    {% endif %}

    {% if vlang %}
      <div style="margin-top: 20px; padding: 20px; background: var(--surface); border-radius: var(--radius-sm); border-left: 4px solid var(--primary);">
        <div style="font-size: 1.25rem; font-weight: 700; color: var(--text); margin-bottom: 8px;">{{ vlang.title }}</div>
        <div class="muted" style="font-size: 0.875rem;">Educational content provided by {{ clinic.display_name }}</div>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function () {
  const iframe = document.getElementById("yt-player");
  const fallback = document.getElementById("yt-fallback");
  if (!iframe) return;

  const rawUrl = iframe.dataset.youtubeUrl || "";
  const match = rawUrl.match(
    /(?:youtube\.com\/watch\?v=|youtube\.com\/embed\/|youtube-nocookie\.com\/embed\/|youtu\.be\/)([A-Za-z0-9_-]{11})/
  );

  if (!match) {
    iframe.style.display = "none";
    if (fallback) fallback.style.display = "flex";
  } else {
    const videoId = match[1];

    // Reduce related suggestions / branding inside the embed as much as YouTube allows.
    const params = new URLSearchParams({
      rel: "0",
      modestbranding: "1",
      iv_load_policy: "3",
      playsinline: "1",
      disablekb: "1",
      controls: "1",
      fs: "1",
      origin: window.location.origin
    });

    iframe.src = "https://www.youtube-nocookie.com/embed/" + videoId + "?" + params.toString();

    iframe.addEventListener("error", () => {
      iframe.style.display = "none";
      if (fallback) fallback.style.display = "flex";
    });
  }

  document.getElementById("lang").addEventListener("change", function () {
    const url = new URL(window.location.href);
    url.searchParams.set("lang", this.value);
    window.location.href = url.toString();
  });
})();
</script>
{% endblock %}

================================================================================
FILE: templates/sharing/share.html
================================================================================

{% extends "base.html" %}
{% block title %}{{ doctor.clinic.display_name }} — Share Patient Education{% endblock %}
{% block header_title %}{{ doctor.clinic.display_name }}{% endblock %}

{% block head %}
<style>
  /* Enhanced sharing interface */
  .profile-row {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    padding: 20px 0;
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    object-fit: cover;
    border: 2px solid var(--border);
    background: var(--surface);
    box-shadow: var(--shadow-sm);
  }

  .avatar {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    border: 2px solid var(--border);
    background: linear-gradient(135deg, var(--primary), #3b82f6);
    color: var(--primary-contrast);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 900;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    box-shadow: var(--shadow-md);
  }

  .avatar-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-letter {
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .profile-info {
    flex: 1;
    min-width: 250px;
  }

  .profile-name {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 4px;
    color: var(--text);
  }

  .profile-subtitle {
    color: var(--muted);
    margin-bottom: 8px;
    font-size: 0.9375rem;
  }

  .kv-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .kv-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .kv-label {
    font-weight: 600;
    color: var(--text);
    min-width: 140px;
    font-size: 0.875rem;
  }

  .kv-value {
    color: var(--muted);
    flex: 1;
    font-size: 0.9375rem;
  }

  .section-title {
    font-size: 1.25rem;
    margin: 0 0 20px 0;
    color: var(--text);
    position: relative;
    padding-bottom: 12px;
  }

  .section-title:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), transparent);
    border-radius: 3px;
  }

  /* Filter Controls */
  .filter-grid {
    display: grid;
    gap: 20px;
    margin: 24px 0;
  }

  @media (min-width: 768px) {
    .filter-grid.three-col {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 767px) {
    .filter-grid.three-col {
      grid-template-columns: 1fr;
    }
  }

  .search-wrapper {
    position: relative;
    margin: 16px 0;
  }

  .search-wrapper input {
    padding-left: 44px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 20px;
  }

  .toolbar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    align-items: end;
    margin: 24px 0;
  }

  @media (max-width: 640px) {
    .toolbar {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .toolbar .grow {
      min-width: 100%;
    }
  }

  /* Video List */
  .video-list-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin: 20px 0;
    max-height: 400px;
    box-shadow: var(--shadow-sm);
  }

  .video-list {
    overflow-y: auto;
    max-height: 360px;
  }

  .video-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .video-item:last-child {
    border-bottom: none;
  }

  .video-item:hover {
    background: var(--surface-2);
    transform: translateX(4px);
  }

  .video-item.active {
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.1), transparent);
    border-left: 4px solid var(--primary);
    border-right: 1px solid var(--border);
  }

  .video-title {
    font-weight: 600;
    color: var(--text);
    flex: 1;
    font-size: 0.9375rem;
  }

  .video-icon {
    width: 32px;
    height: 32px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    flex-shrink: 0;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Share Actions */
  .share-section {
    background: var(--surface-2);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin: 32px 0;
    border: 1px solid var(--border);
  }

  .input-group {
    position: relative;
    margin-bottom: 16px;
  }

  .input-group input {
    padding-left: 48px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 20px;
  }

  .hint {
    color: var(--muted);
    font-size: 0.8125rem;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .hint:before {
    content: 'ℹ️';
    font-size: 0.75rem;
  }

  .context-hint {
    background: linear-gradient(90deg, var(--surface-2), transparent);
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    margin: 16px 0;
    border-left: 4px solid var(--primary);
    font-size: 0.875rem;
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
  }

  @media (max-width: 480px) {
    .actions-grid {
      grid-template-columns: 1fr;
    }
  }

  .action-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .action-card:hover {
    border-color: var(--primary);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .action-card.active {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), transparent);
  }

  .action-icon {
    font-size: 32px;
    margin-bottom: 12px;
    color: var(--primary);
  }

  .action-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
  }

  .action-description {
    color: var(--muted);
    font-size: 0.8125rem;
    line-height: 1.4;
  }

  .prominent-footer {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    text-align: center;
  }

  /* Mobile Optimizations */
  @media (max-width: 640px) {
    .profile-row {
      flex-direction: column;
      text-align: center;
      gap: 16px;
    }

    .avatar {
      width: 80px;
      height: 80px;
      font-size: 28px;
    }

    .kv-item {
      flex-direction: column;
      gap: 4px;
      text-align: center;
    }

    .kv-label {
      min-width: auto;
      font-size: 0.8125rem;
    }

    .section-title {
      font-size: 1.125rem;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-2: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --border: #475569;
    }

    .card,
    .video-list-container,
    .share-section {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
  }

  /* --- Bundle-grouped results --- */
  .bundle-group {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--surface);
    margin-bottom: 14px;
  }

  .bundle-group.active {
    border-color: var(--primary);
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
  }

  .bundle-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 14px;
    background: var(--surface-2);
  }

  .bundle-title {
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }

  .bundle-meta {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 4px;
  }

  .bundle-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .bundle-actions .btn {
    padding: 8px 12px;
    font-size: 0.85rem;
  }

  .bundle-videos {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .video-item.child {
    padding: 10px 12px;
  }

  .video-item.child .video-icon {
    width: 32px;
    height: 32px;
    font-size: 0.9rem;
  }

  /* NEW: per-video action button in grouped view */
  .video-actions {
    margin-left: auto;
    flex-shrink: 0;
  }
  .video-actions .btn {
    padding: 8px 12px;
    font-size: 0.85rem;
    white-space: nowrap;
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h3 class="section-title">Doctor Profile</h3>

  <div class="profile-row">
    <div class="avatar" aria-label="Doctor photo">
      <div class="avatar-letter">{{ doctor.user.full_name|default:"D"|slice:":1"|upper }}</div>
      {% if doctor.photo %}
        <img class="avatar-img" src="{{ doctor.photo.url }}" alt="Doctor photo" loading="lazy" onerror="this.remove();" />
      {% endif %}
    </div>
    <div class="profile-info">
      <div class="profile-name">Dr. {{ doctor.user.full_name }}</div>
      <div class="profile-subtitle">{{ doctor.clinic.display_name }}</div>
      <div class="muted">Doctor ID: {{ doctor.doctor_id }}</div>
    </div>
  </div>

  <div class="kv-grid">
    <div class="kv-item">
      <div class="kv-label">Doctor WhatsApp</div>
      <div class="kv-value">{{ doctor.whatsapp_number }}</div>
    </div>
    <div class="kv-item">
      <div class="kv-label">IMC / Reg.</div>
      <div class="kv-value">{{ doctor.imc_number }}</div>
    </div>
    <div class="kv-item">
      <div class="kv-label">Clinic Phone</div>
      <div class="kv-value">{{ doctor.clinic.clinic_phone }}</div>
    </div>
    {% if doctor.clinic.clinic_whatsapp_number %}
    <div class="kv-item">
      <div class="kv-label">Clinic WhatsApp</div>
      <div class="kv-value">{{ doctor.clinic.clinic_whatsapp_number }}</div>
    </div>
    {% endif %}
  </div>

  <div class="muted" style="margin-top: 16px; padding: 16px; background: var(--surface-2); border-radius: var(--radius-sm);">
    <strong>Address:</strong><br>
    {{ doctor.clinic.address_text|linebreaksbr }}<br>
    {{ doctor.clinic.state }}{% if doctor.clinic.postal_code %} — {{ doctor.clinic.postal_code }}{% endif %}
  </div>
</div>

<div class="card">
  <h3 class="section-title">Share Patient Education</h3>

  <div class="filter-grid three-col">
    <div class="form-group">
      <label for="therapySel">Therapy Area</label>
      <select id="therapySel"></select>
    </div>

    <div class="form-group">
      <label for="triggerSel">Trigger</label>
      <select id="triggerSel"></select>
    </div>

    <div class="form-group">
      <label for="bundleSel">Bundle</label>
      <select id="bundleSel"></select>
    </div>
  </div>

  <div class="toolbar">
    <div class="grow">
      <label for="searchBox">Search Bundles / Videos</label>
      <div class="search-wrapper">
        <input id="searchBox" type="text" placeholder="Search by title, keyword, trigger, bundle name…" autocomplete="off" />
      </div>
    </div>

    <div style="min-width: 220px;">
      <label for="lang">Language</label>
      <select id="lang">
        {% for code, name in languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="contextHint" class="context-hint"></div>

  <div class="video-list-container">
    <div id="videoList" class="video-list"></div>
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">📹</div>
      <p>No bundles/videos found for the current filters.</p>
      <p class="muted">Try adjusting your search or filters</p>
    </div>
  </div>

  <div class="share-section">
    <h4 style="margin-bottom: 20px; color: var(--text);">Share with Patient</h4>

    <div class="input-group">
      <label for="waNumber">Patient WhatsApp Number</label>
      <input id="waNumber" type="tel" maxlength="10" placeholder="Enter 10-digit WhatsApp number" inputmode="numeric" />
      <div class="hint">Enter the patient's 10-digit WhatsApp number (India).</div>
    </div>

    <div class="actions-grid">
      <div class="action-card" id="videoCard" style="display: none;">
        <div class="action-icon">🎬</div>
        <div class="action-title">Share Single Video</div>
        <div class="action-description">Share only the selected video</div>
        <button class="btn" id="shareVideoBtn" style="margin-top: 12px; width: 100%;">Share Video</button>
      </div>

      <div class="action-card" id="bundleCard" style="display: none;">
        <div class="action-icon">📦</div>
        <div class="action-title">Share Complete Bundle</div>
        <div class="action-description">Share all videos in this bundle</div>
        <button class="btn" id="shareBundleBtn" style="margin-top: 12px; width: 100%;">Share Bundle</button>
      </div>
    </div>

    <div class="hint" style="margin-top: 20px; text-align: center;">
      <strong>Tip:</strong> Select a bundle to list its videos. Click a video to share only that video.
    </div>
  </div>

  <div class="prominent-footer">
    <a class="btn btn-secondary" href="{% url 'accounts:modify_clinic_details' doctor_id=doctor.doctor_id %}" style="width: 100%; max-width: 300px;">
      Modify Clinic Details
    </a>
  </div>
</div>

{{ catalog_json|json_script:"catalog-json" }}

<script>
const catalog = JSON.parse(document.getElementById("catalog-json").textContent);

const therapySel = document.getElementById("therapySel");
const triggerSel = document.getElementById("triggerSel");
const bundleSel = document.getElementById("bundleSel");
const searchBox = document.getElementById("searchBox");
const langSel = document.getElementById("lang");

const videoList = document.getElementById("videoList");
const contextHint = document.getElementById("contextHint");
const emptyState = document.getElementById("emptyState");

const waNumber = document.getElementById("waNumber");
const shareVideoBtn = document.getElementById("shareVideoBtn");
const shareBundleBtn = document.getElementById("shareBundleBtn");
const videoCard = document.getElementById("videoCard");
const bundleCard = document.getElementById("bundleCard");

let activeVideo = null;

// -------------------- helpers --------------------
function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function validWA() {
  return /^\d{10}$/.test((waNumber.value || "").trim());
}

const triggerByCode = {};
(catalog.triggers || []).forEach(t => { triggerByCode[t.code] = t; });

const bundleByCode = {};
(catalog.bundles || []).forEach(b => { bundleByCode[b.code] = b; });

const videoByCode = {};
(catalog.videos || []).forEach(v => { videoByCode[v.id] = v; });

const therapyByCode = {};
(catalog.therapy_areas || []).forEach(t => { therapyByCode[t.code] = t; });

function therapyLabel(code) {
  const t = therapyByCode[code];
  return (t && (t.display_name || t.code)) ? (t.display_name || t.code).trim() : (code || "");
}

function safeLower(s) {
  return String(s || "").toLowerCase();
}

function bundleLabel(b, lang) {
  if (!b) return "";
  const names = b.names || {};
  return (names[lang] || names["en"] || b.display_name || b.code || "").trim();
}

function bundleLabelByCode(code, lang) {
  return bundleLabel(bundleByCode[code], lang) || code;
}

function triggerLabelByCode(code) {
  const t = triggerByCode[code];
  return (t && (t.display_name || t.code)) ? (t.display_name || t.code).trim() : (code || "");
}

function videoTitle(v, lang) {
  if (!v) return "";
  const titles = v.titles || {};
  return (titles[lang] || titles["en"] || v.display_name || v.id || "").trim();
}

function populateSelect(el, items, labelFn, opts={}) {
  const includeAll = opts.includeAll !== false;  // default true
  const allLabel = opts.allLabel || "-- All --";
  const preserve = !!opts.preserve;
  const current = preserve ? (el.value || "") : "";

  el.innerHTML = "";

  if (includeAll) {
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = allLabel;
    el.appendChild(allOpt);
  }

  (items || []).forEach(i => {
    const o = document.createElement("option");
    o.value = i.code;
    o.textContent = (labelFn(i) || i.code || "").trim();
    el.appendChild(o);
  });

  if (preserve && current) {
    el.value = current;
  }
}

function getSelectedTherapy() {
  return (therapySel.value || "").trim();
}

function getSelectedTrigger() {
  return (triggerSel.value || "").trim();
}

function getSelectedBundle() {
  return (bundleSel.value || "").trim();
}

function repopulateTriggers({preserve=false}={}) {
  const therapy = getSelectedTherapy();
  const triggers = (catalog.triggers || []).filter(t => {
    if (!therapy) return true;
    return (t.therapy_code || "") === therapy;
  });

  // Alphabetical by label (display_name)
  triggers.sort((a, b) => String(a.display_name || a.code || "").localeCompare(String(b.display_name || b.code || "")));

  populateSelect(triggerSel, triggers, t => t.display_name || t.code, {preserve, includeAll: true, allLabel: "-- All Triggers --"});
}

function repopulateBundles({preserve=false}={}) {
  const lang = langSel.value;
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();

  const bundles = (catalog.bundles || []).filter(b => {
    if (therapy && (b.therapy_code || "") !== therapy) return false;
    if (trigger && (b.trigger_code || "") !== trigger) return false;
    return true;
  });

  // Alphabetical by localized label
  bundles.sort((a, b) => bundleLabel(a, lang).localeCompare(bundleLabel(b, lang)));

  populateSelect(bundleSel, bundles, b => bundleLabel(b, lang), {preserve, includeAll: true, allLabel: "-- All Bundles --"});
}

function clearVideoSelection() {
  activeVideo = null;
}

function currentFilteredVideos() {
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  const bundle = getSelectedBundle();

  // If bundle selected: show all videos in that bundle
  if (bundle) {
    const b = bundleByCode[bundle];
    const codes = (b && Array.isArray(b.video_codes)) ? b.video_codes : [];
    const vids = codes.map(c => videoByCode[c]).filter(Boolean);
    return vids;
  }

  // Else filter by therapy/trigger using derived codes on videos
  return (catalog.videos || []).filter(v => {
    if (therapy && (!Array.isArray(v.therapy_codes) || !v.therapy_codes.includes(therapy))) return false;
    if (trigger && (!Array.isArray(v.trigger_codes) || !v.trigger_codes.includes(trigger))) return false;
    return true;
  });
}

function renderVideoFlat() {
  const lang = langSel.value;
  const vids = currentFilteredVideos();

  // Alphabetical by localized title
  vids.sort((a, b) => videoTitle(a, lang).localeCompare(videoTitle(b, lang)));

  // If the selected video is no longer in the list, clear it
  if (activeVideo && !vids.some(v => v.id === activeVideo.id)) {
    activeVideo = null;
  }

  videoList.innerHTML = "";

  if (!vids.length) {
    videoList.style.display = "none";
    emptyState.style.display = "block";
    return;
  }

  videoList.style.display = "block";
  emptyState.style.display = "none";

  vids.forEach(v => {
    const d = document.createElement("div");
    d.className = "video-item" + (activeVideo && activeVideo.id === v.id ? " active" : "");

    const title = videoTitle(v, lang) || v.id;

    d.innerHTML = `
      <div class="video-icon">▶️</div>
      <div class="video-title">${escapeHtml(title)}</div>
      <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">
        ${(v.bundle_codes && v.bundle_codes.length) || 0} bundle(s)
      </div>
    `;

    d.onclick = () => {
      // Toggle selection
      if (activeVideo && activeVideo.id === v.id) {
        activeVideo = null;
      } else {
        activeVideo = v;
      }
      updateButtons();
      render();
    };

    videoList.appendChild(d);
  });
}

/*
  UPDATED: This function now also supports q = "" (no keyword),
  so it can be used for dropdown-driven selection (therapy/trigger/bundle).
*/
function renderBundleGroupedSearch(q) {
  const lang = langSel.value;
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  const selectedBundle = getSelectedBundle();

  const ql = safeLower(q).trim();
  const hasQuery = ql.length > 0;

  // Candidate bundles based on filters
  let candidates = (catalog.bundles || []).filter(b => {
    if (therapy && (b.therapy_code || "") !== therapy) return false;
    if (trigger && (b.trigger_code || "") !== trigger) return false;
    return true;
  });

  if (selectedBundle) {
    const b = bundleByCode[selectedBundle];
    candidates = b ? [b] : [];
  }

  const results = [];
  for (const b of candidates) {
    const vCodes = Array.isArray(b.video_codes) ? b.video_codes : [];
    const vidsAll = vCodes.map(c => videoByCode[c]).filter(Boolean);

    // If no query: show bundle with all videos (dropdown mode)
    if (!hasQuery) {
      if (vidsAll.length) {
        vidsAll.sort((a, bb) => videoTitle(a, lang).localeCompare(videoTitle(bb, lang)));
      }
      results.push({
        bundle: b,
        bundleMatches: true,
        videos: vidsAll,
        allVideoCount: vidsAll.length,
      });
      continue;
    }

    // With query: show bundles that match name OR contain matching videos
    const bSearch = safeLower(b.search_text || "") + " " + safeLower(bundleLabel(b, lang));
    const bundleMatches = bSearch.includes(ql);

    const vidsMatching = vidsAll.filter(v => safeLower(v.search_text || "").includes(ql));

    if (bundleMatches || vidsMatching.length) {
      const vidsToShow = bundleMatches ? vidsAll : vidsMatching;
      vidsToShow.sort((a, bb) => videoTitle(a, lang).localeCompare(videoTitle(bb, lang)));

      results.push({
        bundle: b,
        bundleMatches,
        videos: vidsToShow,
        allVideoCount: vidsAll.length,
      });
    }
  }

  results.sort((a, b) => bundleLabel(a.bundle, lang).localeCompare(bundleLabel(b.bundle, lang)));

  // Standalone videos only for query mode (prevents huge noise when q == "")
  const standalone = (!hasQuery) ? [] : (catalog.videos || []).filter(v => {
    const hasBundles = Array.isArray(v.bundle_codes) && v.bundle_codes.length;
    if (hasBundles) return false;
    return safeLower(v.search_text || "").includes(ql);
  });

  if (standalone.length) {
    standalone.sort((a, b) => videoTitle(a, lang).localeCompare(videoTitle(b, lang)));
  }

  // Validate activeVideo still present
  if (activeVideo) {
    const stillThereInBundles = results.some(r => r.videos.some(v => v.id === activeVideo.id));
    const stillThereStandalone = standalone.some(v => v.id === activeVideo.id);
    if (!stillThereInBundles && !stillThereStandalone) activeVideo = null;
  }

  videoList.innerHTML = "";

  if (!results.length && !standalone.length) {
    videoList.style.display = "none";
    emptyState.style.display = "block";
    return;
  }

  videoList.style.display = "block";
  emptyState.style.display = "none";

  // Helper to align filters to a specific bundle and optionally select a video
  function alignToBundle(b, bCode) {
    bundleSel.value = bCode;

    if (b.therapy_code) therapySel.value = b.therapy_code;
    repopulateTriggers({preserve: true});
    if (b.trigger_code) triggerSel.value = b.trigger_code;
    repopulateBundles({preserve: true});
    bundleSel.value = bCode;
  }

  results.forEach(r => {
    const b = r.bundle;
    const bCode = b.code;
    const bTitle = bundleLabel(b, lang) || bCode;

    const group = document.createElement("div");
    group.className = "bundle-group" + (!activeVideo && getSelectedBundle() === bCode ? " active" : "");

    const header = document.createElement("div");
    header.className = "bundle-header";
    header.innerHTML = `
      <div>
        <div class="bundle-title">${escapeHtml(bTitle)}</div>
        <div class="bundle-meta">
          Trigger: ${escapeHtml(triggerLabelByCode(b.trigger_code || ""))}${b.therapy_code ? " · Therapy: " + escapeHtml(therapyLabel(b.therapy_code)) : ""} · ${r.allVideoCount} video(s)
        </div>
      </div>
      <div class="bundle-actions">
        <button type="button" class="btn btn-secondary" data-action="select-bundle" data-bundle="${escapeHtml(bCode)}">Select bundle</button>
      </div>
    `;

    header.querySelector("button[data-action='select-bundle']").onclick = () => {
      clearVideoSelection();
      alignToBundle(b, bCode);
      updateButtons();
      render();
    };

    const body = document.createElement("div");
    body.className = "bundle-videos";

    r.videos.forEach(v => {
      const d = document.createElement("div");
      d.className = "video-item child" + (activeVideo && activeVideo.id === v.id ? " active" : "");
      const title = videoTitle(v, lang) || v.id;

      // UPDATED: add Select video button
      d.innerHTML = `
        <div class="video-icon">▶️</div>
        <div class="video-title">${escapeHtml(title)}</div>
        <div class="video-actions">
          <button type="button"
                  class="btn btn-secondary"
                  data-action="select-video"
                  data-bundle="${escapeHtml(bCode)}"
                  data-video="${escapeHtml(v.id)}">
            Select video
          </button>
        </div>
      `;

      // Clicking row also selects video (kept)
      d.onclick = (e) => {
        // If user clicked the button, let button handler run
        if (e && e.target && e.target.closest && e.target.closest("button[data-action='select-video']")) return;

        if (activeVideo && activeVideo.id === v.id) {
          activeVideo = null;
        } else {
          activeVideo = v;
          alignToBundle(b, bCode);
        }
        updateButtons();
        render();
      };

      // Button handler: always select video
      const btn = d.querySelector("button[data-action='select-video']");
      btn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();

        activeVideo = v;
        alignToBundle(b, bCode);

        updateButtons();
        render();
      };

      body.appendChild(d);
    });

    group.appendChild(header);
    group.appendChild(body);
    videoList.appendChild(group);
  });

  if (standalone.length) {
    const group = document.createElement("div");
    group.className = "bundle-group";

    const header = document.createElement("div");
    header.className = "bundle-header";
    header.innerHTML = `
      <div>
        <div class="bundle-title">Standalone Videos</div>
        <div class="bundle-meta">These videos are not currently part of any bundle/cluster.</div>
      </div>
    `;
    group.appendChild(header);

    const body = document.createElement("div");
    body.className = "bundle-videos";

    standalone.forEach(v => {
      const d = document.createElement("div");
      d.className = "video-item child" + (activeVideo && activeVideo.id === v.id ? " active" : "");
      const title = videoTitle(v, lang) || v.id;
      d.innerHTML = `
        <div class="video-icon">▶️</div>
        <div class="video-title">${escapeHtml(title)}</div>
        <div class="video-actions">
          <button type="button" class="btn btn-secondary">Select video</button>
        </div>
      `;

      d.onclick = (e) => {
        if (e && e.target && e.target.closest && e.target.closest("button")) return;
        if (activeVideo && activeVideo.id === v.id) activeVideo = null;
        else activeVideo = v;
        bundleSel.value = "";
        updateButtons();
        render();
      };

      d.querySelector("button").onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        activeVideo = v;
        bundleSel.value = "";
        updateButtons();
        render();
      };

      body.appendChild(d);
    });

    group.appendChild(body);
    videoList.appendChild(group);
  }
}

/*
  UPDATED: render mode:
  - If keyword exists OR any dropdown filter selected (therapy/trigger/bundle): show grouped bundle cards
  - Else: show flat video browsing (original behavior)
*/
function render() {
  const q = (searchBox.value || "").trim();
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  const bundle = getSelectedBundle();

  const hasDropdownFilters = !!(therapy || trigger || bundle);

  if (q || hasDropdownFilters) {
    renderBundleGroupedSearch(q);
  } else {
    renderVideoFlat();
  }
}

function updateContextHint() {
  const lang = langSel.value;
  const bundle = getSelectedBundle();

  if (activeVideo) {
    const t = videoTitle(activeVideo, lang) || activeVideo.id;
    contextHint.textContent = `Selected video: ${t}`;
    return;
  }

  if (bundle) {
    const b = bundleByCode[bundle];
    const bName = bundleLabelByCode(bundle, lang) || bundle;
    const count = (b && Array.isArray(b.video_codes)) ? b.video_codes.length : 0;
    contextHint.textContent = `Bundle selected: ${bName} (${count} video${count === 1 ? "" : "s"}).`;
    return;
  }

  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  if (therapy || trigger) {
    const parts = [];
    if (therapy) parts.push(`Therapy: ${therapyLabel(therapy)}`);
    if (trigger) parts.push(`Trigger: ${triggerLabelByCode(trigger) || trigger}`);
    contextHint.textContent = `Browsing by ${parts.join(" · ")}`;
    return;
  }

  contextHint.textContent = "Browse bundles/videos using filters above";
}

function updateButtons() {
  const waOk = validWA();
  const bundle = getSelectedBundle();

  if (activeVideo) {
    videoCard.style.display = "block";
    bundleCard.style.display = "none";
    shareVideoBtn.disabled = !waOk;
  } else if (bundle) {
    videoCard.style.display = "none";
    bundleCard.style.display = "block";
    shareBundleBtn.disabled = !waOk;
  } else {
    videoCard.style.display = "none";
    bundleCard.style.display = "none";
  }

  updateContextHint();
}

function buildMessage(title, link, lang) {
  const prefix = (catalog.message_prefixes && catalog.message_prefixes[lang]) || "";
  const p = (prefix || "").trim();
  const t = (title || "").trim();
  let msg = "";
  if (p) msg += p + "\n\n";
  if (t) msg += t + "\n";
  msg += link;
  return msg;
}

function shareToWhatsApp(message) {
  const num = (waNumber.value || "").trim();
  if (!/^\d{10}$/.test(num)) return;
  window.open(`https://wa.me/91${num}?text=${encodeURIComponent(message)}`);
}

// -------------------- actions --------------------
shareVideoBtn.onclick = () => {
  if (!activeVideo) return;
  const lang = langSel.value;
  const title = videoTitle(activeVideo, lang) || activeVideo.id;
  const link = `${location.origin}/p/${catalog.doctor_id}/v/${activeVideo.id}/?lang=${lang}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

shareBundleBtn.onclick = () => {
  const bundle = getSelectedBundle();
  if (!bundle) return;
  const lang = langSel.value;
  const title = bundleLabelByCode(bundle, lang) || bundle;
  const link = `${location.origin}/p/${catalog.doctor_id}/c/${bundle}/?lang=${lang}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

// -------------------- event wiring --------------------
therapySel.addEventListener("change", () => {
  clearVideoSelection();

  repopulateTriggers({preserve: false});
  triggerSel.value = "";
  repopulateBundles({preserve: false});
  bundleSel.value = "";

  render();
  updateButtons();
});

triggerSel.addEventListener("change", () => {
  clearVideoSelection();

  repopulateBundles({preserve: false});
  bundleSel.value = "";

  render();
  updateButtons();
});

bundleSel.addEventListener("change", () => {
  clearVideoSelection();

  const bcode = getSelectedBundle();
  if (bcode) {
    const b = bundleByCode[bcode];
    if (b) {
      if (b.therapy_code) therapySel.value = b.therapy_code;
      repopulateTriggers({preserve: true});
      if (b.trigger_code) triggerSel.value = b.trigger_code;
      repopulateBundles({preserve: true});
      bundleSel.value = bcode;
    }
  }

  render();
  updateButtons();
});

langSel.addEventListener("change", () => {
  repopulateBundles({preserve: true});
  render();
  updateButtons();
});

searchBox.addEventListener("input", () => {
  clearVideoSelection();
  render();
  updateButtons();
});

waNumber.addEventListener("input", () => {
  updateButtons();
});

// -------------------- init --------------------
const therapiesSorted = (catalog.therapy_areas || []).slice().sort((a, b) => String(a.display_name || a.code || "").localeCompare(String(b.display_name || b.code || "")));
populateSelect(therapySel, therapiesSorted, t => t.display_name || t.code, {includeAll: true, allLabel: "-- All Therapies --"});
repopulateTriggers({preserve: false});
repopulateBundles({preserve: false});

render();
updateButtons();
</script>
{% endblock %}

================================================================================
FILE: templates/accounts/register_success.html
================================================================================

{% extends "base.html" %}
{% block title %}Registration Complete{% endblock %}
{% block header_title %}Registration Complete{% endblock %}

{% block content %}
<div class="card">
  <h2>Registration complete</h2>

  <p><strong>Doctor ID:</strong> {{ doctor.doctor_id }}</p>
  <p><strong>Clinic link (doctor/staff sharing screen):</strong><br/>
     <a href="{{ clinic_link }}">{{ clinic_link }}</a>
  </p>
  <p class="muted">
    We have also emailed you this link, along with password setup instructions...
  </p>

  <hr style="margin: 18px 0;"/>

  <p>
    Next step: <a href="{% url 'accounts:login' %}">Login</a> (if you haven't set a password yet, click "Forgot password" on the login page and we'll send you a password setup link).
  </p>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/already_registered.html
================================================================================

{% extends "base.html" %}
{% block title %}Already Registered{% endblock %}
{% block header_title %}Already Registered{% endblock %}

{% block content %}
<div class="card">
  <p>{{ message }}</p>

  <div style="margin-top: 16px;">
    <a href="{{ login_url }}" style="display:inline-block; padding:10px 14px; border-radius:12px; background:#111827; color:#ffffff; text-decoration:none;">Go to Login</a>
  </div>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/password_reset_invalid.html
================================================================================

{% extends "base.html" %}
{% block title %}Invalid Link{% endblock %}
{% block header_title %}Invalid Link{% endblock %}

{% block content %}
<div class="card">
  <h2>Invalid or expired link</h2>
  <p class="muted">This password reset link is invalid or has expired.</p>
  <p><a href="{% url 'accounts:forgot' %}">Request a new password reset link</a></p>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/register.html
================================================================================

{% extends "base.html" %}
{% block title %}{% if mode == "modify" %}Modify Clinic Details{% else %}Doctor Registration{% endif %}{% endblock %}
{% block header_title %}{% if mode == "modify" %}Modify Clinic Details{% else %}Doctor Registration{% endif %}{% endblock %}

{% block content %}
<div class="card">
  {% if mode == "modify" %}
    <h2>Modify clinic details</h2>
    <p class="muted">Update your doctor/clinic details below. Changes take effect immediately.</p>
  {% else %}
    <h2>Register your clinic</h2>
    <p class="muted">After registration, you will receive your clinic's patient education link on this screen and by email.</p>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

{% for field in form %}
  {% if field.is_hidden %}
    {{ field }}
  {% else %}
    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
    {{ field }}
    {% if field.errors %}
      <div class="message error">{{ field.errors|striptags }}</div>
    {% endif %}
  {% endif %}
{% endfor %}


    <div style="margin-top: 16px;">
      {% if mode == "modify" %}
        <button type="submit">Save Changes</button>
      {% else %}
        <button type="submit">Register Doctor</button>
      {% endif %}
    </div>
  </form>

  {% if mode != "modify" %}
    <div style="margin-top: 16px;" class="muted">
      Already registered? <a href="{% url 'accounts:login' %}">Login here</a>
    </div>
  {% endif %}
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/password_reset.html
================================================================================

{% extends "base.html" %}
{% block title %}Set New Password{% endblock %}
{% block header_title %}Set New Password{% endblock %}

{% block content %}
<div class="card">
  <h2>Choose a new password</h2>

  <form method="post">
    {% csrf_token %}

    {% for field in form %}
      <label for="{{ field.id_for_label }}">{{ field.label }}</label>
      {{ field }}
      {% if field.errors %}
        <div class="message error">{{ field.errors|striptags }}</div>
      {% endif %}
    {% endfor %}

    <div style="margin-top: 16px;">
      <button type="submit">Save password</button>
    </div>
  </form>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/pincode_invalid.html
================================================================================

{% extends "base.html" %}
{% block title %}Invalid PIN Code{% endblock %}
{% block header_title %}Invalid PIN Code{% endblock %}

{% block content %}
<div class="card">
  <p>The pincode does not exist in the Indian Pincode directory. Re-enter the pincode.</p>
  <p><a href="{{ return_url }}">Click here to return to the form</a></p>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/login.html
================================================================================

{% extends "base.html" %}
{% block title %}Doctor Login{% endblock %}
{% block header_title %}Doctor Login{% endblock %}

{% block content %}
<div class="card">
  <h2>Login</h2>
  <p class="muted">Use the same email address you used during doctor registration.</p>

  <form method="post">
    {% csrf_token %}
    {% for field in form %}
      <label for="{{ field.id_for_label }}">{{ field.label }}</label>
      {{ field }}
      {% if field.errors %}
        <div class="message error">{{ field.errors|striptags }}</div>
      {% endif %}
    {% endfor %}

    {% if form.non_field_errors %}
      <div class="message error">{{ form.non_field_errors|striptags }}</div>
    {% endif %}

    <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
      <button type="submit">Login</button>
      <a class="btn-secondary" style="padding: 10px 14px; border-radius: 10px; border: 1px solid #111827;" href="{% url 'accounts:request_password_reset' %}">Forgot password</a>
    </div>
  </form>

  <div style="margin-top: 16px;" class="muted">
    New clinic? <a href="{% url 'accounts:register' %}">Register here</a>
  </div>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/password_request.html
================================================================================

{% extends "base.html" %}
{% block title %}Forgot Password{% endblock %}
{% block header_title %}Forgot Password{% endblock %}

{% block content %}
<div class="card">
  <h2>Reset your password</h2>
  <p class="muted">Enter your registered email address. We will send you a password reset link.</p>

  <form method="post">
    {% csrf_token %}

    <label for="email">Email</label>
    <input id="email" name="email" type="email" required />

    <div style="margin-top: 16px;">
      <button type="submit">Send reset instructions</button>
    </div>
  </form>
</div>
{% endblock %}

================================================================================
FILE: templates/accounts/request_password_reset.html
================================================================================

{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}
{% block header_title %}Reset Password{% endblock %}

{% block content %}
<div class="card">
  <h2>Forgot your password?</h2>
  <p class="muted">
    Enter the email address you used during registration.
    We will send you a link to reset your password.
  </p>

  <form method="post">
    {% csrf_token %}

    <label for="id_email">Email address</label>
    <input
      type="email"
      name="email"
      id="id_email"
      required
      placeholder="you@example.com"
    >

    <div style="margin-top: 16px; display: flex; gap: 12px;">
      <button type="submit">Send reset link</button>
      <a class="btn-secondary"
         style="padding: 10px 14px; border-radius: 10px; border: 1px solid #111827;"
         href="{% url 'accounts:login' %}">
        Back to login
      </a>
    </div>
  </form>
</div>
{% endblock %}
