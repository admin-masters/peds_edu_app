{% extends "base.html" %}
{% block title %}Doctor Share{% endblock %}
{% block header_title %}Doctor Share{% endblock %}

{% block content %}
<div class="card">
  <h3>Doctor</h3>
  <p><b>{{ doctor.user.full_name }}</b></p>
  <p class="muted">Doctor ID: {{ doctor.doctor_id }}</p>
</div>

<div class="card">
  <h3>Share Patient Education</h3>

  <div class="row three">
    <div>
      <label>Therapy Area</label>
      <select id="therapySel"></select>
    </div>

    <div>
      <label>Topic</label>
      <select id="topicSel"></select>
    </div>

    <div>
      <label>Bundle</label>
      <select id="bundleSel"></select>
    </div>
  </div>

  <div class="row two" style="margin-top:12px;">
    <div>
      <label>Search videos</label>
      <input id="searchBox" type="text" placeholder="Search videosâ€¦">
    </div>

    <div>
      <label>Language</label>
      <select id="lang">
        {% for code, name in languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="videoList" style="margin-top:12px;"></div>

  <div class="sticky-share">
    <label>WhatsApp number</label>
    <input id="waNumber" type="tel" maxlength="10" placeholder="10-digit number">

    <button id="shareVideoBtn" disabled>Share Video</button>
    <button id="shareBundleBtn" disabled>Share Bundle</button>
  </div>
</div>

{{ catalog_json|json_script:"catalog-json" }}

<script>
const catalog = JSON.parse(document.getElementById("catalog-json").textContent);

const therapySel = document.getElementById("therapySel");
const topicSel = document.getElementById("topicSel");
const bundleSel = document.getElementById("bundleSel");
const videoList = document.getElementById("videoList");
const searchBox = document.getElementById("searchBox");
const langSel = document.getElementById("lang");
const waNumber = document.getElementById("waNumber");
const shareVideoBtn = document.getElementById("shareVideoBtn");
const shareBundleBtn = document.getElementById("shareBundleBtn");

let activeVideo = null;

function validWA() {
  return /^\d{10}$/.test(waNumber.value);
}

function populateSelect(el, items, labelFn) {
  el.innerHTML = `<option value="">-- All --</option>`;
  items.forEach(i => {
    const o = document.createElement("option");
    o.value = i.code;
    o.textContent = labelFn(i);
    el.appendChild(o);
  });
}

populateSelect(therapySel, catalog.therapy_areas, t => t.display_name);
populateSelect(topicSel, catalog.topics, t => t.display_name);
populateSelect(bundleSel, catalog.bundles, b => b.display_name);

function filteredVideos() {
  const q = searchBox.value.toLowerCase();
  return catalog.videos.filter(v => {
    if (bundleSel.value && !v.bundle_codes.includes(bundleSel.value)) return false;
    if (q && !v.search_text.includes(q)) return false;
    return true;
  });
}

function renderVideos() {
  const lang = langSel.value;
  const vids = filteredVideos();
  videoList.innerHTML = "";

  vids.forEach(v => {
    const d = document.createElement("div");
    d.className = "video-item" + (activeVideo === v ? " active" : "");
    d.innerHTML = `<b>${v.titles[lang] || v.titles.en}</b>`;
    d.onclick = () => {
      activeVideo = v;
      renderVideos();
      updateButtons();
    };
    videoList.appendChild(d);
  });
}

function updateButtons() {
  shareVideoBtn.disabled = !(activeVideo && validWA());
  shareBundleBtn.disabled = !(bundleSel.value && validWA());
}

function buildMessage(link, lang) {
  const prefix = catalog.message_prefixes[lang] || "";
  return prefix + link;
}

shareVideoBtn.onclick = () => {
  const lang = langSel.value;
  const link = `${location.origin}/p/${catalog.doctor_id}/v/${activeVideo.id}/?lang=${lang}`;
  window.open(`https://wa.me/91${waNumber.value}?text=${encodeURIComponent(buildMessage(link, lang))}`);
};

shareBundleBtn.onclick = () => {
  const lang = langSel.value;
  const link = `${location.origin}/p/${catalog.doctor_id}/c/${bundleSel.value}/?lang=${lang}`;
  window.open(`https://wa.me/91${waNumber.value}?text=${encodeURIComponent(buildMessage(link, lang))}`);
};

[therapySel, topicSel, bundleSel, searchBox, langSel, waNumber]
  .forEach(el => el.addEventListener("change", () => {
    activeVideo = null;
    renderVideos();
    updateButtons();
  }));

renderVideos();
</script>
{% endblock %}
