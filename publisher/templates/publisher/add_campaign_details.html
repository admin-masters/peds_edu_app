{% extends "base.html" %}
{% block content %}
<style>
  .card { max-width: 980px; margin: 20px auto; padding: 16px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.08); }
  .row { display: grid; gap: 12px; }
  .row.two { grid-template-columns: 1fr 1fr; }
  @media (max-width: 760px) { .row.two { grid-template-columns: 1fr; } }
  label { font-weight: 600; display: block; margin-bottom: 6px; }
  input[type="text"], input[type="date"], textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.12); }
  .muted { color: rgba(0,0,0,0.6); font-size: 0.95rem; }
  .errorlist { margin: 6px 0 0; color: #b00020; }
  .btn { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
  .btn.primary { background: #111; color: #fff; }
  .catalog { margin-top: 16px; border-top: 1px solid rgba(0,0,0,0.08); padding-top: 16px; }
  .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  @media (max-width: 960px) { .grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }
  .item { border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; padding: 10px; }
  .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; background: rgba(0,0,0,0.06); font-size: 12px; }
  .thumb { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; background: rgba(0,0,0,0.04); }
</style>

<div class="card">
  <h2>Add Campaign Details</h2>

  <p><strong>Campaign ID:</strong> {{ campaign_id }}</p>

  <div class="muted" style="margin: 12px 0;">
    <strong>Master-managed campaign fields (read-only):</strong>

    <div style="margin-top: 6px;">
      <strong>Doctors supported:</strong> {{ readonly.doctors_supported|default_if_none:"—" }}
    </div>

    <div style="margin-top: 6px;">
      <strong>Banner target URL:</strong>
      {% if readonly.banner_target_url %}
        <a href="{{ readonly.banner_target_url }}" target="_blank" rel="noopener">{{ readonly.banner_target_url }}</a>
      {% else %}
        —
      {% endif %}
    </div>

    <div style="margin-top: 10px;">
      <strong>Campaign banners:</strong>
      {% if readonly.banner_large_url or readonly.banner_small_url %}
        <div style="margin-top: 6px;">
          {% if readonly.banner_target_url %}<a href="{{ readonly.banner_target_url }}" target="_blank" rel="noopener">{% endif %}
            <picture>
              {% if readonly.banner_small_url %}<source media="(max-width: 640px)" srcset="{{ readonly.banner_small_url }}" />{% endif %}
              <img src="{{ readonly.banner_large_url|default:readonly.banner_small_url }}" alt="Campaign banner"
                   style="max-width: 100%; height: auto; border: 1px solid rgba(0,0,0,0.08); border-radius: 10px;" />
            </picture>
          {% if readonly.banner_target_url %}</a>{% endif %}
        </div>
      {% else %}
        <div class="muted" style="margin-top: 6px;">No banner URLs found in MASTER DB for this campaign.</div>
      {% endif %}
    </div>
  </div>

  <form method="post">
    {% csrf_token %}
    {{ form.campaign_id }}
    {{ form.selected_items_json }}

    <div class="row two">
      <div>
        <label for="{{ form.new_video_cluster_name.id_for_label }}">New Video-cluster Name</label>
        {{ form.new_video_cluster_name }}
        {{ form.new_video_cluster_name.errors }}
      </div>
    </div>

    <div class="catalog">
      <h3>Choose Videos / Video-clusters</h3>
      <p class="muted">Select individual videos or entire clusters. Your selection will be used to create a new cluster for this campaign.</p>

      <div class="row two" style="margin-bottom: 8px;">
        <div>
          <label>Search</label>
          <input id="searchBox" type="text" placeholder="Search videos or clusters..." />
        </div>
        <div>
          <label>Filter</label>
          <select id="filterType" style="width:100%; padding:10px; border-radius:10px; border: 1px solid rgba(0,0,0,0.12);">
            <option value="all">All</option>
            <option value="video">Videos</option>
            <option value="cluster">Clusters</option>
          </select>
        </div>
      </div>

      <div id="catalogGrid" class="grid"></div>

      <div style="margin-top: 12px;">
        <strong>Selected:</strong> <span id="selectedCount">0</span>
        <div class="muted">Selection errors will appear under the form on save.</div>
        {{ form.selected_items_json.errors }}
      </div>
    </div>

    <hr style="margin: 18px 0; border:0; border-top: 1px solid rgba(0,0,0,0.08);" />

    <div class="row two">
      <div>
        <label for="{{ form.email_registration.id_for_label }}">Email message for registering a new doctor</label>
        {{ form.email_registration }}
        {{ form.email_registration.errors }}
      </div>
      <div>
        <label for="{{ form.wa_addition.id_for_label }}">WhatsApp message for adding an already registered doctor</label>
        {{ form.wa_addition }}
        {{ form.wa_addition.errors }}
      </div>
    </div>

    <div class="row two" style="margin-top: 14px;">
      <div>
        <label for="{{ form.start_date.id_for_label }}">Start Date</label>
        {{ form.start_date }}
        {{ form.start_date.errors }}
      </div>
      <div>
        <label for="{{ form.end_date.id_for_label }}">End Date</label>
        {{ form.end_date }}
        {{ form.end_date.errors }}
      </div>
    </div>

    <div style="margin-top: 16px;">
      <button class="btn primary" type="submit">Save</button>
      <a class="btn" href="{% url 'campaign_publisher:campaign_list' %}" style="text-decoration:none;">Cancel</a>
    </div>

    {% if form.non_field_errors %}
      <div style="margin-top: 12px;">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
  </form>
</div>

<script>
/*
  Catalog loading uses the existing endpoints in your codebase.
  The JS below is unchanged from your current template (except it no longer deals with banner uploads).
*/
(function() {
  const catalogGrid = document.getElementById("catalogGrid");
  const searchBox = document.getElementById("searchBox");
  const filterType = document.getElementById("filterType");
  const selectedCount = document.getElementById("selectedCount");
  const selectedItemsInput = document.getElementById("id_selected_items_json");

  let videos = [];
  let clusters = [];
  let selected = [];

  function render() {
    const q = (searchBox.value || "").toLowerCase();
    const f = filterType.value;

    const items = [];
    if (f === "all" || f === "video") {
      videos.forEach(v => items.push({ type: "video", id: v.id, name: v.title || ("Video #" + v.id), thumb: v.thumbnail_url || "" }));
    }
    if (f === "all" || f === "cluster") {
      clusters.forEach(c => items.push({ type: "cluster", id: c.id, name: c.name || ("Cluster #" + c.id), thumb: "" }));
    }

    const filtered = items.filter(it => !q || (it.name || "").toLowerCase().includes(q));
    catalogGrid.innerHTML = "";

    filtered.forEach(it => {
      const isSel = selected.some(s => s.type === it.type && s.id === it.id);

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <div>
            <span class="pill">${it.type}</span>
            <div style="font-weight:700; margin-top:6px;">${escapeHtml(it.name)}</div>
          </div>
          <div>
            <input type="checkbox" ${isSel ? "checked" : ""} />
          </div>
        </div>
        ${it.thumb ? `<img class="thumb" src="${it.thumb}" alt="" style="margin-top:10px;" />` : `<div class="thumb" style="margin-top:10px; display:flex; align-items:center; justify-content:center;"><span class="muted">No preview</span></div>`}
      `;

      el.querySelector("input").addEventListener("change", (e) => {
        if (e.target.checked) {
          if (!isSel) selected.push({ type: it.type, id: it.id });
        } else {
          selected = selected.filter(s => !(s.type === it.type && s.id === it.id));
        }
        syncSelected();
        render();
      });

      catalogGrid.appendChild(el);
    });
  }

  function syncSelected() {
    selectedItemsInput.value = JSON.stringify(selected);
    selectedCount.textContent = String(selected.length);
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, function(m) {
      return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" })[m];
    });
  }

  async function loadCatalog() {
    try {
      const vResp = await fetch("{% url 'campaign_publisher:api_video_list' %}");
      const cResp = await fetch("{% url 'campaign_publisher:api_cluster_list' %}");
      videos = (await vResp.json()) || [];
      clusters = (await cResp.json()) || [];
    } catch (e) {
      console.error("Failed to load catalog", e);
    }
    // restore selection if present
    try { selected = JSON.parse(selectedItemsInput.value || "[]") || []; } catch (e) { selected = []; }
    syncSelected();
    render();
  }

  searchBox.addEventListener("input", render);
  filterType.addEventListener("change", render);

  loadCatalog();
})();
</script>
{% endblock %}
